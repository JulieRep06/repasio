<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, viewport-fit=cover">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#2D6A63">
    <title>Repasio — Planificateur de repas familial intelligent | Menus, budget & courses</title>
    <meta name="description" content="Repasio organise vos repas en famille : planning hebdomadaire intelligent, gestion du stock et des péremptions, liste de courses automatique et budget maîtrisé. Gratuit 14 jours.">
    <meta name="keywords" content="planificateur repas, planning repas famille, menu semaine, liste de courses, gestion stock alimentaire, budget courses, batch cooking, meal planner, anti-gaspillage">
    <meta name="author" content="Repasio">
    <meta name="robots" content="index, follow">
    <link rel="canonical" href="https://www.repasio.fr/">

    <!-- Security headers via meta -->
    <meta http-equiv="X-Frame-Options" content="DENY">
    <meta http-equiv="X-Content-Type-Options" content="nosniff">
    <meta name="referrer" content="strict-origin-when-cross-origin">
    <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline' 'unsafe-eval' https://cdn.jsdelivr.net https://cdnjs.cloudflare.com; style-src 'self' 'unsafe-inline' https://fonts.googleapis.com; font-src https://fonts.gstatic.com; connect-src 'self' https://wwovyniqwhmwbnrhabrs.supabase.co; img-src 'self' data: https://images.unsplash.com;">

    <!-- Open Graph (Facebook, LinkedIn) -->
    <meta property="og:type" content="website">
    <meta property="og:title" content="Repasio — Planificateur de repas familial intelligent">
    <meta property="og:description" content="Planifiez vos repas en famille, gérez votre stock, générez vos listes de courses et maîtrisez votre budget alimentaire.">
    <meta property="og:url" content="https://www.repasio.fr/">
    <meta property="og:site_name" content="Repasio">
    <meta property="og:locale" content="fr_FR">
    <meta property="og:image" content="https://www.repasio.fr/og-image.png">
    <meta property="og:image:width" content="1200">
    <meta property="og:image:height" content="630">

    <!-- Twitter Card -->
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="Repasio — Planificateur de repas familial intelligent">
    <meta name="twitter:description" content="Planifiez vos repas, gérez votre stock, générez vos listes de courses. Gratuit 14 jours.">
    <meta name="twitter:image" content="https://www.repasio.fr/og-image.png">

    <!-- Structured Data (Schema.org) -->
    <script type="application/ld+json">
    {
        "@context": "https://schema.org",
        "@type": "WebApplication",
        "name": "Repasio",
        "url": "https://www.repasio.fr",
        "description": "Planificateur de repas familial intelligent avec gestion du stock, budget et liste de courses automatique.",
        "applicationCategory": "LifestyleApplication",
        "operatingSystem": "Web",
        "offers": {
            "@type": "Offer",
            "price": "0",
            "priceCurrency": "EUR",
            "description": "Essai gratuit 14 jours"
        },
        "author": {
            "@type": "Organization",
            "name": "Repasio"
        },
        "inLanguage": "fr",
        "aggregateRating": {
            "@type": "AggregateRating",
            "ratingValue": "4.8",
            "ratingCount": "120"
        }
    }
    </script>
    
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Lexend:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        :root {
            /* Palette Repasio */
            --teal: #2D6A63;
            --teal-dark: #235550;
            --teal-light: #3A8A82;
            --gold: #D9A054;
            --gold-dark: #C08A3A;
            --gold-light: #F0DCC0;
            --mist: #F4F7F6;
            --charcoal: #333333;
            --white: #FFFFFF;
            
            --meal-pdej-bg: #FFF6E6; --meal-pdej-border: #F0DFBD;
            --meal-dej-bg: #E6F2F0; --meal-dej-border: #C2DDD9;
            --meal-gout-bg: #F4F0ED; --meal-gout-border: #E0D6CF;
            --meal-din-bg: #E8EDF2; --meal-din-border: #CDD6E0;
            
            --radius-lg: 16px; --radius-md: 12px; --radius-sm: 8px;
            --shadow: 0 4px 6px rgba(0,0,0,0.06);
            --shadow-hover: 0 8px 15px rgba(0,0,0,0.12);
        }
        
        * { font-family: 'Lexend', sans-serif; box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; }
        body { background: var(--mist); color: var(--charcoal); min-height: 100vh; min-height: 100dvh; padding-top: env(safe-area-inset-top); }
        
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes pulse { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.2); } }
        @keyframes bounce { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-6px); } }
        @keyframes spin { to { transform: rotate(360deg); } }
        .fade-in { animation: fadeIn 0.3s ease-out; }
        
        /* HEADER - plein écran */
        .header { background: var(--teal); padding: 0; box-shadow: 0 2px 10px rgba(0,0,0,0.15); position: sticky; top: 0; z-index: 500; }
        .header-inner { display: flex; align-items: center; justify-content: space-between; padding: 0.6rem 1.25rem; width: 100%; }
        .logo-img { width: 38px; height: 38px; border-radius: 8px; object-fit: cover; }
        
        /* NAVBAR - collée sous header, plein écran */
        .navbar {
            background: var(--charcoal); display: flex; justify-content: center; gap: 0.15rem;
            padding: 0.4rem 1rem; box-shadow: var(--shadow); width: 100%;
        }
        .nav-item {
            color: rgba(255,255,255,0.7); padding: 0.45rem 0.85rem; border-radius: var(--radius-sm);
            font-weight: 500; font-size: 0.75rem; cursor: pointer; transition: all 0.2s;
            display: flex; align-items: center; gap: 0.3rem; border: none; background: transparent;
            white-space: nowrap;
        }
        .nav-item:hover { background: rgba(255,255,255,0.08); color: white; }
        .nav-item.active { background: var(--teal); color: white; font-weight: 600; }
        
        .card { background: var(--white); border-radius: var(--radius-lg); box-shadow: var(--shadow); margin-bottom: 1rem; }
        .card-header { padding: 0.9rem 1.15rem; border-bottom: 1px solid #E8ECEA; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 0.6rem; }
        .card-body { padding: 1.15rem; }
        
        .btn {
            padding: 0.5rem 0.85rem; border-radius: var(--radius-sm); font-weight: 600; font-size: 0.75rem;
            cursor: pointer; transition: all 0.2s; border: none; display: inline-flex; align-items: center; gap: 0.3rem;
        }
        .btn-primary { background: var(--teal); color: white; }
        .btn-primary:hover { background: var(--teal-dark); transform: translateY(-1px); }
        .btn-gold { background: var(--gold); color: white; }
        .btn-gold:hover { background: var(--gold-dark); transform: translateY(-1px); }
        .btn-secondary { background: #EAEDEC; color: var(--charcoal); border: 1px solid #D5DAD8; }
        .btn-secondary:hover { background: #D5DAD8; }
        .btn-edit { background: var(--gold-light); color: var(--gold-dark); }
        .btn-delete { background: #FED7D7; color: #E53E3E; }
        .btn-generate { background: linear-gradient(135deg, var(--gold), var(--gold-dark)); color: white; font-size: 0.78rem; padding: 0.55rem 1rem; box-shadow: 0 2px 8px rgba(217,160,84,0.3); }
        .btn-generate:hover { transform: translateY(-1px); box-shadow: 0 4px 12px rgba(217,160,84,0.4); }
        .btn-sm { padding: 0.3rem 0.5rem; font-size: 0.68rem; }
        
        .input, .select, textarea {
            width: 100%; padding: 0.5rem 0.7rem; border: 1.5px solid #D5DAD8; border-radius: var(--radius-sm);
            font-size: 0.8rem; transition: all 0.2s; background: white; font-family: inherit;
        }
        .input:focus, .select:focus, textarea:focus { outline: none; border-color: var(--teal); box-shadow: 0 0 0 3px rgba(45,106,99,0.12); }
        textarea { resize: vertical; min-height: 100px; }
        .label { display: block; font-size: 0.72rem; font-weight: 600; color: #5A6B68; margin-bottom: 0.3rem; }
        
        .checkbox-label { display: flex; align-items: center; gap: 0.4rem; cursor: pointer; font-size: 0.78rem; padding: 0.3rem 0.5rem; border-radius: var(--radius-sm); transition: background 0.2s; }
        .checkbox-label:hover { background: #F0F3F2; }
        .checkbox { width: 1rem; height: 1rem; accent-color: var(--teal); }
        
        /* Planning Grid */
        .planning-grid { display: grid; grid-template-columns: 85px repeat(7, 1fr); gap: 3px; min-width: 780px; }
        .planning-header { background: var(--teal); color: white; padding: 0.45rem; border-radius: 6px; font-weight: 600; font-size: 0.72rem; text-align: center; }
        .planning-header.meal-col { background: var(--charcoal); }
        
        .meal-cell { border-radius: 10px; padding: 0.35rem; min-height: 78px; display: flex; flex-direction: column; font-size: 0.62rem; position: relative; }
        .meal-cell.pdej, .meal-cell.dej, .meal-cell.gout, .meal-cell.din { background: white; border: none; box-shadow: 0 1px 2px rgba(0,0,0,0.07), 0 4px 12px rgba(0,0,0,0.10), 0 8px 24px rgba(0,0,0,0.06); transition: box-shadow 0.2s, transform 0.2s; }
        .meal-cell:hover { box-shadow: 0 2px 4px rgba(0,0,0,0.08), 0 8px 20px rgba(0,0,0,0.14), 0 14px 36px rgba(0,0,0,0.08); transform: translateY(-2px); }
        
        .meal-type-cell { display: flex; align-items: center; gap: 0.25rem; font-weight: 600; font-size: 0.66rem; padding: 0.3rem; }
        
        .recipe-tag {
            background: white; border-radius: 4px; padding: 0.15rem 0.3rem; margin-bottom: 0.15rem;
            display: flex; justify-content: space-between; align-items: flex-start; font-size: 0.57rem;
            box-shadow: 0 1px 2px rgba(0,0,0,0.05); gap: 0.15rem;
        }
        .recipe-tag span { word-break: break-word; line-height: 1.2; }
        .recipe-tag button { background: none; border: none; cursor: pointer; opacity: 0.5; font-size: 0.6rem; padding: 0; }
        .recipe-tag button:hover { opacity: 1; }
        
        .slot-content { flex: 1; overflow-y: auto; max-height: 58px; }
        
        .edit-slot-btn {
            position: absolute; bottom: 2px; right: 2px;
            background: rgba(255,255,255,0.85); border: 1px solid rgba(0,0,0,0.08); border-radius: 4px;
            padding: 2px 5px; font-size: 0.58rem; cursor: pointer; opacity: 0; transition: opacity 0.15s; z-index: 2;
        }
        .meal-cell:hover .edit-slot-btn { opacity: 1; }
        .edit-slot-btn:hover { background: white; }
        
        .add-btn-mini {
            background: rgba(255,255,255,0.5); border: 1px dashed #B0BFB8; border-radius: 4px;
            padding: 0.2rem; font-size: 0.52rem; cursor: pointer; color: #5A6B68; margin-top: auto;
        }
        .add-btn-mini:hover { background: white; border-color: var(--teal); color: var(--teal); }
        
        .participants-mini { display: flex; flex-wrap: wrap; gap: 2px; margin-top: 0.15rem; padding-top: 0.15rem; border-top: 1px dashed rgba(0,0,0,0.08); }
        .p-badge-detail { display: inline-flex; align-items: center; gap: 2px; background: rgba(45,106,99,0.08); border-radius: 4px; padding: 1px 4px; cursor: default; }
        .p-initial { font-size: 0.52rem; font-weight: 700; color: var(--teal-dark); }
        .p-kcal { font-size: 0.42rem; color: #D9A054; font-weight: 600; }
        .p-cost { font-size: 0.42rem; color: var(--teal); font-weight: 600; }
        .slot-footer { display: flex; justify-content: flex-end; margin-top: 0.1rem; padding-top: 0.1rem; border-top: 1px dashed rgba(0,0,0,0.06); }
        .slot-cost-total { font-size: 0.48rem; color: var(--teal-dark); font-weight: 700; }
        
        .slot-cost { font-size: 0.48rem; color: var(--teal-dark); font-weight: 600; margin-top: 0.1rem; }
        
        /* Recipe & ingredient cards grid */
        .recipe-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 0.6rem; }
        .recipe-card { background: #F8FAF9; border-radius: var(--radius-md); padding: 0.75rem; transition: all 0.2s; border: 1.5px solid transparent; cursor: pointer; position: relative; }
        .recipe-card:hover { border-color: var(--teal); box-shadow: 0 4px 12px rgba(45,106,99,0.1); }
        .recipe-card .rc-name { font-weight: 700; font-size: 0.82rem; color: var(--charcoal); margin-bottom: 0.25rem; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }
        .recipe-card .rc-meta { font-size: 0.65rem; color: #6B7280; margin-bottom: 0.3rem; }
        .recipe-card .rc-tags { display: flex; flex-wrap: wrap; gap: 0.2rem; margin-top: 0.25rem; }
        .recipe-card .rc-badge { font-size: 0.55rem; padding: 1px 6px; border-radius: 4px; font-weight: 600; }
        .recipe-card .rc-actions { display: flex; gap: 0.25rem; margin-top: 0.4rem; }
        .recipe-card .rc-cat { position: absolute; top: 0.5rem; right: 0.5rem; font-size: 0.55rem; background: #E6F2F0; color: var(--teal); padding: 1px 6px; border-radius: 4px; font-weight: 600; }

        .ingredient-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 0.45rem; }
        .ingredient-card { background: #F8FAF9; border-radius: var(--radius-sm); padding: 0.55rem 0.65rem; transition: all 0.2s; border: 1.5px solid transparent; }
        .ingredient-card:hover { border-color: var(--teal); }
        .ingredient-card .ic-name { font-weight: 600; font-size: 0.78rem; color: var(--charcoal); }
        .ingredient-card .ic-meta { font-size: 0.6rem; color: #6B7280; margin-top: 0.15rem; }
        .ingredient-card .ic-actions { display: flex; gap: 0.2rem; margin-top: 0.3rem; }

        .stock-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 0.5rem; }
        .stock-card { background: #F8FAF9; border-radius: var(--radius-md); padding: 0.65rem; border: 1.5px solid transparent; transition: all 0.2s; }
        .stock-card:hover { border-color: var(--teal); }

        @media (max-width: 1200px) {
            .recipe-grid { grid-template-columns: repeat(2, 1fr); }
            .ingredient-grid { grid-template-columns: repeat(3, 1fr); }
        }
        @media (max-width: 768px) {
            .recipe-grid { grid-template-columns: repeat(2, 1fr); gap: 0.45rem; }
            .ingredient-grid { grid-template-columns: repeat(2, 1fr); }
            .stock-grid { grid-template-columns: repeat(2, 1fr); }
            .recipe-card { padding: 0.6rem; }
            .recipe-card .rc-name { font-size: 0.78rem; }
        }
        @media (max-width: 480px) {
            .recipe-grid { grid-template-columns: 1fr 1fr; gap: 0.4rem; }
            .ingredient-grid { grid-template-columns: 1fr 1fr; }
            .stock-grid { grid-template-columns: 1fr 1fr; }
            .recipe-card .rc-actions .btn { font-size: 0.6rem; padding: 2px 5px; }
        }

        .list-item { display: flex; justify-content: space-between; align-items: center; padding: 0.8rem; border-radius: var(--radius-md); background: #F8FAF9; margin-bottom: 0.45rem; transition: background 0.15s; }
        .list-item:hover { background: #EFF2F0; }
        
        .form-section { background: #F8FAF9; border-radius: var(--radius-md); padding: 1.15rem; margin-bottom: 1.15rem; border: 1px solid #E8ECEA; }
        .form-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(165px, 1fr)); gap: 0.7rem; }
        
        .info-box { background: #E6F2F0; color: var(--teal-dark); padding: 0.8rem; border-radius: var(--radius-md); display: flex; align-items: flex-start; gap: 0.5rem; font-size: 0.78rem; }
        
        .stock-badge { display: inline-flex; align-items: center; gap: 0.2rem; padding: 0.12rem 0.35rem; border-radius: 4px; font-size: 0.63rem; font-weight: 600; }
        .stock-badge.ok { background: #E6F2F0; color: var(--teal-dark); }
        .stock-badge.expired { background: #FED7D7; color: #9B2C2C; }
        .stock-badge.soon { background: #FEEBC8; color: #C05621; }
        .stock-badge.in-stock { background: var(--gold-light); color: var(--gold-dark); }
        
        /* Landing page */
        .landing { font-family: 'Lexend', sans-serif; background: var(--mist); min-height: 100vh; min-height: 100dvh; overflow-x: hidden; }
        
        .landing-header {
            padding: 0.8rem 0; position: fixed; width: 100%; top: 0; z-index: 1000;
            background: var(--teal); box-shadow: 0 2px 10px rgba(0,0,0,0.15);
        }
        .landing-header .container { max-width: 1200px; margin: 0 auto; padding: 0 1.5rem; }
        .landing-header nav { display: flex; justify-content: space-between; align-items: center; }
        .landing-header .logo { display: flex; align-items: center; gap: 0.5rem; font-size: 1.3rem; font-weight: 700; color: white; }
        .landing-header .logo img { width: 34px; height: 34px; border-radius: var(--radius-sm); }
        .nav-links { display: flex; align-items: center; list-style: none; gap: 1.5rem; }
        .nav-links a { text-decoration: none; color: rgba(255,255,255,0.85); font-weight: 600; cursor: pointer; transition: color 0.2s; font-size: 0.85rem; }
        .nav-links a:hover { color: white; }
        .btn-cta-small { background: var(--gold); color: white !important; padding: 0.55rem 1.2rem; border-radius: var(--radius-sm); transition: all 0.2s; font-weight: 600; }
        .btn-cta-small:hover { background: var(--gold-dark); transform: translateY(-1px); }
        
        /* Hero */
        .hero { padding: 120px 0 60px; }
        .hero .container { max-width: 1200px; margin: 0 auto; padding: 0 1.5rem; }
        .hero-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 3.5rem; align-items: center; }
        .badge-new {
            display: inline-block; background: #E6F2F0; color: var(--teal); padding: 0.4rem 1rem;
            border-radius: 100px; font-size: 0.8rem; font-weight: 600; margin-bottom: 1.2rem;
        }
        .hero-content h1 { font-size: 3.2rem; line-height: 1.1; font-weight: 700; margin-bottom: 1.2rem; color: var(--charcoal); }
        .gradient-text { background: linear-gradient(135deg, var(--teal), var(--gold)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; }
        .hero-content > p { font-size: 1.05rem; color: #5A6B68; margin-bottom: 2rem; line-height: 1.7; }
        .hero-actions { display: flex; gap: 0.8rem; margin-bottom: 2rem; }
        .btn-hero-primary {
            background: var(--teal); color: white; padding: 0.9rem 1.8rem; border: none; border-radius: var(--radius-sm);
            font-size: 0.95rem; font-weight: 600; cursor: pointer; font-family: 'Lexend', sans-serif;
            box-shadow: 0 4px 15px rgba(45,106,99,0.2); transition: all 0.2s;
        }
        .btn-hero-primary:hover { transform: translateY(-2px); background: var(--teal-dark); box-shadow: 0 8px 20px rgba(45,106,99,0.3); }
        .btn-hero-secondary {
            background: white; border: 1.5px solid #D5DAD8; padding: 0.9rem 1.6rem; border-radius: var(--radius-sm);
            font-weight: 600; display: flex; align-items: center; gap: 8px; cursor: pointer; font-family: 'Lexend', sans-serif;
            font-size: 0.95rem; color: var(--charcoal); transition: all 0.2s;
        }
        .btn-hero-secondary:hover { border-color: var(--teal); color: var(--teal); }
        
        /* Hero image + floating cards */
        .hero-image-wrapper { position: relative; }
        .glass-card { background: white; padding: 0.6rem; border-radius: var(--radius-lg); box-shadow: var(--shadow-hover); }
        .glass-card img { width: 100%; border-radius: var(--radius-md); display: block; aspect-ratio: 4/3; object-fit: cover; }
        .floating-ui {
            position: absolute; background: white; padding: 0.7rem 0.9rem; border-radius: var(--radius-md);
            display: flex; align-items: center; gap: 8px; box-shadow: var(--shadow-hover);
        }
        .floating-ui h6 { font-weight: 700; font-size: 0.75rem; margin: 0; color: var(--charcoal); }
        .floating-ui p { font-size: 0.65rem; margin: 0; color: #5A6B68; }
        .floating-ui .fi-icon { font-size: 1.3rem; flex-shrink: 0; }
        .stock-alert { top: 18%; left: -25px; }
        .recipe-suggestion { bottom: 12%; right: -15px; }
        
        /* Stats */
        .hero-stats { display: flex; align-items: center; gap: 1.5rem; }
        .stat-item strong { font-size: 1.2rem; color: var(--teal); display: block; font-weight: 700; }
        .stat-item span { font-size: 0.78rem; color: #5A6B68; }
        .stat-divider { width: 1px; height: 32px; background: #D5DAD8; }
        
        /* Hero animations */
        @keyframes heroFadeUp { from { opacity: 0; transform: translateY(25px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes heroFadeLeft { from { opacity: 0; transform: translateX(30px); } to { opacity: 1; transform: translateX(0); } }
        .hero-content { animation: heroFadeUp 0.7s ease-out both; }
        .hero-image-wrapper { animation: heroFadeLeft 0.7s ease-out 0.2s both; }
        .floating-ui.stock-alert { animation: heroFadeUp 0.5s ease-out 0.5s both; }
        .floating-ui.recipe-suggestion { animation: heroFadeUp 0.5s ease-out 0.7s both; }
        
        /* Features page */
        .features-page { min-height: calc(100vh - 56px); display: flex; flex-direction: column; padding-top: 80px; }
        .features-page-inner { max-width: 1100px; margin: 0 auto; padding: 0 1.5rem 60px; flex: 1; }
        .features-page-inner > h2 { text-align: center; font-size: 1.8rem; color: var(--teal); margin-bottom: 0.4rem; font-weight: 700; }
        .features-page-inner > p { text-align: center; color: #5A6B68; margin-bottom: 40px; font-size: 0.95rem; }
        .features { display: grid; grid-template-columns: repeat(auto-fit, minmax(260px, 1fr)); gap: 20px; }
        .feature-card {
            background: white; padding: 1.5rem 1.25rem; border-radius: var(--radius-lg); text-align: center;
            box-shadow: var(--shadow); transition: transform 0.2s, box-shadow 0.2s;
        }
        .feature-card:hover { transform: translateY(-4px); box-shadow: var(--shadow-hover); }
        .feature-card .icon { font-size: 2.2rem; margin-bottom: 0.8rem; }
        .feature-card h3 { color: var(--teal); margin-bottom: 0.5rem; font-size: 0.95rem; font-weight: 600; }
        .feature-card p { font-size: 0.8rem; color: #5A6B68; line-height: 1.5; }
        .features-back { text-align: center; margin-top: 2rem; }
        .features-back button { background: var(--teal); color: white; padding: 0.6rem 1.5rem; border-radius: var(--radius-sm); font-weight: 600; font-size: 0.85rem; border: none; cursor: pointer; font-family: 'Lexend', sans-serif; transition: all 0.2s; }
        .features-back button:hover { background: var(--teal-dark); transform: translateY(-1px); }
        
        /* Auth modal */
        .auth-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.4); backdrop-filter: blur(6px); display: flex; align-items: center; justify-content: center; z-index: 2000; padding: 1rem; animation: fadeIn 0.2s ease-out; }
        .auth-card { background: var(--white); border-radius: var(--radius-lg); padding: 1.75rem; width: 100%; max-width: 380px; color: var(--charcoal); box-shadow: 0 20px 50px rgba(0,0,0,0.18); position: relative; }
        .auth-close { position: absolute; top: 12px; right: 14px; background: none; border: none; font-size: 1.2rem; cursor: pointer; color: #999; padding: 4px; }
        .auth-close:hover { color: var(--charcoal); }
        .auth-card-header { text-align: center; margin-bottom: 1.25rem; }
        .auth-card-header h2 { font-size: 1.05rem; font-weight: 700; margin: 0; color: var(--charcoal); }
        .auth-card-header p { font-size: 0.75rem; color: #5A6B68; margin-top: 0.2rem; }
        .auth-separator { display: flex; align-items: center; gap: 0.75rem; margin: 1rem 0; color: #9CA3AF; font-size: 0.7rem; }
        .auth-separator::before, .auth-separator::after { content: ''; flex: 1; height: 1px; background: #E8ECEA; }
        .auth-link { color: var(--teal); font-weight: 600; background: none; border: none; cursor: pointer; text-decoration: none; font-size: inherit; }
        .auth-link:hover { text-decoration: underline; }
        .forgot-link { display: block; text-align: right; margin-top: 0.3rem; }
        .forgot-link button { color: var(--teal); font-weight: 500; background: none; border: none; cursor: pointer; font-size: 0.7rem; }
        .forgot-link button:hover { text-decoration: underline; }
        .landing-footer { background: var(--charcoal); color: rgba(255,255,255,0.4); text-align: center; padding: 1.2rem; font-size: 0.72rem; }
        .legal-links { margin-top: 0.4rem; display: inline-block; }
        .legal-links a { color: rgba(255,255,255,0.5); cursor: pointer; text-decoration: none; transition: color 0.2s; }
        .legal-links a:hover { color: rgba(255,255,255,0.8); text-decoration: underline; }
        .legal-content h3 { color: var(--teal); font-size: 0.9rem; margin: 1.2rem 0 0.4rem; }
        .legal-content h3:first-child { margin-top: 0; }
        .legal-content p { margin-bottom: 0.8rem; }
        
        @media (max-width: 968px) {
            .hero-grid { grid-template-columns: 1fr; text-align: center; }
            .hero-actions { justify-content: center; }
            .hero-stats { justify-content: center; }
            .floating-ui { display: none; }
            .hero-content h1 { font-size: 2.2rem; }
            .hero { padding: 90px 0 40px; }
            .nav-links .nav-text { display: none; }
            .features { grid-template-columns: 1fr 1fr; }
        }
        @media (max-width: 480px) {
            .hero-content h1 { font-size: 1.8rem; }
            .hero-actions { flex-direction: column; align-items: center; }
            .features { grid-template-columns: 1fr; }
        }
        .user-menu { position: relative; }
        .user-btn { background: rgba(255,255,255,0.15); border: 1.5px solid rgba(255,255,255,0.25); border-radius: 50%; width: 34px; height: 34px; display: flex; align-items: center; justify-content: center; cursor: pointer; font-weight: 600; font-size: 0.82rem; color: white; transition: all 0.2s; }
        .user-btn:hover { background: rgba(255,255,255,0.25); }
        .user-dropdown { position: absolute; top: 100%; right: 0; margin-top: 0.5rem; background: white; border-radius: var(--radius-sm); box-shadow: var(--shadow-hover); min-width: 180px; display: none; z-index: 600; }
        .user-dropdown.show { display: block; }
        .user-dropdown-item { padding: 0.7rem 1rem; display: flex; align-items: center; gap: 0.5rem; cursor: pointer; border: none; background: none; width: 100%; font-size: 0.78rem; color: var(--charcoal); }
        .user-dropdown-item:hover { background: #F0F3F2; }
        
        /* Modal */
        .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.45); backdrop-filter: blur(4px); display: flex; align-items: center; justify-content: center; z-index: 1000; padding: 1rem; }
        .modal { background: white; border-radius: var(--radius-lg); max-width: 500px; width: 100%; max-height: 85vh; overflow-y: auto; box-shadow: 0 25px 50px rgba(0,0,0,0.2); }
        .modal-header { padding: 0.9rem 1.15rem; border-bottom: 1px solid #E8ECEA; display: flex; justify-content: space-between; align-items: center; }
        .modal-body { padding: 1.15rem; }
        .modal-footer { padding: 0.8rem 1.15rem; border-top: 1px solid #E8ECEA; display: flex; justify-content: flex-end; gap: 0.5rem; }
        
        .toast { position: fixed; bottom: 5rem; left: 50%; transform: translateX(-50%); background: var(--charcoal); color: white; padding: 0.7rem 1.15rem; border-radius: var(--radius-sm); z-index: 9999; font-size: 0.8rem; box-shadow: 0 4px 15px rgba(0,0,0,0.2); display: none; white-space: nowrap; }
        
        /* Sub-tabs */
        .sub-tabs { display: flex; gap: 0.25rem; margin-bottom: 1rem; }
        .sub-tab { padding: 0.4rem 0.8rem; border-radius: var(--radius-sm); font-size: 0.75rem; font-weight: 600; cursor: pointer; border: 1.5px solid #D5DAD8; background: white; color: var(--charcoal); transition: all 0.2s; }
        .sub-tab.active { background: var(--teal); color: white; border-color: var(--teal); }
        .sub-tab.stock { border-color: var(--gold); color: var(--gold-dark); }
        .sub-tab.stock.active { background: var(--gold); color: white; border-color: var(--gold); }
        
        /* Mobile */
        .mobile-nav { display: none; position: fixed; bottom: 0; left: 0; right: 0; background: white; border-radius: var(--radius-lg) var(--radius-lg) 0 0; box-shadow: 0 -4px 15px rgba(0,0,0,0.1); padding: 0.25rem 0; padding-bottom: calc(0.25rem + env(safe-area-inset-bottom)); z-index: 1000; }
        .mobile-nav-inner { display: flex; justify-content: space-around; }
        .mobile-nav-btn { flex: 1; display: flex; flex-direction: column; align-items: center; gap: 0.05rem; padding: 0.45rem 0.1rem; border: none; background: transparent; color: #9CA3AF; font-size: 0.55rem; cursor: pointer; transition: color 0.2s; min-height: 44px; }
        .mobile-nav-btn.active { color: var(--teal); }
        .mobile-nav-btn span:first-child { font-size: 1.1rem; }
        
        /* Mobile planning cards */
        .planning-cards { display: none; }
        .planning-day-card { background: #F8FAF9; border-radius: var(--radius-md); padding: 0.7rem; margin-bottom: 0.6rem; border-left: 4px solid var(--teal); }
        .planning-day-card .pdc-header { font-weight: 700; font-size: 0.9rem; color: var(--teal); margin-bottom: 0.5rem; display: flex; justify-content: space-between; align-items: center; }
        .planning-day-card .pdc-header .pdc-cost { font-size: 0.68rem; font-weight: 600; color: var(--gold-dark); background: #FFF6E6; padding: 2px 8px; border-radius: 6px; }
        .planning-meal-row { display: flex; gap: 0.5rem; align-items: flex-start; padding: 0.45rem 0; border-bottom: 1px solid #E8ECEA; }
        .planning-meal-row:last-child { border-bottom: none; }
        .planning-meal-row .pmr-icon { font-size: 1rem; width: 28px; text-align: center; flex-shrink: 0; padding-top: 2px; }
        .planning-meal-row .pmr-content { flex: 1; min-width: 0; }
        .planning-meal-row .pmr-type { font-size: 0.68rem; font-weight: 600; color: #888; margin-bottom: 0.15rem; }
        .planning-meal-row .pmr-recipe { font-size: 0.8rem; font-weight: 600; color: var(--charcoal); }
        .planning-meal-row .pmr-meta { font-size: 0.62rem; color: #6B7280; margin-top: 0.1rem; }
        .planning-meal-row .pmr-members { display: flex; flex-wrap: wrap; gap: 0.2rem; margin-top: 0.2rem; }
        .planning-meal-row .pmr-member { font-size: 0.58rem; background: #E6F2F0; color: var(--teal); padding: 1px 6px; border-radius: 4px; font-weight: 600; }
        .planning-meal-row .pmr-empty { font-size: 0.75rem; color: #C5C9C7; font-style: italic; }
        .planning-meal-row .pmr-actions { flex-shrink: 0; }

        @media (max-width: 768px) {
            .planning-scroll-wrapper { display: none !important; }
            .planning-cards { display: block; }
        }

        @media (max-width: 768px) {
            .navbar { display: none; }
            .mobile-nav { display: block; }
            main { padding: 0.5rem 0.75rem 5rem !important; }
            .header-inner { padding: 0.5rem 0.75rem; }
            .card-header { padding: 0.6rem 0.75rem; flex-direction: column; align-items: flex-start; }
            .card-body { padding: 0.75rem; }
            .form-grid { grid-template-columns: 1fr 1fr; }
            
            /* Planning buttons responsive */
            .planning-actions { display: flex; flex-wrap: wrap; gap: 0.25rem; width: 100%; }
            .planning-actions .btn { font-size: 0.62rem; padding: 0.35rem 0.5rem; }
            
            /* Planning grid mobile - scroll hint */
            .planning-scroll-wrapper { overflow-x: auto; -webkit-overflow-scrolling: touch; margin: 0 -0.75rem; padding: 0 0.75rem; }
            .planning-grid { min-width: 680px; }
            .planning-header { font-size: 0.62rem; padding: 0.35rem; }
            .meal-cell { min-height: 65px; }
            .meal-type-cell { font-size: 0.58rem; }
            .recipe-tag { font-size: 0.52rem; }
            
            /* Edit button always visible on touch */
            .edit-slot-btn { opacity: 0.7; }
            
            /* Modal fullscreen on mobile */
            .modal { max-width: 100%; max-height: 100vh; border-radius: var(--radius-md) var(--radius-md) 0 0; margin-top: auto; }
            .modal-overlay { align-items: flex-end; }
            .auth-card { max-width: 100%; border-radius: var(--radius-md) var(--radius-md) 0 0; }
            .auth-overlay { align-items: flex-end; }
            
            /* Lists */
            .list-item { padding: 0.6rem; flex-wrap: wrap; gap: 0.4rem; }
            
            /* Inputs touch-friendly */
            .input, .select, textarea { font-size: 16px; padding: 0.6rem 0.7rem; }
            .btn { min-height: 40px; }
        }
        
        @media (max-width: 480px) {
            .form-grid { grid-template-columns: 1fr; }
            .hero-content h1 { font-size: 1.8rem; }
            .hero-actions { flex-direction: column; align-items: center; }
            .hero-actions button { width: 100%; text-align: center; justify-content: center; }
            .features { grid-template-columns: 1fr; }
            .hero-stats { flex-direction: column; gap: 0.5rem; }
            .stat-divider { width: 60px; height: 1px; }
            .planning-grid { min-width: 580px; }
            .planning-grid .planning-header { font-size: 0.55rem; }
        }
        
        .loading { display: flex; align-items: center; justify-content: center; min-height: 100vh; }
        .loading-spinner { width: 40px; height: 40px; border: 3px solid #E8ECEA; border-top-color: var(--teal); border-radius: 50%; animation: spin 1s linear infinite; }
        
        @media print { .no-print { display: none !important; } }
    </style>
</head>
<body>
    <div id="app"></div>
    <noscript>
        <div style="font-family:sans-serif;max-width:800px;margin:2rem auto;padding:1rem;">
            <h1>Repasio — Planificateur de repas familial intelligent</h1>
            <p>Repasio vous aide à organiser les repas de votre famille pour toute la semaine. Planifiez vos menus, gérez votre stock alimentaire et vos péremptions, générez automatiquement vos listes de courses et maîtrisez votre budget.</p>
            <h2>Fonctionnalités</h2>
            <ul>
                <li><strong>Planning intelligent</strong> — Organisez les repas de votre famille pour toute la semaine avec un générateur automatique qui tient compte de la saison, de votre stock et de votre budget.</li>
                <li><strong>Budget maîtrisé</strong> — Fixez un budget hebdomadaire et Repasio compose des menus adaptés avec calcul du coût par portion.</li>
                <li><strong>Gestion du stock</strong> — Suivez vos aliments et leurs dates de péremption pour zéro gaspillage. Les recettes sont priorisées selon votre stock.</li>
                <li><strong>Liste de courses automatique</strong> — Générez un PDF de courses complet avec déduction automatique de votre stock existant.</li>
                <li><strong>Toute la famille</strong> — Portions calculées par participant selon l'âge, le poids et l'activité. Chaque membre a son profil nutritionnel.</li>
                <li><strong>Recettes personnalisées</strong> — Créez, organisez et partagez vos recettes avec la communauté. Exportez en PDF.</li>
            </ul>
            <p>JavaScript est nécessaire pour utiliser Repasio. Veuillez activer JavaScript dans votre navigateur.</p>
        </div>
    </noscript>

    <script>
        const SUPABASE_URL = 'https://wwovyniqwhmwbnrhabrs.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Ind3b3Z5bmlxd2htd2JucmhhYnJzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njg5MzQ0MjQsImV4cCI6MjA4NDUxMDQyNH0.UUmKNmUWfLUNGIcVRyHqYu8Dnkuy_S6Ewjn3hmRjzd4';
        const LOGO_B64 = 'data:image/jpeg;base64,/9j/4AAQSkZJRgABAQAAAQABAAD/2wBDAAYEBQYFBAYGBQYHBwYIChAKCgkJChQODwwQFxQYGBcUFhYaHSUfGhsjHBYWICwgIyYnKSopGR8tMC0oMCUoKSj/2wBDAQcHBwoIChMKChMoGhYaKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCj/wAARCAB4AHgDASIAAhEBAxEB/8QAHwAAAQUBAQEBAQEAAAAAAAAAAAECAwQFBgcICQoL/8QAtRAAAgEDAwIEAwUFBAQAAAF9AQIDAAQRBRIhMUEGE1FhByJxFDKBkaEII0KxwRVS0fAkM2JyggkKFhcYGRolJicoKSo0NTY3ODk6Q0RFRkdISUpTVFVWV1hZWmNkZWZnaGlqc3R1dnd4eXqDhIWGh4iJipKTlJWWl5iZmqKjpKWmp6ipqrKztLW2t7i5usLDxMXGx8jJytLT1NXW19jZ2uHi4+Tl5ufo6erx8vP09fb3+Pn6/8QAHwEAAwEBAQEBAQEBAQAAAAAAAAECAwQFBgcICQoL/8QAtREAAgECBAQDBAcFBAQAAQJ3AAECAxEEBSExBhJBUQdhcRMiMoEIFEKRobHBCSMzUvAVYnLRChYkNOEl8RcYGRomJygpKjU2Nzg5OkNERUZHSElKU1RVVldYWVpjZGVmZ2hpanN0dXZ3eHl6goOEhYaHiImKkpOUlZaXmJmaoqOkpaanqKmqsrO0tba3uLm6wsPExcbHyMnK0tPU1dbX2Nna4uPk5ebn6Onq8vP09fb3+Pn6/9oADAMBAAIRAxEAPwDGpDS0mK3POCiiigApKKKACiiigAooooGFLSUUCCloFLQAhooooAKWkozQAd6DRRQAlFFFABWppGgatrMU0mlafcXUcX32jHAPpz1PsOa1vhjptlq3jOztNSRZICrv5bdJGUZAPqO+Pavo+ysrWwg8mxt4beHJbZEgVcnqcCplKxtTpc2rPkdlZGZWBVlOCpGCD6Gkr374q+HNIXwjqmoC1hivUfz1nVQHZ2YAgnuDk8V4DTTuRODi7C0UlFMkWg0UtAhM0UUUAFFFFAC0lFJQAoopKRvunHpQBJDPNbSrNbSvFPGdySIcMpHQg19GHxlp8Om2IOt6THdtAjSfaJCx3FRnIU8V8vW92BBLIckrgDPc81f0rw1q2s25ukwifwljtB+lKqoU1zVJcq8zKlipytGjByb6HoXxZ1271K9sYXvLOa1EPmAWNwZInbcRuIPRh0xzXAVRVbrT717LUFYSjoG65qLSJZJJZvMJII3c9jVqHu3T0I+tqU1Fqzd16WNOlpKKk6RaKKBQIKKKKQBSUUUwFpKKKACiiloGY10oMKhQFH2hs4r23TUSPT7VIgNgiXGPpXi/kmeznVfvCViPrXRaD44k06wW0u7czGIbVOcED0NcObYOriqcVS1ae3qTleMpYSpJ1tFJKz9OhP8AFCNF1XTpU/1zLz9AeKwbRVD3G1QP3hHH0FNvb6417WDezjCLwFHQY6AUtly9z/11NdeGpSoYeNKT1SMJ1Y18TKtFaSenyW/zLNLSUVZ0i0UUd6BBRQaKACkpaSgApVVnbCKzN6KMmkrtvg3x4+tMf88Jv/QKT0HFXdji3R0IEiMhPQMCP502vWrrU9T8TeB/Er+KLFYvsCLLaXBgMRD5PAz17dP71YFp8OLqezgEuqWNvq1xF50GmyH9464yMnPBP0/rSv3LcH0OEAA6Co5IIpGy8asfUiu08OeBbjWdIfUpdQtbC2iuGgnNzlfK2jkk5x1IGKj1XwPf2PiWw0hLi2mW/G62ug22N17n6j05zkY60+Yh0rrVHJKoUAKAAOwpeldb4j8GNpelLqWnaraataCYW8rW3WNz0B5Pfj8RU2veBG0jSbqeXWdPkv7SNZbmxDYeNWxwDnk8+gzRdD5GuhyVzaz2pjFzDLCZEEiCRSu5T0YZ6g+tRCu813Qtd13xDoOmz3UF1PLp0ckbiPy1hh5+96kdz3yKpeKfBE2iaYNRs9StNUslk8qaS3/5ZP6Hk8Z4ouNwZyFFFLTIEopaKAE7UUUGgBK7b4N/8j7akdfJm/8AQK4qnRSyQyb4ZHjccbkYqfzFJji7O56fqes3/jD4bXM8s7yXuk3Yku4kG0TQ5yCVHp/7Ka6vUlur/wAQ2Wq6L4b0q/gmjSeHVJZ9vl4X+LHIx04B/nXg0U80IcRTSxhxhwjldw9DjrUsV9eQ2j2sV3cR2z/ehWVgjfVQcUuU0VTuenQaffeLPhzqIsI4heS61Lc/Z0kG1+5VSeDjOR64q6NFtTd+B/C+ulJbm1gnnmhWTvjKR5H0P121wcOvwweAYtKt5LiLUo9RN2rplQq7ccMD1rnJLmeS6+0yTytcbt3ms5L59d3XNFgc0j1zW7e8i+HWtm40Ky0OV7qARRQEKWAkUB35wOeAfapvEum3Gp+H9bn8XaJaW17ZWfmQ6vbyDE7gfKMdeemDx+leQ3N7d3JkNzd3Exkxv8yVm3Y6ZyecUst9eTWiWs13cSWyfdieVii/QE4o5Q9oj2OCaP8A4SnT7GSRYZtQ8MpbW8jcYkOSOfwP5VzceiXvhD4e+I49eWOCXUGigtoA4YuynluPb9BXnUk0sjo0ksjsgAUs5JUDoB6VJeXl1eurXlzPcMowplkL4Htk0WE53IKWkpaozEooooAKKBS0AJRilooATtQBS0lABQaKKACiiigAzRRS0AFFFFACUUtFABSUUUALSUUUAFAoooAKKKKQAaSiimAUooooAWkoooAKKKKAP//Z';
        
        let db = null;
        let _searchTimers = {};

        const state = {
            user: null, isLoading: true, authMode: 'login', activeTab: 'planning',
            familyMembers: [], ingredients: [], recipes: [], weeklyMeals: [], slotParticipants: [], 
            shoppingList: [], shoppingRecipeDetails: [],
            stockItems: [],
            newStockItem: { ingredient_id: null, quantity: '', unit: 'g', expiry_date: '' },
            editingStockItem: null,
            ingredientSubTab: 'ingredients',
            newMember: { name: '', age: '', gender: '', weight: '', height: '', activity: 'Modérée', goal: 'Maintien' },
            newIngredient: { name: '', kcal: '', proteins: '', carbs: '', fats: '', priceKg: '', unit: 'g' },
            newRecipe: { name: '', category: 'Plat principal', difficulty: 'Facile', preptime: 0, cooktime: 0, servings: 4, instructions: '', ingredients: [] },
            editingMember: null, editingIngredient: null, editingRecipe: null,
            showMealModal: false, currentMealEdit: null,
            searchRecipe: '', searchIngredient: '',
            toast: null, showUserMenu: false,
            resetEmail: '', showResetForm: false, showAuthForm: false, showFeatures: false,
            profile: null, showPremiumModal: false, premiumFeatureClicked: '',
            legalPage: null,
            showOnboarding: false, onboardingStep: 0,
            dietaryOptions: [], applianceOptions: [],
            profileDietary: [], profileAllergies: [], profileAppliances: [], defaultParticipants: [], mealSchedule: {},
            siteRecipes: [], recipeTab: 'mine', siteRecipeSearch: '', expandedSiteRecipe: null,
            showSubscriptionModal: false, showContactModal: false, showGenModal: false, showValidateModal: false, showClearModal: false, _planningValidated: false, _stockBeforeValidation: null, contactForm: { name: '', email: '', subject: '', message: '' }
        };

        // ============================================
        // Premium features config
        // ============================================
        const PREMIUM_FEATURES = ['stock', 'shopping_pdf', 'planning_pdf', 'recipes_pdf', 'auto_menu'];
        
        function isPremium() {
            const p = state.profile;
            if (!p) return false;
            if (p.subscription_status === 'active') return true;
            if (p.subscription_status === 'trial' && p.trial_end) {
                return new Date(p.trial_end) > new Date();
            }
            return false;
        }
        
        function getPremiumLabel() {
            const p = state.profile;
            if (!p) return 'Gratuit';
            if (p.subscription_status === 'active') return 'Premium';
            if (p.subscription_status === 'trial' && p.trial_end) {
                const days = Math.ceil((new Date(p.trial_end) - new Date()) / 864e5);
                return days > 0 ? `Essai (${days}j)` : 'Essai terminé';
            }
            return 'Gratuit';
        }

        function checkPremium(featureName, friendlyName) {
            if (isPremium()) return true;
            state.premiumFeatureClicked = friendlyName || featureName;
            state.showPremiumModal = true;
            render();
            return false;
        }

        async function startStripeCheckout(plan) {
            if (!state.user?.id) return;
            const promoInput = document.getElementById('promo-code-input');
            const promoCode = promoInput ? promoInput.value.trim() : '';
            try {
                showToast('Redirection vers Stripe...');
                const { data: { session } } = await db.auth.getSession();
                if (!session?.access_token) { showToast('Session expirée, reconnectez-vous'); return; }
                const res = await fetch('https://wwovyniqwhmwbnrhabrs.supabase.co/functions/v1/create-checkout', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer ' + session.access_token,
                        'apikey': SUPABASE_KEY,
                    },
                    body: JSON.stringify({ plan, promo_code: promoCode || undefined }),
                });
                const result = await res.json();
                console.log('Stripe response:', result);
                if (result.error) throw new Error(result.error);
                if (result.url) {
                    window.location.href = result.url;
                } else if (result.success) {
                    await loadProfile();
                    state.showPremiumModal = false;
                    render();
                    showToast(result.message || 'Premium activé !');
                }
            } catch(e) { console.error('Checkout error:', e); showToast('Erreur: ' + e.message); }
        }

        function renderPremiumModal() {
            if (!state.showPremiumModal) return '';
            return `<div class="modal-overlay" onclick="if(event.target===this){state.showPremiumModal=false;render();}">
                <div class="modal" style="max-width: 440px;">
                    <div class="modal-header">
                        <h3 style="margin: 0; font-weight: 700; font-size: 1.05rem;">\u2728 Fonctionnalité Premium</h3>
                        <button onclick="state.showPremiumModal=false;render();" style="background: none; border: none; font-size: 1.2rem; cursor: pointer; color: #999;">\u2715</button>
                    </div>
                    <div class="modal-body" style="text-align: center;">
                        <div style="font-size: 2.5rem; margin-bottom: 0.8rem;">\uD83D\uDD12</div>
                        <h4 style="font-size: 1rem; margin-bottom: 0.5rem; color: var(--charcoal);">${state.premiumFeatureClicked}</h4>
                        <p style="font-size: 0.85rem; color: #666; margin-bottom: 1.2rem; line-height: 1.6;">
                            Cette fonctionnalité fait partie de l\u2019offre <strong style="color: var(--gold);">Repasio Premium</strong>.
                            Essayez gratuitement pendant 14 jours !
                        </p>
                        
                        <div style="display: flex; gap: 0.6rem; margin-bottom: 1rem;">
                            <div onclick="document.querySelectorAll('.plan-card').forEach(c=>c.style.borderColor='#E8ECEA');this.style.borderColor='var(--teal)';" 
                                class="plan-card" id="plan-monthly"
                                style="flex: 1; background: #F8FAF9; border-radius: var(--radius-md); padding: 1rem; border: 2px solid var(--teal); cursor: pointer; transition: border 0.2s;">
                                <div style="font-size: 0.7rem; color: #999; font-weight: 600; text-transform: uppercase;">Mensuel</div>
                                <div style="font-size: 1.6rem; font-weight: 700; color: var(--teal); margin: 0.2rem 0;">3,99\u20AC</div>
                                <div style="font-size: 0.72rem; color: #888;">/mois</div>
                            </div>
                            <div onclick="document.querySelectorAll('.plan-card').forEach(c=>c.style.borderColor='#E8ECEA');this.style.borderColor='var(--teal)';" 
                                class="plan-card" id="plan-yearly"
                                style="flex: 1; background: #F8FAF9; border-radius: var(--radius-md); padding: 1rem; border: 2px solid #E8ECEA; cursor: pointer; transition: border 0.2s; position: relative;">
                                <div style="position: absolute; top: -8px; right: 8px; background: var(--gold); color: white; font-size: 0.55rem; padding: 2px 6px; border-radius: 4px; font-weight: 700;">-27%</div>
                                <div style="font-size: 0.7rem; color: #999; font-weight: 600; text-transform: uppercase;">Annuel</div>
                                <div style="font-size: 1.6rem; font-weight: 700; color: var(--teal); margin: 0.2rem 0;">34,99\u20AC</div>
                                <div style="font-size: 0.72rem; color: #888;">soit 2,92\u20AC/mois</div>
                            </div>
                        </div>

                        <div style="font-size: 0.78rem; color: #666; text-align: left; margin-bottom: 1rem;">
                            <div style="padding: 0.2rem 0;">\u2705 Gestion du stock & péremptions</div>
                            <div style="padding: 0.2rem 0;">\u2705 Liste de courses PDF intelligente</div>
                            <div style="padding: 0.2rem 0;">\u2705 Export PDF planning & recettes</div>
                            <div style="padding: 0.2rem 0;">\u2705 Génération auto de menus avec budget</div>
                        </div>

                        <div style="margin-bottom: 1rem;">
                            <input type="text" id="promo-code-input" class="input" placeholder="Code promo (optionnel)" style="text-align: center; font-size: 0.82rem;">
                        </div>

                        <button class="btn btn-generate" style="width: 100%; justify-content: center; padding: 0.8rem; font-size: 0.95rem;" 
                            onclick="const sel=document.getElementById('plan-yearly').style.borderColor==='var(--teal)'?'yearly':'monthly'; startStripeCheckout(sel);">
                            Essayer 14 jours gratuitement
                        </button>
                        <p style="font-size: 0.68rem; color: #999; margin-top: 0.6rem;">14 jours gratuits \u2022 Annulable à tout moment \u2022 Paiement sécurisé Stripe</p>
                    </div>
                </div>
            </div>`;
        }

        function renderPremiumBadge(label) {
            if (isPremium()) return '';
            return `<span style="background: linear-gradient(135deg, var(--gold), var(--gold-dark)); color: white; padding: 2px 6px; border-radius: 4px; font-size: 0.58rem; font-weight: 700; margin-left: 0.3rem; vertical-align: middle;">PRO</span>`;
        }

        // ============================================
        // Legal pages + Site content (loaded from DB)
        // ============================================
        let LEGAL_PAGES = {};
        let SITE_CONTENT = {};

        async function loadSiteContent() {
            try {
                const { data: content } = await db.from('site_content').select('key, value');
                (content || []).forEach(c => SITE_CONTENT[c.key] = c.value);
            } catch(e) {}
            try {
                const { data: legal } = await db.from('legal_pages').select('*');
                (legal || []).forEach(p => {
                    LEGAL_PAGES[p.slug] = { title: p.title, content: p.content };
                });
            } catch(e) {}
            // Fallback si DB vide
            if (!LEGAL_PAGES['mentions-legales']) LEGAL_PAGES['mentions-legales'] = { title: 'Mentions Légales', content: '<p>Contenu en cours de rédaction.</p>' };
            if (!LEGAL_PAGES['cgv']) LEGAL_PAGES['cgv'] = { title: 'CGV', content: '<p>Contenu en cours de rédaction.</p>' };
            if (!LEGAL_PAGES['confidentialite']) LEGAL_PAGES['confidentialite'] = { title: 'Politique de Confidentialité', content: '<p>Contenu en cours de rédaction.</p>' };
        }

        function showLegalPage(slug) { state.legalPage = slug; render(); }
        function closeLegalPage() { state.legalPage = null; render(); }

        function renderLegalModal() {
            if (!state.legalPage || !LEGAL_PAGES[state.legalPage]) return '';
            const page = LEGAL_PAGES[state.legalPage];
            return `<div class="modal-overlay" style="z-index: 3000;" onclick="if(event.target===this)closeLegalPage();">
                <div class="modal" style="max-width: 600px; max-height: 85vh;">
                    <div class="modal-header">
                        <h3 style="margin: 0; font-weight: 700; font-size: 0.95rem;">${page.title}</h3>
                        <button onclick="closeLegalPage();" style="background: none; border: none; font-size: 1.2rem; cursor: pointer; color: #999;">✕</button>
                    </div>
                    <div class="modal-body legal-content" style="overflow-y: auto; max-height: 70vh; font-size: 0.82rem; line-height: 1.65; color: #444;">
                        ${page.content}
                    </div>
                </div>
            </div>`;
        }

        // ============================================
        // Debounced search - fix cursor issue
        // ============================================
        function handleSearchInput(field, value, inputId) {
            state[field] = value;
            clearTimeout(_searchTimers[field]);
            _searchTimers[field] = setTimeout(() => {
                render();
                // Restore focus & cursor
                requestAnimationFrame(() => {
                    const el = document.getElementById(inputId);
                    if (el) { el.focus(); el.setSelectionRange(el.value.length, el.value.length); }
                });
            }, 250);
        }

        // ============================================
        // Init
        // ============================================
        async function initApp() {
            try {
                db = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY, {
                    auth: { persistSession: true, autoRefreshToken: true, detectSessionInUrl: true, storage: window.localStorage }
                });

                const { data: { session }, error: sessionError } = await db.auth.getSession();
                console.log('[auth] init session:', !!session, sessionError ? 'ERR:'+sessionError.message : 'ok');
                if (sessionError) { await db.auth.signOut(); }
                else if (session?.user) { state.user = session.user; await loadAllData(); if (shouldShowOnboarding()) { state.showOnboarding = true; state.onboardingStep = 0; } }
                else { state.user = null; }

                db.auth.onAuthStateChange(async (event, session) => {
                    console.log('[auth] event:', event, 'hasSession:', !!session);
                    if (event === 'TOKEN_REFRESHED' && !session) { await db.auth.signOut(); state.user = null; resetState(); render(); return; }
                    if (event === 'SIGNED_OUT') {
                        // Don't reset if onboarding is in progress (transient SIGNED_OUT)
                        if (state.showOnboarding && state._ob) return;
                        state.user = null; resetState(); render(); return;
                    }
                    if (session?.user) {
                        state.user = session.user;
                        if (event === 'SIGNED_IN' || event === 'TOKEN_REFRESHED') {
                            // Don't reload/re-init if onboarding is already in progress
                            if (state.showOnboarding && state._ob) { render(); return; }
                            await loadAllData();
                            if (shouldShowOnboarding()) { state.showOnboarding = true; state.onboardingStep = 0; }
                        }
                    } else if (!state.showOnboarding) { state.user = null; resetState(); }
                    render();
                });

                // Session watchdog — every 2min, verify session is alive
                setInterval(async () => {
                    if (!state.user) return;
                    const { data: { session: s } } = await db.auth.getSession();
                    if (!s) {
                        console.warn('[auth] session lost, trying refresh...');
                        const { error } = await db.auth.refreshSession();
                        if (error) {
                            showToast('⚠️ Session expirée, reconnexion nécessaire', 4000);
                            state.user = null; resetState(); render();
                        }
                    }
                }, 120000);
            } catch (e) { console.error('Init error:', e); }
            await loadSiteContent();
            state.isLoading = false;
            render();
            // Handle Stripe checkout return
            const params = new URLSearchParams(window.location.search);
            if (params.get('checkout') === 'success') {
                showToast('\u2705 Bienvenue dans Repasio Premium !', 5000);
                window.history.replaceState({}, '', window.location.pathname);
                // Webhook needs time to process - retry multiple times
                const retryProfile = async (attempt) => {
                    await loadProfile();
                    render();
                    if (!isPremium() && attempt < 5) {
                        setTimeout(() => retryProfile(attempt + 1), 3000);
                    }
                };
                setTimeout(() => retryProfile(1), 2000);
            } else if (params.get('checkout') === 'cancel') {
                showToast('Abonnement annulé', 3000);
                window.history.replaceState({}, '', window.location.pathname);
            }
        }
        
        function resetState() {
            state.familyMembers = []; state.ingredients = []; state.recipes = [];
            state.weeklyMeals = []; state.slotParticipants = [];
            state.shoppingList = []; state.shoppingRecipeDetails = [];
            state.stockItems = []; state.profile = null;
            state.showPremiumModal = false; state.showAuthForm = false;
            state.showFeatures = false; state.activeTab = 'planning';
            state.showSubscriptionModal = false; state.showContactModal = false;
        }

        function esc(t){return(t||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;')}
        function showToast(msg, dur = 2500) {
            let el = document.getElementById('toast-el');
            if (!el) { el = document.createElement('div'); el.id = 'toast-el'; el.className = 'toast'; document.body.appendChild(el); }
            el.textContent = msg; el.style.display = 'block'; el.style.animation = 'fadeIn 0.2s ease-out';
            clearTimeout(el._timer);
            el._timer = setTimeout(() => { el.style.display = 'none'; }, dur);
        }

        // ============================================
        // Auth
        // ============================================
        async function handleLogin(email, pwd) {
            state.isLoading = true; render();
            try { const { error } = await db.auth.signInWithPassword({ email, password: pwd }); if (error) throw error; showToast('Connexion réussie !'); }
            catch (e) { showToast('Erreur: ' + e.message); }
            state.isLoading = false; render();
        }

        async function handleRegister(email, pwd, name) {
            state.isLoading = true; render();
            try {
                const { data, error } = await db.auth.signUp({ email, password: pwd, options: { data: { name } } });
                if (error) throw error;
                state.authMode = 'login';
                state.showAuthForm = false;
                state.isLoading = false;
                render();
                showToast('📧 Vérifiez votre boîte mail pour confirmer votre compte !', 5000);
                return;
            }
            catch (e) { showToast('Erreur: ' + e.message); }
            state.isLoading = false; render();
        }

        async function handleResetPassword(email) {
            if (!email) { showToast('Entrez votre email'); return; }
            try {
                const { error } = await db.auth.resetPasswordForEmail(email, { redirectTo: window.location.origin });
                if (error) throw error;
                showToast('Email de réinitialisation envoyé !');
                state.showResetForm = false;
            } catch (e) { showToast('Erreur: ' + e.message); }
            render();
        }

        async function handleLogout() {
            await db.auth.signOut(); state.user = null; resetState(); state.showUserMenu = false;
            showToast('Déconnexion'); render();
        }

        // ============================================
        // Data Loading
        // ============================================
        async function loadAllData() {
            if (!state.user?.id) return;
            await Promise.all([loadProfile(), loadFamilyMembers(), loadIngredients(), loadDietaryOptions(), loadApplianceOptions()]);
            loadPreferencesFromProfile();
            await loadRecipes();
            await Promise.all([loadWeeklyMeals(), loadSlotParticipants(), loadStockItems(), loadSiteRecipes(), loadMySubmissions(), loadPdfHistory()]);
        }

        async function loadProfile(retries = 3) {
            for (let i = 0; i < retries; i++) {
                try {
                    const { data, error } = await db.from('profiles').select('*').eq('id', state.user.id).single();
                    if (error) throw error;
                    state.profile = data;
                    return;
                } catch(e) {
                    if (i < retries - 1) await new Promise(r => setTimeout(r, 500));
                }
            }
            state.profile = { subscription_status: 'free', trial_start: null, trial_end: null };
        }

        async function loadFamilyMembers() {
            const { data } = await db.from('family_members').select('*').eq('user_id', state.user.id).order('name');
            state.familyMembers = data || [];
        }
        async function loadIngredients() {
            const { data } = await db.from('ingredients').select('*').or(`user_id.eq.${state.user.id},user_id.is.null`).order('name');
            state.ingredients = data || [];
        }
        async function loadRecipes() {
            const { data } = await db.from('recipes').select('*, recipe_ingredients(quantity, unit, ingredient_id)').eq('user_id', state.user.id).order('name');
            state.recipes = (data || []).map(r => ({
                ...r, ingredients: (r.recipe_ingredients || []).map(ri => {
                    const ing = state.ingredients.find(i => i.id === ri.ingredient_id);
                    return { ...ri, ingredient_name: ing?.name || '', kcal: ing?.kcal || 0, proteins: ing?.proteins || 0, carbs: ing?.carbs || 0, fats: ing?.fats || 0, price: ing?.price || 0 };
                })
            }));
        }

        async function loadSiteRecipes() {
            try {
                const { data } = await db.from('site_recipes').select('*, site_recipe_ingredients(quantity, unit, ingredient_id)').eq('is_active', true).order('avg_rating', { ascending: false });
                state.siteRecipes = data || [];
                // Load user reviews
                if (state.user?.id) {
                    const { data: reviews } = await db.from('recipe_reviews').select('*').eq('user_id', state.user.id);
                    if (reviews) {
                        state.siteRecipes = state.siteRecipes.map(r => {
                            const review = reviews.find(rv => rv.site_recipe_id === r.id);
                            return { ...r, userRating: review?.rating || 0, userComment: review?.comment || '', isExcluded: review?.is_excluded || false, reviewId: review?.id || null };
                        });
                    }
                }
            } catch(e) { console.warn('site_recipes not loaded:', e.message); state.siteRecipes = []; }
        }

        async function rateSiteRecipe(recipeId, rating) {
            try {
                const existing = state.siteRecipes.find(r => r.id === recipeId);
                if (existing?.reviewId) {
                    await db.from('recipe_reviews').update({ rating }).eq('id', existing.reviewId);
                } else {
                    await db.from('recipe_reviews').insert({ user_id: state.user.id, site_recipe_id: recipeId, rating });
                }
                await loadSiteRecipes(); render();
                showToast('Note enregistrée');
            } catch(e) { showToast('Erreur: ' + e.message); }
        }

        async function toggleExcludeRecipe(recipeId) {
            try {
                const existing = state.siteRecipes.find(r => r.id === recipeId);
                const newVal = !existing?.isExcluded;
                if (existing?.reviewId) {
                    await db.from('recipe_reviews').update({ is_excluded: newVal }).eq('id', existing.reviewId);
                } else {
                    await db.from('recipe_reviews').insert({ user_id: state.user.id, site_recipe_id: recipeId, is_excluded: newVal });
                }
                await loadSiteRecipes(); render();
                showToast(newVal ? 'Recette exclue' : 'Recette réintégrée');
            } catch(e) { showToast('Erreur: ' + e.message); }
        }
        async function loadWeeklyMeals() {
            const { data } = await db.from('weekly_meals').select('*').eq('user_id', state.user.id);
            state.weeklyMeals = data || [];
        }
        async function loadSlotParticipants() {
            try { const { data } = await db.from('slot_participants').select('*').eq('user_id', state.user.id); state.slotParticipants = data || []; }
            catch (e) { state.slotParticipants = []; }
        }
        async function loadStockItems() {
            try {
                const { data, error } = await db.from('stock_items').select('*').eq('user_id', state.user.id).order('expiry_date');
                if (error) throw error;
                state.stockItems = data || [];
            } catch (e) {
                // Table may not exist - use localStorage fallback
                console.warn('stock_items table not found, using localStorage');
                const stored = localStorage.getItem('repasio_stock_' + state.user.id);
                state.stockItems = stored ? JSON.parse(stored) : [];
            }
        }

        // ============================================
        // Session guard — redirect to login if session dead
        // ============================================
        async function checkSession() {
            const { data: { session } } = await db.auth.getSession();
            if (session) return true;
            // Try refresh
            console.warn('[auth] session null, attempting refresh...');
            const { data: refreshData, error } = await db.auth.refreshSession();
            if (!error && refreshData.session) {
                state.user = refreshData.session.user;
                return true;
            }
            showToast('⚠️ Session expirée, veuillez vous reconnecter', 4000);
            state.user = null; resetState(); render();
            return false;
        }

        // ============================================
        // Family CRUD
        // ============================================
        async function saveFamilyMember() {
            if (!await checkSession()) return;
            const m = state.editingMember || state.newMember;
            if (!m.name.trim()) { showToast('Entrez un prénom'); return; }
            if (!m.age) { showToast('Entrez l\'âge'); return; }
            if (!m.gender) { showToast('Sélectionnez le genre'); return; }
            if (!m.weight) { showToast('Entrez le poids'); return; }
            if (!m.height) { showToast('Entrez la taille'); return; }
            const data = { name: m.name.trim(), age: parseInt(m.age), gender: m.gender, weight: parseFloat(m.weight), height: parseInt(m.height), activity: m.activity || 'Modérée', user_id: state.user?.id };
            try {
                let error;
                if (state.editingMember?.id) { ({ error } = await db.from('family_members').update(data).eq('id', state.editingMember.id)); }
                else { ({ error } = await db.from('family_members').insert([data])); }
                if (error) throw error;
                state.editingMember = null;
                state.newMember = { name: '', age: '', gender: '', weight: '', height: '', activity: 'Modérée', goal: 'Maintien' };
                await loadFamilyMembers(); showToast('Enregistré'); render();
            } catch(e) { console.error('saveFamilyMember error:', e); showToast('Erreur: ' + (e.message || JSON.stringify(e))); }
        }
        async function deleteFamilyMember(id) { if (!confirm('Supprimer ?')) return; await db.from('family_members').delete().eq('id', id); await loadFamilyMembers(); showToast('Supprimé'); render(); }
        function editFamilyMember(m) { state.editingMember = { ...m }; render(); }
        function cancelEditMember() { state.editingMember = null; render(); }

        // ============================================
        // Ingredients CRUD
        // ============================================
        async function saveIngredient() {
            if (!await checkSession()) return;
            const i = state.editingIngredient || state.newIngredient;
            if (!i.name.trim()) { showToast('Entrez un nom'); return; }
            const priceKg = parseFloat(i.priceKg) || 0;
            const data = { name: i.name.trim(), kcal: parseFloat(i.kcal) || 0, proteins: parseFloat(i.proteins) || 0, carbs: parseFloat(i.carbs) || 0, fats: parseFloat(i.fats) || 0, price: priceKg / 10, user_id: state.user?.id };
            if (state.editingIngredient?.id) { 
                const { error } = await db.from('ingredients').update(data).eq('id', state.editingIngredient.id);
                if (error) { showToast('Erreur: ' + error.message); return; }
            } else { 
                // Vérifier si un ingrédient avec ce nom existe déjà
                const existing = state.ingredients.find(x => x.name.toLowerCase() === data.name.toLowerCase());
                if (existing) { showToast('Cet ingrédient existe déjà'); return; }
                const { error } = await db.from('ingredients').insert([data]);
                if (error) { showToast('Erreur: ' + error.message); return; }
            }
            state.editingIngredient = null;
            state.newIngredient = { name: '', kcal: '', proteins: '', carbs: '', fats: '', priceKg: '', unit: 'g' };
            await loadIngredients(); showToast('Enregistré'); render();
        }
        async function deleteIngredient(id) { if (!confirm('Supprimer ?')) return; await db.from('ingredients').delete().eq('id', id); await loadIngredients(); render(); }
        function editIngredient(ing) { state.editingIngredient = { ...ing, priceKg: ((ing.price || 0) * 10).toFixed(2) }; render(); }
        function cancelEditIngredient() { state.editingIngredient = null; render(); }

        // ============================================
        // Stock CRUD (with localStorage fallback)
        // ============================================
        let _stockUsesLocal = false;
        async function saveStockItem() {
            if (!await checkSession()) return;
            const s = state.editingStockItem || state.newStockItem;
            if (!s.ingredient_id) { showToast('Choisissez un aliment'); return; }
            const data = { ingredient_id: parseInt(s.ingredient_id), quantity: parseFloat(s.quantity) || 0, unit: s.unit || 'g', expiry_date: s.expiry_date || null, user_id: state.user?.id };
            try {
                if (state.editingStockItem?.id && !_stockUsesLocal) { await db.from('stock_items').update(data).eq('id', state.editingStockItem.id); }
                else if (!_stockUsesLocal) { await db.from('stock_items').insert([data]); }
                else { throw new Error('use local'); }
            } catch(e) {
                _stockUsesLocal = true;
                if (state.editingStockItem?.id) {
                    const idx = state.stockItems.findIndex(x => x.id === state.editingStockItem.id);
                    if (idx >= 0) state.stockItems[idx] = { ...data, id: state.editingStockItem.id };
                } else {
                    state.stockItems.push({ ...data, id: Date.now() });
                }
                localStorage.setItem('repasio_stock_' + state.user.id, JSON.stringify(state.stockItems));
            }
            state.editingStockItem = null;
            state.newStockItem = { ingredient_id: null, quantity: '', unit: 'g', expiry_date: '' };
            if (!_stockUsesLocal) await loadStockItems();
            showToast('Stock mis à jour'); render();
        }
        async function deleteStockItem(id) {
            if (!confirm('Retirer du stock ?')) return;
            try { if (!_stockUsesLocal) { await db.from('stock_items').delete().eq('id', id); await loadStockItems(); } else { throw new Error('use local'); } }
            catch(e) { _stockUsesLocal = true; state.stockItems = state.stockItems.filter(x => x.id !== id); localStorage.setItem('repasio_stock_' + state.user.id, JSON.stringify(state.stockItems)); }
            showToast('Retiré'); render();
        }
        function editStockItem(s) { state.editingStockItem = { ...s }; render(); }
        function cancelEditStockItem() { state.editingStockItem = null; render(); }

        function getStockStatus(expiryDate) {
            if (!expiryDate) return { cls: 'ok', label: 'OK' };
            const today = new Date(); today.setHours(0,0,0,0);
            const exp = new Date(expiryDate); exp.setHours(0,0,0,0);
            const diff = Math.ceil((exp - today) / (1000*60*60*24));
            if (diff < 0) return { cls: 'expired', label: 'Périmé' };
            if (diff <= 3) return { cls: 'soon', label: `J-${diff}` };
            return { cls: 'ok', label: `J-${diff}` };
        }
        function getStockForIngredient(ingredientId) { return state.stockItems.filter(s => s.ingredient_id == ingredientId); }

        // ============================================
        // Recipes CRUD
        // ============================================
        async function saveRecipe() {
            if (!await checkSession()) return;
            const r = state.editingRecipe || state.newRecipe;
            if (!r.name.trim()) { showToast('Entrez un nom'); return; }
            if (!r.ingredients || r.ingredients.filter(i => i.ingredient_id).length === 0) { showToast('Ajoutez au moins un ingrédient'); return; }
            const data = { name: r.name.trim(), category: r.category, difficulty: r.difficulty, preptime: parseInt(r.preptime) || 0, cooktime: parseInt(r.cooktime) || 0, servings: parseInt(r.servings) || 4, instructions: r.instructions || '', dietary_info: r.dietary_info || [], appliance: r.appliance || null, user_id: state.user?.id };
            let recipeId;
            try {
                if (state.editingRecipe?.id) {
                    const { error } = await db.from('recipes').update(data).eq('id', state.editingRecipe.id);
                    if (error) throw error;
                    recipeId = state.editingRecipe.id;
                    await db.from('recipe_ingredients').delete().eq('recipe_id', recipeId);
                } else {
                    const { data: newR, error } = await db.from('recipes').insert([data]).select().single();
                    if (error) throw error;
                    recipeId = newR.id;
                }
                for (const ing of r.ingredients) {
                    if (ing.ingredient_id) await db.from('recipe_ingredients').insert([{ recipe_id: recipeId, ingredient_id: ing.ingredient_id, quantity: parseFloat(ing.quantity) || 0, unit: ing.unit || 'g' }]);
                }
                state.editingRecipe = null;
                state.newRecipe = { name: '', category: 'Plat principal', difficulty: 'Facile', preptime: 0, cooktime: 0, servings: 4, instructions: '', ingredients: [], dietary_info: [], appliance: '' };
                await loadRecipes(); showToast('Recette enregistrée'); render();
            } catch(e) { showToast('Erreur: ' + (e.message || e)); }
        }
        async function deleteRecipe(id) { if (!confirm('Supprimer ?')) return; await db.from('recipe_ingredients').delete().eq('recipe_id', id); await db.from('recipes').delete().eq('id', id); await loadRecipes(); render(); }
        function editRecipe(r) { state.editingRecipe = JSON.parse(JSON.stringify(r)); render(); }
        function cancelEditRecipe() { state.editingRecipe = null; render(); }

        // ============================================
        // Planning
        // ============================================
        function getMealsForSlot(day, mealType) { return state.weeklyMeals.filter(m => m.day === day && m.meal_type === mealType); }

        // Lookup recipe — accepts a meal object or a raw id
        function findRecipeById(idOrMeal) {
            if (!idOrMeal) return null;
            // If passed a meal object with site_recipe_id
            if (typeof idOrMeal === 'object') {
                const meal = idOrMeal;
                if (meal.recipe_id) {
                    const r = state.recipes.find(x => x.id == meal.recipe_id);
                    if (r) return r;
                }
                if (meal.site_recipe_id) {
                    const sr = state.siteRecipes.find(x => x.id == meal.site_recipe_id);
                    if (sr) {
                        const ings = (sr.site_recipe_ingredients || []).map(ri => {
                            const ing = state.ingredients.find(i => i.id == ri.ingredient_id);
                            return { ...ri, ingredient_name: ing?.name || '', kcal: ing?.kcal || 0, proteins: ing?.proteins || 0, carbs: ing?.carbs || 0, fats: ing?.fats || 0, price: ing?.price || 0 };
                        });
                        return { ...sr, ingredients: ings, _isSite: true };
                    }
                }
                // Fallback: try recipe_id in both pools
                const fallbackId = meal.recipe_id || meal.site_recipe_id;
                if (fallbackId) return findRecipeById(fallbackId);
                return null;
            }
            // Raw id — search both pools
            const id = idOrMeal;
            let r = state.recipes.find(x => x.id == id);
            if (r) return r;
            const sr = state.siteRecipes.find(x => x.id == id);
            if (!sr) return null;
            const ings = (sr.site_recipe_ingredients || []).map(ri => {
                const ing = state.ingredients.find(i => i.id == ri.ingredient_id);
                return { ...ri, ingredient_name: ing?.name || '', kcal: ing?.kcal || 0, proteins: ing?.proteins || 0, carbs: ing?.carbs || 0, fats: ing?.fats || 0, price: ing?.price || 0 };
            });
            return { ...sr, ingredients: ings, _isSite: true };
        }
        function getParticipantsForSlot(day, mealType) { return state.slotParticipants.filter(p => p.day === day && p.meal_type === mealType); }
        function openMealModal(day, mealType) { state.currentMealEdit = { day, mealType }; state.showMealModal = true; render(); }
        function closeMealModal() { state.showMealModal = false; state.currentMealEdit = null; render(); }

        async function addRecipeToMeal(recipeValue) {
            if (!state.currentMealEdit || !recipeValue) return;
            try {
                const [source, id] = recipeValue.split(':');
                const insertData = { day: state.currentMealEdit.day, meal_type: state.currentMealEdit.mealType, user_id: state.user?.id };
                if (source === 'site') { insertData.site_recipe_id = parseInt(id); insertData.recipe_id = null; }
                else { insertData.recipe_id = parseInt(id); insertData.site_recipe_id = null; }
                const { error } = await db.from('weekly_meals').insert([insertData]);
                if (error) { showToast('Erreur: ' + error.message); return; }
                await applyDefaultParticipants(state.currentMealEdit.day, state.currentMealEdit.mealType);
                await loadWeeklyMeals();
                await loadSlotParticipants();
                showToast('✅ Recette ajoutée');
                render();
            } catch (e) { showToast('Erreur: ' + e.message); }
        }

        async function removeRecipeFromMeal(mealId) {
            const meal = state.weeklyMeals.find(m => m.id === mealId);
            if (!meal) return;
            await db.from('weekly_meals').delete().eq('id', mealId);
            await loadWeeklyMeals();
            if (getMealsForSlot(meal.day, meal.meal_type).length === 0) {
                await db.from('slot_participants').delete().eq('user_id', state.user?.id).eq('day', meal.day).eq('meal_type', meal.meal_type);
                await loadSlotParticipants();
            }
            render();
        }

        async function toggleSlotParticipant(day, mealType, memberId, isChecked) {
            if (isChecked) {
                const { error } = await db.from('slot_participants').insert([{ user_id: state.user?.id, day, meal_type: mealType, member_id: memberId }]);
                if (error) console.error('Insert participant error:', error);
            } else {
                await db.from('slot_participants').delete().eq('user_id', state.user?.id).eq('day', day).eq('meal_type', mealType).eq('member_id', memberId);
            }
            await loadSlotParticipants(); render();
        }
        
        async function validatePlanning() {
            if (state.weeklyMeals.length === 0) { showToast('Aucun repas dans le planning'); return; }
            state.showValidateModal = true;
            render();
        }

        function renderValidateModal() {
            if (!state.showValidateModal) return '';
            const nbMeals = state.weeklyMeals.length;
            const nbStock = state.stockItems.length;
            return `<div class="modal-overlay" onclick="if(event.target===this){state.showValidateModal=false;render();}">
                <div class="modal" style="max-width:420px;">
                    <div class="modal-header">
                        <h3 style="margin:0;font-weight:700;font-size:1.05rem;">⚠️ Valider le planning</h3>
                        <button onclick="state.showValidateModal=false;render();" style="background:none;border:none;font-size:1.2rem;cursor:pointer;color:#999;">✕</button>
                    </div>
                    <div class="modal-body" style="text-align:center;padding:1.2rem;">
                        <div style="font-size:2rem;margin-bottom:0.6rem;">📋</div>
                        <p style="font-size:0.88rem;font-weight:600;color:var(--charcoal);margin-bottom:0.8rem;">Êtes-vous sûr de vouloir valider ?</p>
                        <div style="background:#F8FAF9;border-radius:var(--radius-sm);padding:0.8rem;text-align:left;font-size:0.78rem;line-height:1.8;color:#555;">
                            <div>📦 <strong>Décompte du stock</strong> — les ingrédients des ${nbMeals} repas seront déduits de vos ${nbStock} articles en stock</div>
                            <div>📥 <strong>1 PDF complet</strong> — planning + recettes détaillées + liste de courses</div>
                        </div>
                        <p style="font-size:0.68rem;color:#999;margin-top:0.6rem;">Cette action ne peut pas être annulée.</p>
                    </div>
                    <div class="modal-footer" style="display:flex;gap:0.5rem;">
                        <button class="btn btn-secondary" style="flex:1;" onclick="state.showValidateModal=false;render();">Annuler</button>
                        <button class="btn btn-primary" style="flex:1;" onclick="state.showValidateModal=false;executeValidation();">✅ Valider</button>
                    </div>
                </div>
            </div>`;
        }

        async function executeValidation() {
            if (!await checkSession()) return;
            showToast('Validation en cours...', 2000);
            
            try {
                // Snapshot stock BEFORE deduction for PDF
                state._stockBeforeValidation = JSON.parse(JSON.stringify(state.stockItems));

                const { data, error } = await db.rpc('validate_planning');
                console.log('[validate] RPC response:', { data, error });
                if (error) throw new Error(error.message || JSON.stringify(error));

                if (data?.error) {
                    showToast('⚠️ ' + data.error, 4000);
                    return;
                }

                await loadStockItems();

                let msg = `✅ Validé ! ${data.recipes_found} recettes`;
                if (data.stock_deleted + data.stock_updated > 0) msg += ` • Stock: ${data.stock_deleted} retiré(s), ${data.stock_updated} mis à jour`;
                msg += ' • Cliquez 📥 PDF pour télécharger';
                showToast(msg, 6000);
            } catch(e) {
                console.error('[validatePlanning] error:', e);
                showToast('Erreur validation: ' + e.message);
            } finally {
                state._planningValidated = true;
                render();
            }
        }

        function confirmClearPlanning() {
            state.showClearModal = true;
            render();
        }

        function renderClearModal() {
            if (!state.showClearModal) return '';
            return `<div class="modal-overlay" onclick="if(event.target===this){state.showClearModal=false;render();}">
                <div class="modal" style="max-width:380px;">
                    <div class="modal-header">
                        <h3 style="margin:0;font-weight:700;font-size:1.05rem;">🗑️ Vider le planning</h3>
                        <button onclick="state.showClearModal=false;render();" style="background:none;border:none;font-size:1.2rem;cursor:pointer;color:#999;">✕</button>
                    </div>
                    <div class="modal-body" style="text-align:center;padding:1.2rem;">
                        <div style="font-size:2rem;margin-bottom:0.6rem;">⚠️</div>
                        <p style="font-size:0.88rem;font-weight:600;color:var(--charcoal);margin-bottom:0.5rem;">Êtes-vous sûr ?</p>
                        <p style="font-size:0.78rem;color:#666;">Tous les repas et participants seront supprimés du planning. Cette action est irréversible.</p>
                    </div>
                    <div class="modal-footer" style="display:flex;gap:0.5rem;">
                        <button class="btn btn-secondary" style="flex:1;" onclick="state.showClearModal=false;render();">Annuler</button>
                        <button class="btn btn-delete" style="flex:1;" onclick="clearAllPlanning();">🗑️ Vider</button>
                    </div>
                </div>
            </div>`;
        }

        async function clearAllPlanning() {
            state.showClearModal = false;
            state._planningValidated = false;
            state._stockBeforeValidation = null;
            
            try {
                const { data, error } = await db.rpc('clear_planning');
                if (error) console.error('[clear] error:', error);
            } catch(e) { console.error('[clear] exception:', e); }
            
            state.weeklyMeals = [];
            state.slotParticipants = [];
            render();
            showToast('Planning vidé');
        }

        // ============================================
        // Générer menu auto
        // ============================================
        // ============================================
        // Générer menu auto - step 1: show config modal
        // ============================================
        function generateAutoMenu() {
            if (state.familyMembers.length === 0) { showToast('Ajoutez d\'abord votre famille !'); return; }
            const days = ['Lun','Mar','Mer','Jeu','Ven','Sam','Dim'];
            const mealTypes = ['Petit-déjeuner','Déjeuner','Goûter','Dîner'];
            // Check if any meals are configured
            let totalConfigured = 0;
            for (const schedule of Object.values(state.mealSchedule)) {
                for (const meals of Object.values(schedule || {})) {
                    totalConfigured += (meals || []).length;
                }
            }
            if (totalConfigured === 0) {
                showToast('⚠️ Configurez d\'abord qui mange quand dans ⚙️ Préférences', 5000);
                state.activeTab = 'preferences';
                render();
                return;
            }
            // Build per-day/meal participant config from preferences
            const participants = {};
            days.forEach(d => {
                participants[d] = {};
                mealTypes.forEach(mt => {
                    participants[d][mt] = getScheduledMembers(d, mt);
                });
            });
            // Load saved gen preferences from localStorage
            let savedGenPrefs = {};
            try { savedGenPrefs = JSON.parse(localStorage.getItem('repasio_gen_prefs') || '{}'); } catch(e) {}
            
            state._genConfig = {
                budget: savedGenPrefs.budget || '',
                mealStructure: savedGenPrefs.mealStructure || { 'Déjeuner': ['Plat principal'], 'Dîner': ['Plat principal'] },
                activeDays: {},
                participants
            };
            days.forEach(d => {
                state._genConfig.activeDays[d] = mealTypes.some(mt => participants[d][mt].length > 0);
            });
            state.showGenModal = true;
            render();
        }

        function toggleGenDay(day) {
            const cfg = state._genConfig;
            const mealTypes = ['Petit-déjeuner','Déjeuner','Goûter','Dîner'];
            cfg.activeDays[day] = !cfg.activeDays[day];
            // When activating a day, if no participants at all, fill with all members
            if (cfg.activeDays[day]) {
                const hasAny = mealTypes.some(mt => (cfg.participants[day]?.[mt]||[]).length > 0);
                if (!hasAny) {
                    const allIds = state.familyMembers.map(m => m.id);
                    mealTypes.forEach(mt => { cfg.participants[day][mt] = [...allIds]; });
                }
            }
            render();
        }

        function toggleGenParticipant(day, mt, memberId) {
            const arr = state._genConfig.participants[day][mt];
            const idx = arr.indexOf(memberId);
            if (idx >= 0) arr.splice(idx, 1); else arr.push(memberId);
            render();
        }

        function setGenStructure(mt, key) {
            const map = {
                'plat': ['Plat principal'],
                'entree_plat': ['Entrée','Plat principal'],
                'plat_dessert': ['Plat principal','Dessert'],
                'complet': ['Entrée','Plat principal','Dessert']
            };
            state._genConfig.mealStructure[mt] = map[key] || ['Plat principal'];
            render();
        }

        function renderGenModal() {
            if (!state.showGenModal) return '';
            const cfg = state._genConfig;
            const days = ['Lun','Mar','Mer','Jeu','Ven','Sam','Dim'];
            const mealTypes = ['Petit-déjeuner','Déjeuner','Goûter','Dîner'];
            const mtIcons = {'Petit-déjeuner':'🌅','Déjeuner':'🍽️','Goûter':'🧁','Dîner':'🌙'};
            const structOpts = [
                { key: 'plat', label: 'Plat seul' },
                { key: 'entree_plat', label: 'Entrée + Plat' },
                { key: 'plat_dessert', label: 'Plat + Dessert' },
                { key: 'complet', label: 'E + P + D' }
            ];
            const structMap = { 1:'plat', 2:'entree_plat' };
            const getSelected = (mt) => {
                const v = cfg.mealStructure[mt] || ['Plat principal'];
                if (v.length === 1) return 'plat';
                if (v.includes('Entrée') && v.includes('Dessert')) return 'complet';
                if (v.includes('Entrée')) return 'entree_plat';
                if (v.includes('Dessert')) return 'plat_dessert';
                return 'plat';
            };

            let totalSlots = 0;
            days.forEach(d => { if (cfg.activeDays[d]) mealTypes.forEach(mt => { if ((cfg.participants[d]?.[mt]||[]).length > 0) totalSlots++; }); });

            const structButtons = (mealName) => structOpts.map(o => {
                const sel = getSelected(mealName) === o.key;
                return `<button onclick="setGenStructure('${mealName}','${o.key}')" style="padding:0.25rem 0.45rem;border-radius:5px;border:1.5px solid ${sel?'var(--teal)':'#D5DAD8'};background:${sel?'#E6F2F0':'white'};cursor:pointer;font-size:0.64rem;font-family:inherit;color:${sel?'var(--teal-dark)':'#666'};">${o.label}</button>`;
            }).join('');

            return `<div class="modal-overlay" onclick="if(event.target===this){state.showGenModal=false;render();}">
                <div class="modal" style="max-width: 520px; max-height: 90vh; overflow-y: auto;">
                    <div class="modal-header">
                        <h3 style="margin: 0; font-weight: 700; font-size: 1.05rem;">✨ Génération du menu</h3>
                        <button onclick="state.showGenModal=false;render();" style="background:none;border:none;font-size:1.2rem;cursor:pointer;color:#999;">✕</button>
                    </div>
                    <div class="modal-body" style="padding:0.8rem;">
                        <div style="margin-bottom: 0.8rem;">
                            <label class="label">💰 Budget hebdo (€)</label>
                            <input type="number" class="input" placeholder="Illimité" value="${cfg.budget}" oninput="state._genConfig.budget=this.value" style="max-width:150px;">
                        </div>

                        <div style="display:flex;gap:0.6rem;margin-bottom:0.8rem;flex-wrap:wrap;">
                            <div style="flex:1;min-width:130px;">
                                <label class="label" style="font-size:0.7rem;">🍽️ Déjeuner</label>
                                <div style="display:flex;flex-wrap:wrap;gap:0.2rem;margin-top:0.2rem;">${structButtons('Déjeuner')}</div>
                            </div>
                            <div style="flex:1;min-width:130px;">
                                <label class="label" style="font-size:0.7rem;">🌙 Dîner</label>
                                <div style="display:flex;flex-wrap:wrap;gap:0.2rem;margin-top:0.2rem;">${structButtons('Dîner')}</div>
                            </div>
                        </div>

                        <div>
                            <label class="label" style="margin-bottom:0.2rem;">📅 Qui mange quand — <span style="color:var(--teal);font-weight:700;">${totalSlots} créneaux</span></label>
                            <p style="font-size:0.6rem;color:#9CA3AF;margin:0 0 0.4rem;">Pré-rempli depuis vos préférences. Modifiez si besoin.</p>
                        </div>

                        ${days.map(d => {
                            const on = cfg.activeDays[d];
                            const nbP = on ? mealTypes.reduce((s,mt) => s + (cfg.participants[d]?.[mt]||[]).length, 0) : 0;
                            return `<div style="margin-bottom:0.35rem;border-radius:8px;overflow:hidden;box-shadow:${on?'0 1px 4px rgba(0,0,0,0.08)':'none'};border:1.5px solid ${on?'var(--teal)':'#E8ECEA'};opacity:${on?1:0.45};transition:all 0.15s;">
                                <div style="display:flex;align-items:center;justify-content:space-between;padding:0.3rem 0.5rem;background:${on?'linear-gradient(135deg,#E6F2F0,#D4EDDA)':'#F8FAF9'};cursor:pointer;" onclick="toggleGenDay('${d}')">
                                    <span style="font-weight:700;font-size:0.82rem;">${on?'✅':'⬜'} ${d}</span>
                                    ${on ? `<span style="font-size:0.58rem;color:var(--teal-dark);">${nbP} participations</span>` : ''}
                                </div>
                                ${on ? `<div style="padding:0.2rem 0.3rem;background:white;">
                                    <table style="width:100%;font-size:0.6rem;border-collapse:collapse;">
                                        <tr>
                                            <td style="width:24px;"></td>
                                            ${state.familyMembers.map(m => `<td style="text-align:center;padding:0.1rem;font-weight:600;font-size:0.56rem;color:#666;">${m.name.length>5?m.name.substring(0,4)+'.':m.name}</td>`).join('')}
                                        </tr>
                                        ${mealTypes.map(mt => `<tr>
                                            <td style="padding:0.1rem;font-size:0.65rem;">${mtIcons[mt]||''}</td>
                                            ${state.familyMembers.map(m => {
                                                const isIn = (cfg.participants[d]?.[mt]||[]).includes(m.id);
                                                return `<td style="text-align:center;padding:0.08rem;">
                                                    <button onclick="toggleGenParticipant('${d}','${mt}',${m.id})" style="width:20px;height:20px;border-radius:4px;border:1.5px solid ${isIn?'var(--teal)':'#DDD'};background:${isIn?'var(--teal)':'white'};cursor:pointer;font-size:0.55rem;padding:0;line-height:1;color:white;transition:all 0.1s;">${isIn?'✓':''}</button>
                                                </td>`;
                                            }).join('')}
                                        </tr>`).join('')}
                                    </table>
                                </div>` : ''}
                            </div>`;
                        }).join('')}
                    </div>
                    <div class="modal-footer" style="padding:0.6rem 0.8rem;">
                        <button class="btn btn-primary" style="width:100%;justify-content:center;padding:0.65rem;font-size:0.9rem;" onclick="state.showGenModal=false;executeGeneration();">✨ Générer ${totalSlots} créneaux</button>
                    </div>
                </div>
            </div>`;
        }

        // Step 2: actual generation via server-side RPC
        async function executeGeneration() {
            if (!await checkSession()) return;
            const cfg = state._genConfig;

            // Save gen preferences locally
            try {
                localStorage.setItem('repasio_gen_prefs', JSON.stringify({
                    budget: cfg.budget || '',
                    mealStructure: cfg.mealStructure
                }));
            } catch(e) {}

            state._generating = true; 
            state._genStep = 0;
            state._genTimer = setInterval(() => { state._genStep++; render(); }, 2500);
            render();

            try {
                const { data, error } = await db.rpc('generate_menu', {
                    p_budget: parseFloat(cfg.budget) || 0,
                    p_meal_structure: cfg.mealStructure,
                    p_active_days: cfg.activeDays,
                    p_participants: cfg.participants
                });

                console.log('[gen] RPC response:', { data, error });
                if (error) throw new Error(error.message || JSON.stringify(error));

                await loadWeeklyMeals();
                await loadSlotParticipants();

                if (!data || data.error) {
                    showToast('⚠️ ' + (data?.error || 'Erreur serveur'), 5000);
                } else if (data.added === 0) {
                    showToast('⚠️ Aucun repas généré. Vérifiez vos préférences (onglet ⚙️)', 6000);
                } else {
                    let msg = `✨ ${data.added} repas ajoutés`;
                    if (data.added_site > 0) msg += ` (${data.added_user} perso, ${data.added_site} site)`;
                    if (data.running_cost > 0 && parseFloat(cfg.budget) > 0) msg += ` • Budget: ~${data.running_cost}€/${cfg.budget}€`;
                    if (data.skipped > 0) msg += ` • ${data.skipped} sautés`;
                    const seasonLabels = {winter:'❄️ Hiver',spring:'🌸 Printemps',summer:'☀️ Été',autumn:'🍂 Automne'};
                    msg += ` • ${seasonLabels[data.season] || ''}`;
                    showToast(msg, 5000);
                }
            } catch(e) {
                console.error('[generation] error:', e);
                showToast('Erreur génération: ' + (e.message || e));
            } finally {
                state._generating = false;
                if (state._genTimer) { clearInterval(state._genTimer); state._genTimer = null; }
            }
            render();
        }

        // ============================================
        // Calculs coûts
        // ============================================
        // Unit conversion: convert quantity+unit to grams equivalent for calculations
        function toGrams(quantity, unit) {
            const q = parseFloat(quantity) || 0;
            const conversions = {
                'g': 1, 'kg': 1000, 'ml': 1, 'l': 1000, 'L': 1000,
                'càs': 15, 'càc': 5, 'tbsp': 15, 'tsp': 5,
                'pièce': 100, 'piece': 100, 'sachet': 11, // 1 sachet levure ≈ 11g
                'pincée': 1, 'gousse': 5, 'tranche': 30,
                'verre': 200, 'tasse': 250, 'bol': 300
            };
            return q * (conversions[unit] || 1);
        }

        // Smart display: convert g/ml to practical units for shopping/display
        function formatQty(quantity, unit, ingredientName) {
            const q = parseFloat(quantity) || 0;
            if (q === 0) return '0 ' + unit;
            const name = (ingredientName || '').toLowerCase();
            // If already in practical unit, keep it
            if (['pièce','piece','sachet','càs','càc','gousse','tranche','verre'].includes(unit))
                return (q % 1 === 0 ? q : q.toFixed(1)) + ' ' + unit;
            if (unit === 'g' || unit === 'ml') {
                if (name.includes('ail')) { const n = Math.max(1, Math.round(q / 5)); return n + (n > 1 ? ' gousses' : ' gousse'); }
                if (name.includes('oeuf') || name.includes('œuf')) { const n = Math.max(1, Math.round(q / 60)); return n + ' pièce' + (n > 1 ? 's' : ''); }
                if (name.includes('oignon')) { const n = Math.max(1, Math.round(q / 150)); return n + ' pièce' + (n > 1 ? 's' : ''); }
                if (name.includes('citron') || name.includes('orange') || name.includes('pomme') && !name.includes('terre') || name.includes('banane')) { const n = Math.max(1, Math.round(q / 100)); return n + ' pièce' + (n > 1 ? 's' : ''); }
                if (name.includes('carotte')) { const n = Math.max(1, Math.round(q / 120)); return n + ' pièce' + (n > 1 ? 's' : ''); }
                if (name.includes('poireau')) { const n = Math.max(1, Math.round(q / 200)); return n + ' pièce' + (n > 1 ? 's' : ''); }
                if (name.includes('tomate') && !name.includes('concentr') && !name.includes('pelé')) { const n = Math.max(1, Math.round(q / 150)); return n + ' pièce' + (n > 1 ? 's' : ''); }
                if (name.includes('courgette') || name.includes('aubergine') || name.includes('concombre') || name.includes('poivron')) { const n = Math.max(1, Math.round(q / 200)); return n + ' pièce' + (n > 1 ? 's' : ''); }
                if (name.includes('patate') || name.includes('pomme de terre') || name.includes('butternut')) { const n = Math.max(1, Math.round(q / 200)); return n + ' pièce' + (n > 1 ? 's' : ''); }
                if (name.includes('levure')) { const n = Math.round(q / 11 * 10) / 10; return n + ' sachet' + (n > 1 ? 's' : ''); }
                if (name.includes('bouillon')) { const n = Math.max(1, Math.round(q / 10)); return n + ' cube' + (n > 1 ? 's' : ''); }
                if (unit === 'g' && q >= 1000) return (q / 1000).toFixed(1).replace('.0', '') + ' kg';
                if (unit === 'ml' && q >= 1000) return (q / 1000).toFixed(1).replace('.0', '') + ' L';
                if (q < 5 && (name.includes('sel') || name.includes('poivre') || name.includes('cannelle') || name.includes('cumin') || name.includes('paprika') || name.includes('curry'))) return Math.max(1, Math.round(q / 5)) + ' càc';
            }
            if (q >= 10) return Math.round(q) + ' ' + unit;
            return (q % 1 === 0 ? q : q.toFixed(1)) + ' ' + unit;
        }

        function getRecipeCost(recipe) { return (recipe?.ingredients || []).reduce((s, i) => s + ((i.price || 0) * toGrams(i.quantity, i.unit) / 100), 0); }
        function getRecipeCostPerPortion(recipe) { return getRecipeCost(recipe) / (recipe.servings || 1); }
        function getSlotTotalPortions(day, mealType) {
            const parts = getParticipantsForSlot(day, mealType);
            if (parts.length === 0) return 1;
            return parts.reduce((s, p) => {
                const member = state.familyMembers.find(x => x.id === p.member_id);
                return s + (member ? estimatePortions(member) : 1);
            }, 0);
        }
        function getSlotCost(day, mealType) {
            const totalPortions = getSlotTotalPortions(day, mealType);
            return getMealsForSlot(day, mealType).reduce((t, meal) => {
                const r = findRecipeById(meal);
                if (!r) return t;
                return t + getRecipeCostPerPortion(r) * totalPortions;
            }, 0);
        }
        function getSlotKcalPerPerson(day, mealType) {
            return getMealsForSlot(day, mealType).reduce((t, meal) => {
                const r = findRecipeById(meal);
                if (!r) return t;
                const totalKcal = (r.ingredients||[]).reduce((s,i) => s + ((i.kcal||0)*toGrams(i.quantity,i.unit)/100), 0);
                return t + totalKcal / (r.servings || 1);
            }, 0);
        }
        function getWeeklyTotalCost() {
            let t = 0;
            ['Lun','Mar','Mer','Jeu','Ven','Sam','Dim'].forEach(d => ['Petit-déjeuner','Déjeuner','Goûter','Dîner'].forEach(mt => t += getSlotCost(d, mt)));
            return t;
        }

        // ============================================
        // Shopping List + PDF
        // ============================================
        // Convertir quantité stock vers unité cible (g, ml, pièce)
        function convertStockToUnit(stockQty, stockUnit, targetUnit) {
            // Normalize units
            const norm = (u) => (u || 'g').toLowerCase().trim()
                .replace('kilo','kg').replace('kilogramme','kg').replace('gramme','g')
                .replace('litre','L').replace('litres','L').replace('millilitre','ml')
                .replace('pièce','pce').replace('piece','pce').replace('pièces','pce').replace('unité','pce').replace('unite','pce');
            const su = norm(stockUnit);
            const tu = norm(targetUnit);
            if (su === tu) return stockQty;
            // kg <-> g
            if (su === 'kg' && tu === 'g') return stockQty * 1000;
            if (su === 'g' && tu === 'kg') return stockQty / 1000;
            // L <-> ml
            if (su === 'l' && tu === 'ml') return stockQty * 1000;
            if (su === 'ml' && tu === 'l') return stockQty / 1000;
            // cl <-> ml
            if (su === 'cl' && tu === 'ml') return stockQty * 10;
            if (su === 'ml' && tu === 'cl') return stockQty / 10;
            // cl <-> l
            if (su === 'cl' && tu === 'l') return stockQty / 100;
            if (su === 'l' && tu === 'cl') return stockQty * 100;
            // Same family fallback
            return stockQty;
        }

        function buildShoppingList() {
            // Use pre-validation stock snapshot if available (so PDF shows correct "to buy" amounts)
            const stockSource = state._stockBeforeValidation || state.stockItems;
            const getStock = (ingredientId) => stockSource.filter(s => s.ingredient_id == ingredientId);
            
            const totals = {};
            const recipeDetails = [];
            state.weeklyMeals.forEach(meal => {
                const recipe = findRecipeById(meal);
                if (!recipe) return;
                const parts = getParticipantsForSlot(meal.day, meal.meal_type);
                const pNames = parts.map(p => state.familyMembers.find(x => x.id === p.member_id)?.name || '').filter(Boolean);
                const count = parts.length || 1;
                const mult = count / recipe.servings;
                recipeDetails.push({ name: recipe.name, day: meal.day, mealType: meal.meal_type, participants: pNames, portions: count });
                (recipe.ingredients || []).forEach(ing => {
                    if (!ing.ingredient_name) return;
                    const k = ing.ingredient_name;
                    if (!totals[k]) totals[k] = { name: k, quantity: 0, unit: ing.unit, price: ing.price || 0, ingredient_id: ing.ingredient_id };
                    totals[k].quantity += (ing.quantity || 0) * mult;
                });
            });
            return { items: Object.values(totals).map(i => {
                const stocks = getStock(i.ingredient_id);
                const totalStockConverted = stocks.reduce((s, x) => s + convertStockToUnit(x.quantity || 0, x.unit, i.unit), 0);
                const needed = Math.max(0, i.quantity - totalStockConverted);
                const fullyInStock = totalStockConverted >= i.quantity;
                return { ...i, totalCost: toGrams(i.quantity, i.unit) / 100 * i.price, stockQty: totalStockConverted, needed, fullyInStock, toBuyCost: toGrams(needed, i.unit) / 100 * i.price };
            }).sort((a, b) => a.fullyInStock !== b.fullyInStock ? (a.fullyInStock ? 1 : -1) : a.name.localeCompare(b.name)), details: recipeDetails };
        }

        function downloadAllInOnePDF() {
            if (state.weeklyMeals.length === 0) { showToast('Aucun repas planifié !'); return; }
            
            const days = ['Lun','Mar','Mer','Jeu','Ven','Sam','Dim'];
            const meals = [{type:'Petit-déjeuner',l:'Petit-Déj'},{type:'Déjeuner',l:'Déjeuner'},{type:'Goûter',l:'Goûter'},{type:'Dîner',l:'Dîner'}];
            const wt = getWeeklyTotalCost();
            const dateStr = new Date().toLocaleDateString('fr-FR', { day:'numeric', month:'long', year:'numeric' });
            
            let html = `<div style="font-family:Lexend,sans-serif;padding:15px;font-size:11px;">`;
            
            // ===== SECTION 1: PLANNING =====
            html += `<div style="text-align:center;margin-bottom:12px;">
                <div style="display:inline-block;background:linear-gradient(135deg,#2D6A63,#3D8B7A);color:white;padding:4px 14px;border-radius:20px;font-size:12px;font-weight:700;letter-spacing:0.5px;margin-bottom:8px;">REPASIO</div>
                <h1 style="color:#2D6A63;margin:0;font-size:20px;">📅 Planning de la Semaine</h1>
                <p style="color:#666;font-size:11px;margin:4px 0;">${dateStr} • Budget: <strong style="color:#2D6A63;">${wt.toFixed(2)}€</strong> • ${state.weeklyMeals.length} repas</p>
            </div>
            <table style="width:100%;border-collapse:collapse;font-size:9px;margin-bottom:10px;">
            <tr><th style="background:#333;color:white;padding:5px;border:1px solid #ddd;font-size:8px;">Repas</th>
            ${days.map(d => `<th style="background:#2D6A63;color:white;padding:5px;border:1px solid #ddd;">${d}</th>`).join('')}</tr>`;
            
            meals.forEach(meal => {
                html += `<tr><td style="background:#F8FAF9;font-weight:bold;padding:4px;border:1px solid #ddd;font-size:8px;">${meal.l}</td>`;
                days.forEach(day => {
                    const sm = getMealsForSlot(day, meal.type);
                    const parts = getParticipantsForSlot(day, meal.type);
                    const sc = getSlotCost(day, meal.type);
                    const kcalPP = Math.round(getSlotKcalPerPerson(day, meal.type));
                    html += `<td style="padding:3px;border:1px solid #ddd;vertical-align:top;font-size:8px;">`;
                    sm.forEach(m => { const r = findRecipeById(m); if(r) html += `<div style="font-weight:600;">• ${r.name}</div>`; });
                    if (parts.length) {
                        const badges = parts.map(p => {
                            const mem = state.familyMembers.find(x => x.id === p.member_id);
                            if (!mem) return '';
                            const portion = estimatePortions(mem);
                            return `${mem.name.charAt(0)}:${Math.round(kcalPP*portion)}kcal`;
                        }).filter(Boolean).join(' ');
                        html += `<div style="color:#888;font-size:7px;margin-top:1px;">${badges}</div>`;
                    }
                    if (sc > 0) html += `<div style="color:#2D6A63;font-size:7px;font-weight:bold;">${sc.toFixed(2)}€</div>`;
                    html += `</td>`;
                });
                html += `</tr>`;
            });
            html += `</table>`;
            
            // ===== SECTION 2: RECETTES =====
            const recs = state.weeklyMeals.map(m => findRecipeById(m)).filter(Boolean);
            const uniqueRecs = [...new Map(recs.map(r => [r.id, r])).values()];
            
            html += `<div style="page-break-before:always;"></div>
            <div style="text-align:center;margin-bottom:12px;">
                <div style="display:inline-block;background:linear-gradient(135deg,#2D6A63,#3D8B7A);color:white;padding:4px 14px;border-radius:20px;font-size:12px;font-weight:700;letter-spacing:0.5px;margin-bottom:8px;">REPASIO</div>
                <h1 style="color:#2D6A63;border-bottom:2px solid #2D6A63;padding-bottom:8px;margin:0 0 15px;font-size:18px;">📖 Recettes de la Semaine (${uniqueRecs.length})</h1>
            </div>`;
            
            uniqueRecs.forEach(r => {
                const tk = (r.ingredients||[]).reduce((s,i) => s + ((i.kcal||0)*toGrams(i.quantity,i.unit)/100), 0);
                const cp = getRecipeCostPerPortion(r);
                const pl = getRecipePlannedInfo(r.id);
                let tp = pl.reduce((s,p) => s + p.nbPersons, 0) || r.servings;
                const mult = tp / r.servings;
                html += `<div style="page-break-inside:avoid;margin:10px 0;padding:12px;border:1px solid #E8ECEA;border-radius:6px;">
                    <h2 style="color:#333;margin:0 0 5px;font-size:14px;">${r.name}${r._isSite ? ' <span style="background:#2D6A63;color:white;padding:1px 5px;border-radius:3px;font-size:8px;">REPASIO</span>' : ''}</h2>
                    <p style="color:#666;font-size:10px;margin:0 0 5px;">${(r.preptime||0)+(r.cooktime||0)}min | ${tp} pers. | ~${Math.round(tk/r.servings)} kcal/pers | ${cp.toFixed(2)}€/pers</p>
                    ${pl.length ? `<div style="background:#E6F2F0;color:#235550;padding:5px 8px;border-radius:4px;font-size:9px;margin:5px 0;">${pl.map(s => `<strong>${s.day}</strong> ${s.mealType}`).join(' • ')} — ${tp} portions</div>` : ''}
                    <div style="display:flex;gap:15px;margin-top:8px;">
                        <div style="flex:1;"><h4 style="margin:0 0 4px;color:#2D6A63;font-size:10px;">Ingrédients</h4>
                        <ul style="margin:0;padding-left:14px;font-size:10px;">${(r.ingredients||[]).map(i => `<li style="margin-bottom:2px;">${i.ingredient_name}: <strong>${formatQty((i.quantity||0)*mult, i.unit, i.ingredient_name)}</strong></li>`).join('')||'<li>—</li>'}</ul></div>
                        ${r.instructions ? `<div style="flex:2;"><h4 style="margin:0 0 4px;color:#2D6A63;font-size:10px;">Préparation</h4><div style="font-size:10px;white-space:pre-wrap;line-height:1.5;">${r.instructions}</div></div>` : ''}
                    </div>
                </div>`;
            });
            
            // ===== SECTION 3: LISTE DE COURSES =====
            const { items } = buildShoppingList();
            const toBuyItems = items.filter(i => !i.fullyInStock);
            const inStockItems = items.filter(i => i.fullyInStock);
            const totalToBuy = items.reduce((s, i) => s + i.toBuyCost, 0);
            const totalBrut = items.reduce((s, i) => s + i.totalCost, 0);
            
            html += `<div style="page-break-before:always;"></div>
            <div style="text-align:center;margin-bottom:12px;">
                <div style="display:inline-block;background:linear-gradient(135deg,#2D6A63,#3D8B7A);color:white;padding:4px 14px;border-radius:20px;font-size:12px;font-weight:700;letter-spacing:0.5px;margin-bottom:8px;">REPASIO</div>
                <h1 style="color:#2D6A63;border-bottom:2px solid #2D6A63;padding-bottom:8px;margin:0 0 15px;font-size:18px;">🛒 Liste de Courses</h1>
            </div>
            <p style="text-align:center;color:#666;font-size:11px;margin-bottom:12px;">${toBuyItems.length} article(s) à acheter${inStockItems.length > 0 ? ' • ' + inStockItems.length + ' en stock' : ''}</p>
            <table style="width:100%;border-collapse:collapse;font-size:11px;">
            <tr><th style="text-align:left;padding:6px;border-bottom:2px solid #2D6A63;color:#2D6A63;">Article</th>
            <th style="text-align:center;padding:6px;border-bottom:2px solid #2D6A63;">Besoin</th>
            <th style="text-align:center;padding:6px;border-bottom:2px solid #2D6A63;">À acheter</th>
            <th style="text-align:right;padding:6px;border-bottom:2px solid #2D6A63;">Prix</th>
            <th style="text-align:center;padding:6px;border-bottom:2px solid #2D6A63;width:25px;">✓</th></tr>`;
            
            items.forEach(item => {
                const partial = item.stockQty > 0 && !item.fullyInStock;
                html += `<tr style="${item.fullyInStock ? 'color:#999;' : ''}">
                    <td style="padding:5px;border-bottom:1px solid #eee;">${item.name}${item.fullyInStock ? ' <span style="background:#D4EDDA;color:#155724;padding:1px 4px;border-radius:2px;font-size:8px;font-weight:600;">STOCK</span>' : ''}${partial ? ' <span style="background:#FFF3CD;color:#856404;padding:1px 4px;border-radius:2px;font-size:8px;">PARTIEL</span>' : ''}</td>
                    <td style="text-align:center;padding:5px;border-bottom:1px solid #eee;color:#999;font-size:10px;">${formatQty(item.quantity, item.unit, item.name)}</td>
                    <td style="text-align:center;padding:5px;border-bottom:1px solid #eee;font-weight:${item.fullyInStock?'400':'600'};">${item.fullyInStock ? '—' : formatQty(item.needed, item.unit, item.name)}</td>
                    <td style="text-align:right;padding:5px;border-bottom:1px solid #eee;${item.fullyInStock?'text-decoration:line-through;':''}">${(item.fullyInStock ? item.totalCost : item.toBuyCost).toFixed(2)}€</td>
                    <td style="text-align:center;padding:5px;border-bottom:1px solid #eee;">${item.fullyInStock ? '✓' : '☐'}</td>
                </tr>`;
            });
            
            html += `</table>
            <div style="margin-top:12px;padding:10px;background:#E6F2F0;border-radius:6px;display:flex;justify-content:space-between;align-items:center;">
                <div><strong style="color:#2D6A63;">Total à acheter</strong>
                ${inStockItems.length > 0 ? '<br><span style="font-size:9px;color:#666;">Brut: '+totalBrut.toFixed(2)+'€ — Économie stock: '+(totalBrut-totalToBuy).toFixed(2)+'€</span>' : ''}</div>
                <span style="font-size:18px;font-weight:700;color:#2D6A63;">${totalToBuy.toFixed(2)}€</span>
            </div>`;
            
            html += `</div>`;
            
            // Open in new window for print/save as PDF
            const printWin = window.open('', '_blank');
            if (!printWin) { showToast('⚠️ Autorisez les pop-ups pour générer le PDF'); return; }
            printWin.document.write(`<!DOCTYPE html><html><head><meta charset="utf-8">
                <title>Repasio - Semaine du ${dateStr}</title>
                <link href="https://fonts.googleapis.com/css2?family=Lexend:wght@300;400;500;600;700&display=swap" rel="stylesheet">
                <style>
                    body { font-family: Lexend, sans-serif; margin: 0; padding: 0; }
                    @media print { .no-print { display: none !important; } @page { margin: 8mm; } }
                    .print-bar { background: #2D6A63; color: white; padding: 10px 20px; display: flex; justify-content: space-between; align-items: center; }
                    .print-bar button { background: white; color: #2D6A63; border: none; padding: 8px 16px; border-radius: 6px; font-weight: 600; cursor: pointer; font-family: inherit; font-size: 14px; }
                </style>
            </head><body>
                <div class="no-print print-bar">
                    <span style="font-weight:600;">Repasio — Aperçu PDF</span>
                    <div><button onclick="window.print()">🖨️ Imprimer / Enregistrer PDF</button></div>
                </div>
                ${html}
            </body></html>`);
            printWin.document.close();

            // Sauvegarder dans l'historique PDF (30 jours)
            savePdfToHistory(dateStr, html);
            showToast('📥 Aperçu PDF ouvert');
        }

        // ============================================
        // Historique PDF (30 jours)
        // ============================================
        async function savePdfToHistory(label, htmlContent) {
            try {
                const nbMeals = state.weeklyMeals.length;
                const cost = getWeeklyTotalCost();
                await db.from('user_pdfs').insert([{
                    user_id: state.user.id,
                    label: 'Semaine du ' + label,
                    html_content: htmlContent,
                    nb_meals: nbMeals,
                    total_cost: Math.round(cost * 100) / 100
                }]);
                // Cleanup > 30 jours
                const cutoff = new Date();
                cutoff.setDate(cutoff.getDate() - 30);
                await db.from('user_pdfs').delete().eq('user_id', state.user.id).lt('created_at', cutoff.toISOString());
                await loadPdfHistory();
                render();
            } catch(e) { console.warn('[savePdf]', e); }
        }

        async function loadPdfHistory() {
            try {
                const { data } = await db.from('user_pdfs').select('id, label, nb_meals, total_cost, created_at').eq('user_id', state.user.id).order('created_at', { ascending: false }).limit(20);
                state._pdfHistory = data || [];
            } catch(e) { state._pdfHistory = []; }
        }

        async function openPdfFromHistory(pdfId) {
            showToast('Chargement du PDF...', 2000);
            try {
                const { data, error } = await db.from('user_pdfs').select('html_content, label').eq('id', pdfId).single();
                if (error) { showToast('Erreur: ' + error.message); return; }
                if (!data?.html_content) { showToast('PDF vide ou introuvable'); return; }
                const printWin = window.open('', '_blank');
                if (!printWin) { showToast('⚠️ Pop-up bloqué ! Autorisez les pop-ups pour ce site.'); return; }
                printWin.document.write(`<!DOCTYPE html><html><head><meta charset="utf-8">
                    <title>Repasio - ${data.label || 'PDF'}</title>
                    <link href="https://fonts.googleapis.com/css2?family=Lexend:wght@300;400;500;600;700&display=swap" rel="stylesheet">
                    <style>
                        body { font-family: Lexend, sans-serif; margin: 0; padding: 0; }
                        @media print { .no-print { display: none !important; } @page { margin: 8mm; } }
                        .print-bar { background: #2D6A63; color: white; padding: 10px 20px; display: flex; justify-content: space-between; align-items: center; }
                        .print-bar button { background: white; color: #2D6A63; border: none; padding: 8px 16px; border-radius: 6px; font-weight: 600; cursor: pointer; font-family: inherit; font-size: 14px; }
                    </style>
                </head><body>
                    <div class="no-print print-bar">
                        <span style="font-weight:600;">Repasio — ${data.label || 'PDF'}</span>
                        <div><button onclick="window.print()">🖨️ Imprimer / Enregistrer PDF</button></div>
                    </div>
                    ${data.html_content}
                </body></html>`);
                printWin.document.close();
            } catch(e) { showToast('Erreur: ' + (e.message || e)); console.error('[openPdf]', e); }
        }

        async function deletePdfFromHistory(pdfId) {
            if (!confirm('Supprimer ce PDF ?')) return;
            await db.from('user_pdfs').delete().eq('id', pdfId);
            await loadPdfHistory();
            render();
        }

        function renderPdfHistory() {
            const pdfs = state._pdfHistory || [];
            if (pdfs.length === 0) return '';
            return `<div style="margin-top:1rem;padding-top:0.8rem;border-top:1px solid #E8ECEA;">
                <h4 style="font-size:0.82rem;font-weight:600;margin:0 0 0.5rem;color:var(--charcoal);">📄 Mes PDF (30 derniers jours)</h4>
                ${pdfs.map(p => {
                    const date = new Date(p.created_at).toLocaleDateString('fr-FR', { day:'numeric', month:'short', hour:'2-digit', minute:'2-digit' });
                    return `<div style="display:flex;justify-content:space-between;align-items:center;padding:0.4rem 0;border-bottom:1px solid #F0F3F2;">
                        <div style="cursor:pointer;flex:1;" onclick="openPdfFromHistory(${p.id})">
                            <div style="font-weight:600;font-size:0.78rem;color:var(--teal);">${p.label}</div>
                            <div style="font-size:0.65rem;color:#999;">${date} • ${p.nb_meals || '?'} repas • ${(p.total_cost||0).toFixed(2)}€</div>
                        </div>
                        <button class="btn btn-delete btn-sm" onclick="deletePdfFromHistory(${p.id})" style="font-size:0.6rem;">🗑️</button>
                    </div>`;
                }).join('')}
            </div>`;
        }

        function downloadShoppingPDF() {
            if (state.weeklyMeals.length === 0) { showToast('Aucun repas planifié !'); return; }
            const { items } = buildShoppingList();
            const toBuyItems = items.filter(i => !i.fullyInStock);
            const inStockItems = items.filter(i => i.fullyInStock);
            const totalToBuy = items.reduce((s, i) => s + i.toBuyCost, 0);
            const totalBrut = items.reduce((s, i) => s + i.totalCost, 0);
            
            let html = `<div style="font-family: Lexend, sans-serif; padding: 25px; max-width: 700px; margin: 0 auto;">
                <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 20px; padding-bottom: 15px; border-bottom: 3px solid #2D6A63;">
                    <div><h1 style="color: #2D6A63; margin: 0; font-size: 22px;">Liste de Courses</h1>
                    <p style="color: #666; font-size: 12px; margin: 3px 0 0;">${toBuyItems.length} articles à acheter${inStockItems.length > 0 ? ' • ' + inStockItems.length + ' déjà en stock' : ''}</p></div>
                </div>`;
            
            // Articles à acheter
            html += `<table style="width: 100%; border-collapse: collapse; font-size: 12px;">
                <tr><th style="text-align: left; padding: 8px; border-bottom: 2px solid #2D6A63; color: #2D6A63;">Article</th>
                <th style="text-align: center; padding: 8px; border-bottom: 2px solid #2D6A63;">Besoin</th>
                <th style="text-align: center; padding: 8px; border-bottom: 2px solid #2D6A63;">À acheter</th>
                <th style="text-align: right; padding: 8px; border-bottom: 2px solid #2D6A63;">Prix</th>
                <th style="text-align: center; padding: 8px; border-bottom: 2px solid #2D6A63; width: 30px;">✓</th></tr>`;
            
            items.forEach(item => {
                const hasPartialStock = item.stockQty > 0 && !item.fullyInStock;
                const style = item.fullyInStock ? 'color: #999;' : '';
                html += `<tr style="${style}">
                    <td style="padding: 6px 8px; border-bottom: 1px solid #eee;">
                        ${item.name}
                        ${item.fullyInStock ? ' <span style="background: #D4EDDA; color: #155724; padding: 1px 6px; border-radius: 3px; font-size: 9px; font-weight: 600;">EN STOCK</span>' : ''}
                        ${hasPartialStock ? ' <span style="background: #FFF3CD; color: #856404; padding: 1px 6px; border-radius: 3px; font-size: 9px; font-weight: 600;">STOCK PARTIEL: ' + Math.round(item.stockQty) + ' ' + item.unit + '</span>' : ''}
                    </td>
                    <td style="text-align: center; padding: 6px 8px; border-bottom: 1px solid #eee; color: #999; font-size: 11px;">${formatQty(item.quantity, item.unit, item.name)}</td>
                    <td style="text-align: center; padding: 6px 8px; border-bottom: 1px solid #eee; font-weight: ${item.fullyInStock ? '400' : '600'};">${item.fullyInStock ? '—' : formatQty(item.needed, item.unit, item.name)}</td>
                    <td style="text-align: right; padding: 6px 8px; border-bottom: 1px solid #eee; ${item.fullyInStock ? 'text-decoration: line-through;' : ''}">${item.fullyInStock ? item.totalCost.toFixed(2) : item.toBuyCost.toFixed(2)}€</td>
                    <td style="text-align: center; padding: 6px 8px; border-bottom: 1px solid #eee;">${item.fullyInStock ? '✓' : '☐'}</td>
                </tr>`;
            });
            
            html += `</table>
                <div style="margin-top: 18px; padding: 14px; background: #E6F2F0; border-radius: 8px; display: flex; justify-content: space-between; align-items: center;">
                    <div><strong style="color: #2D6A63;">Total à acheter</strong>
                    ${inStockItems.length > 0 ? '<br><span style="font-size: 10px; color: #666;">Total brut: ' + totalBrut.toFixed(2) + '€ — Économie stock: ' + (totalBrut - totalToBuy).toFixed(2) + '€</span>' : ''}</div>
                    <span style="font-size: 20px; font-weight: 700; color: #2D6A63;">${totalToBuy.toFixed(2)}€</span>
                </div>
            </div>`;
            
            const el = document.createElement('div'); el.style.cssText = 'position:absolute;left:0;top:0;width:900px;'; el.innerHTML = html; document.body.appendChild(el);
            html2pdf().set({ margin: 10, filename: 'liste-courses.pdf', image: { type: 'jpeg', quality: 0.98 }, html2canvas: { scale: 2 }, jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' } }).from(el).save().then(() => document.body.removeChild(el));
            showToast('PDF Liste de courses');
        }

        // ============================================
        // Other PDF exports
        // ============================================
        function getRecipePlannedInfo(recipeId) {
            return state.weeklyMeals.filter(m => m.recipe_id == recipeId || m.site_recipe_id == recipeId).map(meal => {
                const parts = getParticipantsForSlot(meal.day, meal.meal_type);
                return { day: meal.day, mealType: meal.meal_type, participants: parts.map(p => state.familyMembers.find(x => x.id === p.member_id)?.name || '').filter(Boolean), nbPersons: parts.length || 1 };
            });
        }

        function printSingleRecipe(recipeId) {
            const r = findRecipeById(recipeId); if (!r) return;
            const planned = getRecipePlannedInfo(recipeId);
            const totalKcal = (r.ingredients || []).reduce((s, i) => s + ((i.kcal||0) * toGrams(i.quantity, i.unit) / 100), 0);
            const cost = getRecipeCostPerPortion(r);
            let adj = r.servings, info = '';
            if (planned.length) {
                adj = planned.reduce((s, p) => s + p.nbPersons, 0);
                info = `<div style="background:#E6F2F0;color:#235550;padding:12px;border-radius:8px;font-size:13px;margin:15px 0;">Planifié: ${planned.map(s => s.day+' ('+s.mealType+')').join(' | ')} — Quantités pour ${adj} portion(s)</div>`;
            }
            const mult = adj / r.servings;
            const html = `<div style="font-family:Lexend,sans-serif;padding:30px;max-width:800px;margin:0 auto;">
                <h1 style="color:#2D6A63;border-bottom:3px solid #2D6A63;padding-bottom:10px;">${r.name}</h1>
                <div style="display:flex;gap:12px;margin:15px 0;flex-wrap:wrap;">
                    <span style="background:#F4F7F6;padding:8px 12px;border-radius:8px;font-size:13px;">${r.preptime+r.cooktime} min</span>
                    <span style="background:#F4F7F6;padding:8px 12px;border-radius:8px;font-size:13px;">${adj} pers.</span>
                    <span style="background:#F4F7F6;padding:8px 12px;border-radius:8px;font-size:13px;">${r.difficulty}</span>
                    <span style="background:#E6F2F0;padding:8px 12px;border-radius:8px;font-size:13px;color:#235550;">~${Math.round(totalKcal/r.servings)} kcal/pers</span>
                    <span style="background:#F0DCC0;padding:8px 12px;border-radius:8px;font-size:13px;color:#C08A3A;">${cost.toFixed(2)}€/pers</span>
                </div>${info}
                <div style="display:grid;grid-template-columns:1fr 2fr;gap:30px;margin-top:20px;">
                    <div><h3 style="color:#333;border-bottom:2px solid #D5DAD8;padding-bottom:8px;">Ingrédients</h3>
                        <ul style="list-style:none;padding:0;">${(r.ingredients||[]).map(i => `<li style="padding:8px 0;border-bottom:1px solid #F0F3F2;"><strong>${i.ingredient_name}</strong>: ${formatQty((i.quantity||0)*mult, i.unit, i.ingredient_name)}</li>`).join('')||'<li>Aucun</li>'}</ul></div>
                    <div><h3 style="color:#333;border-bottom:2px solid #D5DAD8;padding-bottom:8px;">Préparation</h3>
                        <div style="white-space:pre-wrap;line-height:1.8;font-size:14px;">${r.instructions||'Aucune instruction'}</div></div>
                </div></div>`;
            const el = document.createElement('div'); el.style.cssText = 'position:absolute;left:0;top:0;width:900px;'; el.innerHTML = html; document.body.appendChild(el);
            html2pdf().set({ margin: 10, filename: `recette-${r.name.toLowerCase().replace(/\s+/g,'-')}.pdf`, html2canvas:{scale:2}, jsPDF:{unit:'mm',format:'a4'} }).from(el).save().then(() => document.body.removeChild(el));
        }

        function downloadPlanningPDF() {
            const days = ['Lun','Mar','Mer','Jeu','Ven','Sam','Dim'];
            const meals = [{type:'Petit-déjeuner',l:'Pdej'},{type:'Déjeuner',l:'Dej'},{type:'Goûter',l:'Goûter'},{type:'Dîner',l:'Dîner'}];
            const wt = getWeeklyTotalCost();
            let html = `<div style="font-family:Lexend,sans-serif;padding:20px;">
                <h1 style="text-align:center;color:#2D6A63;margin-bottom:5px;">Planning de la Semaine</h1>
                <p style="text-align:center;color:#666;font-size:14px;margin-bottom:20px;">Budget: <strong style="color:#2D6A63;">${wt.toFixed(2)}€</strong> | ${state.weeklyMeals.length} repas</p>
                <table style="width:100%;border-collapse:collapse;font-size:10px;">
                <tr><th style="background:#333;color:white;padding:6px;border:1px solid #ddd;">Repas</th>
                ${days.map(d => `<th style="background:#2D6A63;color:white;padding:6px;border:1px solid #ddd;">${d}</th>`).join('')}</tr>`;
            meals.forEach(meal => {
                html += `<tr><td style="background:#F8FAF9;font-weight:bold;padding:6px;border:1px solid #ddd;font-size:9px;">${meal.l}</td>`;
                days.forEach(day => {
                    const sm = getMealsForSlot(day, meal.type);
                    const pn = getParticipantsForSlot(day, meal.type).map(p => state.familyMembers.find(m => m.id === p.member_id)?.name || '').filter(Boolean);
                    const sc = getSlotCost(day, meal.type);
                    let slotKcal = 0;
                    sm.forEach(m => { const r = findRecipeById(m); if (r) slotKcal += (r.ingredients||[]).reduce((s,i) => s + ((i.kcal||0)*toGrams(i.quantity,i.unit)/100), 0) / (r.servings||1); });
                    html += `<td style="padding:4px;border:1px solid #ddd;vertical-align:top;font-size:9px;">`;
                    sm.forEach(m => { const r = findRecipeById(m); if (r) html += `<div>• ${r.name}</div>`; });
                    if (pn.length) html += `<div style="color:#666;font-size:8px;margin-top:2px;">${pn.join(', ')}</div>`;
                    if (slotKcal > 0) html += `<div style="color:#D9A054;font-size:8px;">${Math.round(slotKcal)} kcal</div>`;
                    if (sc > 0) html += `<div style="color:#2D6A63;font-size:8px;font-weight:bold;">${sc.toFixed(2)}€</div>`;
                    html += `</td>`;
                });
                html += `</tr>`;
            });
            html += `</table></div>`;
            const el = document.createElement('div'); el.style.cssText = 'position:absolute;left:0;top:0;width:900px;'; el.innerHTML = html; document.body.appendChild(el);
            html2pdf().set({ margin:10, filename:'planning-semaine.pdf', html2canvas:{scale:2}, jsPDF:{unit:'mm',format:'a4',orientation:'landscape'} }).from(el).save().then(() => document.body.removeChild(el));
        }

        function downloadRecipesPDF() {
            const recs = state.weeklyMeals.map(m => findRecipeById(m)).filter(Boolean);
            const uniqueRecs = [...new Map(recs.map(r => [r.id, r])).values()];
            if (!uniqueRecs.length) { showToast('Aucune recette dans le planning !'); return; }
            let html = `<div style="font-family:Lexend,sans-serif;padding:20px;"><h1 style="text-align:center;color:#2D6A63;border-bottom:2px solid #2D6A63;padding-bottom:10px;margin-bottom:20px;">Recettes de la Semaine (${uniqueRecs.length})</h1>`;
            uniqueRecs.forEach(r => {
                const tk = (r.ingredients||[]).reduce((s,i) => s + ((i.kcal||0)*toGrams(i.quantity,i.unit)/100), 0);
                const cp = getRecipeCostPerPortion(r);
                const pl = getRecipePlannedInfo(r.id);
                let tp = pl.reduce((s,p) => s + p.nbPersons, 0) || r.servings;
                const mult = tp / r.servings;
                html += `<div style="page-break-inside:avoid;margin:15px 0;padding:15px;border:1px solid #E8ECEA;border-radius:8px;">
                    <h2 style="color:#333;margin:0 0 8px;font-size:16px;">${r.name}</h2>
                    <p style="color:#666;font-size:11px;">${r.preptime+r.cooktime}min | ${tp} pers. | ${r.difficulty} | ~${Math.round(tk/r.servings)}kcal/pers | ${cp.toFixed(2)}€/pers</p>
                    ${pl.length ? `<div style="background:#E6F2F0;color:#235550;padding:8px;border-radius:6px;font-size:10px;margin:8px 0;">${pl.map(s => `<strong>${s.day}</strong> (${s.mealType})`).join(' | ')} — Qtés pour <strong>${tp}</strong> portions</div>` : ''}
                    <h4 style="margin:12px 0 6px;color:#2D6A63;font-size:12px;">Ingrédients:</h4>
                    <ul style="margin:0;padding-left:18px;font-size:11px;columns:2;">${(r.ingredients||[]).map(i => `<li style="margin-bottom:3px;">${i.ingredient_name}: <strong>${formatQty((i.quantity||0)*mult, i.unit, i.ingredient_name)}</strong></li>`).join('')||'<li>Aucun</li>'}</ul>
                    ${r.instructions ? `<h4 style="margin:12px 0 6px;color:#2D6A63;font-size:12px;">Préparation:</h4><p style="font-size:11px;white-space:pre-wrap;line-height:1.5;">${r.instructions}</p>` : ''}
                </div>`;
            });
            html += `</div>`;
            const el = document.createElement('div'); el.style.cssText = 'position:absolute;left:0;top:0;width:900px;'; el.innerHTML = html; document.body.appendChild(el);
            html2pdf().set({ margin:10, filename:'recettes-semaine.pdf', html2canvas:{scale:2}, jsPDF:{unit:'mm',format:'a4'} }).from(el).save().then(() => document.body.removeChild(el));
        }

        // ============================================
        // Subscription management modal
        // ============================================
        function renderSubscriptionModal() {
            if (!state.showSubscriptionModal) return '';
            const p = state.profile;
            const premium = isPremium();
            const status = p?.subscription_status || 'free';
            const renewDate = p?.subscription_end || p?.trial_end;
            const renewStr = renewDate ? new Date(renewDate).toLocaleDateString('fr-FR', { day: 'numeric', month: 'long', year: 'numeric' }) : '—';
            
            let statusLabel, statusColor, statusIcon;
            if (status === 'active') { statusLabel = 'Premium actif'; statusColor = 'var(--teal)'; statusIcon = '✅'; }
            else if (status === 'trial') { statusLabel = 'Période d\'essai'; statusColor = 'var(--gold)'; statusIcon = '⏳'; }
            else if (status === 'cancelled') { statusLabel = 'Résilié'; statusColor = '#E53E3E'; statusIcon = '❌'; }
            else { statusLabel = 'Gratuit'; statusColor = '#6B7280'; statusIcon = '📋'; }

            return `<div class="modal-overlay" onclick="if(event.target===this){state.showSubscriptionModal=false;render();}">
                <div class="modal" style="max-width: 440px;">
                    <div class="modal-header">
                        <h3 style="margin: 0; font-weight: 700; font-size: 1.05rem;">💳 Mon abonnement</h3>
                        <button onclick="state.showSubscriptionModal=false;render();" style="background: none; border: none; font-size: 1.2rem; cursor: pointer; color: #999;">✕</button>
                    </div>
                    <div class="modal-body">
                        <div style="background: #F8FAF9; border-radius: var(--radius-md); padding: 1.15rem; margin-bottom: 1rem; border-left: 4px solid ${statusColor};">
                            <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.6rem;">
                                <span style="font-size: 1.3rem;">${statusIcon}</span>
                                <div>
                                    <div style="font-weight: 700; font-size: 0.95rem; color: ${statusColor};">${statusLabel}</div>
                                    <div style="font-size: 0.72rem; color: #6B7280;">${state.user?.email}</div>
                                </div>
                            </div>
                            ${premium || status === 'cancelled' ? `
                                <div style="display: flex; justify-content: space-between; padding: 0.5rem 0; border-top: 1px solid #E8ECEA; font-size: 0.8rem;">
                                    <span style="color: #6B7280;">${status === 'cancelled' ? 'Accès jusqu\'au' : 'Prochain renouvellement'}</span>
                                    <span style="font-weight: 600;">${renewStr}</span>
                                </div>
                            ` : ''}
                            ${status === 'active' && p?.stripe_plan ? `
                                <div style="display: flex; justify-content: space-between; padding: 0.5rem 0; border-top: 1px solid #E8ECEA; font-size: 0.8rem;">
                                    <span style="color: #6B7280;">Formule</span>
                                    <span style="font-weight: 600;">${p.stripe_plan === 'yearly' ? 'Annuel (34,99€/an)' : 'Mensuel (3,99€/mois)'}</span>
                                </div>
                            ` : ''}
                        </div>
                        
                        ${!premium && status !== 'cancelled' ? `
                            <button class="btn btn-generate" style="width: 100%; justify-content: center; padding: 0.75rem; font-size: 0.88rem; margin-bottom: 0.6rem;" onclick="state.showSubscriptionModal=false;state.showPremiumModal=true;render();">
                                ✨ Passer à Premium
                            </button>
                        ` : ''}
                        
                        ${status === 'active' ? `
                            <button class="btn btn-secondary" style="width: 100%; justify-content: center; font-size: 0.8rem;" onclick="cancelSubscription();">
                                Résilier mon abonnement
                            </button>
                            <p style="font-size: 0.65rem; color: #999; text-align: center; margin-top: 0.4rem;">L'accès reste actif jusqu'à la fin de la période payée.</p>
                        ` : ''}
                        ${status === 'cancelled' ? `
                            <button class="btn btn-generate" style="width: 100%; justify-content: center; padding: 0.75rem; font-size: 0.88rem;" onclick="state.showSubscriptionModal=false;state.showPremiumModal=true;render();">
                                🔄 Réactiver mon abonnement
                            </button>
                        ` : ''}
                    </div>
                </div>
            </div>`;
        }

        async function cancelSubscription() {
            if (!confirm('Êtes-vous sûr de vouloir résilier votre abonnement ?\nVotre accès Premium restera actif jusqu\'à la fin de la période payée.')) return;
            try {
                const { data: { session } } = await db.auth.getSession();
                if (!session?.access_token) { showToast('Session expirée'); return; }
                const res = await fetch(SUPABASE_URL + '/functions/v1/cancel-subscription', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + session.access_token, 'apikey': SUPABASE_KEY },
                });
                const result = await res.json();
                if (result.error) throw new Error(result.error);
                await loadProfile();
                state.showSubscriptionModal = false;
                showToast('Abonnement résilié. Accès actif jusqu\'à la fin de la période.');
                render();
            } catch(e) { showToast('Erreur: ' + e.message); }
        }

        // ============================================
        // Contact form modal
        // ============================================
        function renderContactModal() {
            if (!state.showContactModal) return '';
            const c = state.contactForm;
            const userName = state.user?.user_metadata?.name || '';
            const userEmail = state.user?.email || '';
            return `<div class="modal-overlay" onclick="if(event.target===this){state.showContactModal=false;render();}">
                <div class="modal" style="max-width: 460px;">
                    <div class="modal-header">
                        <h3 style="margin: 0; font-weight: 700; font-size: 1.05rem;">📧 Nous contacter</h3>
                        <button onclick="state.showContactModal=false;render();" style="background: none; border: none; font-size: 1.2rem; cursor: pointer; color: #999;">✕</button>
                    </div>
                    <div class="modal-body">
                        <p style="font-size: 0.82rem; color: #666; margin-bottom: 1rem; line-height: 1.5;">Une question, un bug, une suggestion ? Écrivez-nous !</p>
                        <div style="margin-bottom: 0.8rem;">
                            <label class="label">Nom</label>
                            <input class="input" value="${c.name || userName}" oninput="state.contactForm.name=this.value">
                        </div>
                        <div style="margin-bottom: 0.8rem;">
                            <label class="label">Email</label>
                            <input type="email" class="input" value="${c.email || userEmail}" oninput="state.contactForm.email=this.value">
                        </div>
                        <div style="margin-bottom: 0.8rem;">
                            <label class="label">Sujet</label>
                            <select class="select" onchange="state.contactForm.subject=this.value">
                                <option value="">— Choisir —</option>
                                <option ${c.subject==='bug'?'selected':''} value="bug">🐛 Signaler un bug</option>
                                <option ${c.subject==='question'?'selected':''} value="question">❓ Question</option>
                                <option ${c.subject==='suggestion'?'selected':''} value="suggestion">💡 Suggestion</option>
                                <option ${c.subject==='abonnement'?'selected':''} value="abonnement">💳 Abonnement</option>
                                <option ${c.subject==='autre'?'selected':''} value="autre">📋 Autre</option>
                            </select>
                        </div>
                        <div style="margin-bottom: 1rem;">
                            <label class="label">Message</label>
                            <textarea class="input" style="min-height: 120px;" placeholder="Décrivez votre demande..." oninput="state.contactForm.message=this.value">${c.message}</textarea>
                        </div>
                        <button class="btn btn-primary" style="width: 100%; justify-content: center; padding: 0.7rem; font-size: 0.85rem;" onclick="submitContactForm();">
                            Envoyer
                        </button>
                    </div>
                </div>
            </div>`;
        }

        async function submitContactForm() {
            const c = state.contactForm;
            if (!c.message.trim()) { showToast('Écrivez un message'); return; }
            if (!c.subject) { showToast('Choisissez un sujet'); return; }
            try {
                await db.from('contact_messages').insert([{
                    user_id: state.user?.id || null,
                    name: c.name || state.user?.user_metadata?.name || '',
                    email: c.email || state.user?.email || '',
                    subject: c.subject,
                    message: c.message.trim()
                }]);
                state.contactForm = { name: '', email: '', subject: '', message: '' };
                state.showContactModal = false;
                showToast('Message envoyé ! Nous vous répondrons rapidement.');
                render();
            } catch(e) {
                // Fallback: mailto if table doesn't exist
                const mailto = `mailto:contact@repasio.fr?subject=${encodeURIComponent('[Repasio] ' + c.subject)}&body=${encodeURIComponent(c.message + '\n\n— ' + (c.name || '') + ' (' + (c.email || '') + ')')}`;
                window.open(mailto, '_blank');
                state.showContactModal = false;
                showToast('Redirection vers votre messagerie...');
                render();
            }
        }

        // ============================================
        // Navigation & Render
        // ============================================
        function setActiveTab(tab) { state.activeTab = tab; state.showUserMenu = false; render(); }

        function render() {
            const app = document.getElementById('app');
            if (state.isLoading) { app.innerHTML = `<div class="loading"><div class="loading-spinner"></div></div>`; return; }
            if (!state.user) { app.innerHTML = renderLanding(); return; }
            app.innerHTML = `${renderHeader()}${renderNavbar()}<main style="padding: 0.75rem 1.25rem 1rem;">${renderContent()}</main>${renderMobileNav()}${state.showMealModal ? renderMealModal() : ''}${renderPremiumModal()}${renderLegalModal()}${renderOnboarding()}${renderSubscriptionModal()}${renderContactModal()}${renderGenModal()}${renderValidateModal()}${renderClearModal()}`;
        }

                function showAuth(mode) { state.authMode = mode; state.showAuthForm = true; render(); }
        function closeAuth() { state.showAuthForm = false; state.showResetForm = false; render(); }
        function toggleFeatures() { state.showFeatures = !state.showFeatures; render(); }
        
        function renderLanding() {
            const features = [
                { icon: '\u{1F4C5}', title: 'Planning intelligent', desc: 'Organisez les repas de votre famille pour toute la semaine.' },
                { icon: '\u{1F4B0}', title: 'Budget ma\u00eetris\u00e9', desc: 'Fixez un budget hebdo et Repasio compose des menus adapt\u00e9s.' },
                { icon: '\u{1F4E6}', title: 'Gestion du stock', desc: 'Suivez vos aliments, leurs p\u00e9remptions, z\u00e9ro gaspillage.' },
                { icon: '\u{1F6D2}', title: 'Courses automatiques', desc: 'PDF de courses avec d\u00e9duction automatique de votre stock.' },
                { icon: '\u{1F465}', title: 'Toute la famille', desc: 'Portions par participant, quantit\u00e9s ajust\u00e9es automatiquement.' },
                { icon: '\u{1F4D6}', title: 'Vos recettes', desc: 'Cr\u00e9ez, organisez et exportez vos recettes en PDF.' }
            ];
            
            let authModal = '';
            if (state.showAuthForm) {
                const authForm = state.showResetForm ? `
                    <div class="auth-card-header"><h2>Mot de passe oubli\u00e9</h2><p>Recevez un lien de r\u00e9initialisation</p></div>
                    <div style="margin-bottom: 1rem;"><label class="label">Email</label><input type="email" id="resetEmail" class="input" placeholder="votre@email.com"></div>
                    <button class="btn btn-primary" style="width: 100%; justify-content: center; padding: 0.7rem;" onclick="handleResetPassword(document.getElementById('resetEmail').value);">Envoyer le lien</button>
                    <p style="text-align: center; margin-top: 1.25rem; font-size: 0.78rem;"><button class="auth-link" onclick="state.showResetForm=false;render();">\u2190 Retour</button></p>
                ` : state.authMode === 'login' ? `
                    <div class="auth-card-header"><h2>Bon retour !</h2><p>Connectez-vous pour retrouver vos menus</p></div>
                    <form onsubmit="event.preventDefault(); handleLogin(this.email.value, this.password.value);">
                        <div style="margin-bottom: 0.9rem;"><label class="label">Email</label><input type="email" name="email" class="input" autocomplete="email" placeholder="votre@email.com" required></div>
                        <div style="margin-bottom: 0.25rem;"><label class="label">Mot de passe</label><input type="password" name="password" class="input" autocomplete="current-password" placeholder="\u2022\u2022\u2022\u2022\u2022\u2022\u2022\u2022" required></div>
                        <div class="forgot-link"><button type="button" onclick="state.showResetForm=true;render();">Mot de passe oubli\u00e9 ?</button></div>
                        <button type="submit" class="btn btn-primary" style="width: 100%; justify-content: center; padding: 0.7rem; margin-top: 1rem; font-size: 0.85rem;">Se connecter</button>
                    </form>
                    <div class="auth-separator">ou</div>
                    <p style="text-align: center; font-size: 0.8rem; color: #636E72;">Nouveau ? <button class="auth-link" onclick="state.authMode='register';render();">Cr\u00e9er un compte</button></p>
                ` : `
                    <div class="auth-card-header"><h2>Cr\u00e9er votre compte</h2><p>Rejoignez Repasio gratuitement</p></div>
                    <form onsubmit="event.preventDefault(); handleRegister(this.email.value, this.password.value, this.name.value);">
                        <div style="margin-bottom: 0.9rem;"><label class="label">Prénom</label><input type="text" name="name" class="input" autocomplete="given-name" placeholder="Votre pr\u00e9nom" required></div>
                        <div style="margin-bottom: 0.9rem;"><label class="label">Email</label><input type="email" name="email" class="input" autocomplete="email" placeholder="votre@email.com" required></div>
                        <div style="margin-bottom: 1.25rem;"><label class="label">Mot de passe</label><input type="password" name="password" class="input" autocomplete="new-password" placeholder="6 caract\u00e8res minimum" minlength="6" required></div>
                        <button type="submit" class="btn btn-primary" style="width: 100%; justify-content: center; padding: 0.7rem; font-size: 0.85rem;">Cr\u00e9er mon compte</button>
                    </form>
                    <div class="auth-separator">ou</div>
                    <p style="text-align: center; font-size: 0.8rem; color: #636E72;">D\u00e9j\u00e0 inscrit ? <button class="auth-link" onclick="state.authMode='login';render();">Se connecter</button></p>
                `;
                authModal = `<div class="auth-overlay" onclick="if(event.target===this)closeAuth();"><div class="auth-card"><button class="auth-close" onclick="closeAuth()">\u2715</button>${authForm}</div></div>`;
            }
            
            const mainContent = state.showFeatures ? `
                <div class="features-page">
                    <div class="features-page-inner">
                        <h2>Tout pour organiser vos repas</h2>
                        <p>Des outils simples et puissants pour toute la famille</p>
                        <div class="features">
                            ${features.map(f => `<div class="feature-card">
                                <div class="icon">${f.icon}</div>
                                <h3>${f.title}</h3>
                                <p>${f.desc}</p>
                            </div>`).join('')}
                        </div>
                        <div class="features-back">
                            <button onclick="toggleFeatures()">\u2190 Retour</button>
                        </div>
                    </div>
                </div>
            ` : `
                <section class="hero">
                    <div class="container hero-grid">
                        <div class="hero-content">
                            <div class="badge-new">\u2728 Planificateur de repas intelligent</div>
                            <h1>Mangez mieux, <span class="gradient-text">gaspillez moins.</span></h1>
                            <p>Planifiez vos repas, g\u00e9rez votre stock et vos p\u00e9remptions, g\u00e9n\u00e9rez vos listes de courses et ma\u00eetrisez votre budget alimentaire.</p>
                            
                            <div class="hero-actions">
                                <button class="btn-hero-primary" onclick="showAuth('register')">Commencer gratuitement</button>
                                <button class="btn-hero-secondary" onclick="showAuth('login')">Se connecter</button>
                            </div>

                        </div>

                        <div class="hero-image-wrapper">
                            <div class="glass-card">
                                <img src="https://images.unsplash.com/photo-1547592166-23ac45744acd?q=80&w=800&auto=format&fit=crop" alt="Cuisine organisée avec des ingrédients frais pour la planification de repas" loading="lazy" width="800" height="533">
                                
                                <div class="floating-ui stock-alert">
                                    <span class="fi-icon">\u26A0\uFE0F</span>
                                    <div>
                                        <h6>Poulet \u00e0 consommer</h6>
                                        <p>Expire demain</p>
                                    </div>
                                </div>

                                <div class="floating-ui recipe-suggestion">
                                    <span class="fi-icon">\u{1F468}\u200D\u{1F373}</span>
                                    <div>
                                        <h6>Recette sugg\u00e9r\u00e9e</h6>
                                        <p>Poulet au curry & coco</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </section>
            `;
            
            return `<div class="landing">
                <header class="landing-header" role="banner">
                    <div class="container">
                        <nav aria-label="Navigation principale">
                            <div class="logo"><img src="${LOGO_B64}" alt="Repasio logo" width="32" height="32">Repasio</div>
                            <ul class="nav-links">
                                <span class="nav-text"><a onclick="toggleFeatures()">${state.showFeatures ? '\u2190 Accueil' : 'Fonctionnalit\u00e9s'}</a></span>
                                <li><a onclick="showAuth('login')">Connexion</a></li>
                                <li><a class="btn-cta-small" onclick="showAuth('register')">S'inscrire</a></li>
                            </ul>
                        </nav>
                    </div>
                </header>
                <div style="display: flex; flex-direction: column; min-height: 100vh;">
                ${mainContent}
                <footer class="landing-footer" style="margin-top: auto;" role="contentinfo">
                    Repasio \u2014 Planificateur de repas familial<br>
                    <span class="legal-links"><a onclick="showLegalPage('mentions-legales')">Mentions légales</a> · <a onclick="showLegalPage('cgv')">CGV</a> · <a onclick="showLegalPage('confidentialite')">Confidentialité</a> · <a onclick="state.showContactModal=true;render();">Contact</a></span>
                </footer>
                </div>
                ${authModal}
                ${renderLegalModal()}
                ${renderContactModal()}
            </div>`;
        }

        function renderHeader() {
            const name = state.user?.user_metadata?.name || state.user?.email?.split('@')[0] || 'User';
            return `<header class="header"><div class="header-inner">
                <div style="display: flex; align-items: center; gap: 0.6rem;">
                    <img src="${LOGO_B64}" alt="Repasio" class="logo-img">
                    <div><h1 style="font-size: 1.05rem; font-weight: 700; color: white; margin: 0;">Repasio</h1><p style="font-size: 0.58rem; color: rgba(255,255,255,0.55); margin: 0;">Planificateur de repas</p></div>
                </div>
                <div class="user-menu"><button class="user-btn" onclick="state.showUserMenu=!state.showUserMenu;render();">${name.charAt(0).toUpperCase()}</button>
                    <div class="user-dropdown ${state.showUserMenu ? 'show' : ''}"><div style="padding: 0.7rem 1rem; border-bottom: 1px solid #E8ECEA;"><div style="font-weight: 600; font-size: 0.8rem;">${name}</div><div style="font-size: 0.66rem; color: #6B7280;">${state.user?.email}</div><div style="font-size: 0.62rem; color: var(--teal); font-weight: 600; margin-top: 0.15rem;">${getPremiumLabel()}</div></div><button class="user-dropdown-item" onclick="state.showUserMenu=false;state.showSubscriptionModal=true;render();">💳 Mon abonnement</button><button class="user-dropdown-item" onclick="state.showUserMenu=false;state.showContactModal=true;render();">📧 Contact</button><button class="user-dropdown-item" onclick="handleLogout();">Déconnexion</button></div>
                </div>
            </div></header>`;
        }

        function renderNavbar() {
            const tabs = [
                { id:'planning', icon:'📅', label:'Planning', premium: false },
                { id:'recettes', icon:'📖', label:'Recettes', premium: false },
                { id:'ingredients', icon:'🥕', label:'Aliments', premium: false },
                { id:'stock', icon:'📦', label:'Placards', premium: false },
                { id:'famille', icon:'👥', label:'Famille', premium: false },
                { id:'preferences', icon:'⚙️', label:'Préférences', premium: false }
            ];
            return `<nav class="navbar">${tabs.map(t => `<button class="nav-item ${state.activeTab === t.id ? 'active' : ''}" onclick="setActiveTab('${t.id}')">${t.icon} ${t.label}</button>`).join('')}</nav>`;
        }

        function renderMobileNav() {
            const tabs = [
                { id:'planning', icon:'📅', label:'Planning', premium: false },
                { id:'recettes', icon:'📖', label:'Recettes', premium: false },
                { id:'ingredients', icon:'🥕', label:'Aliments', premium: false },
                { id:'stock', icon:'📦', label:'Placards', premium: false },
                { id:'famille', icon:'👥', label:'Famille', premium: false },
                { id:'preferences', icon:'⚙️', label:'Préférences', premium: false }
            ];
            return `<nav class="mobile-nav"><div class="mobile-nav-inner">
                ${tabs.map(t => `<button class="mobile-nav-btn ${state.activeTab === t.id ? 'active' : ''}" onclick="setActiveTab('${t.id}')"><span>${t.icon}</span><span>${t.label}</span></button>`).join('')}
            </div></nav>`;
        }

        function renderContent() {
            switch(state.activeTab) {
                case 'planning': return renderPlanning();
                case 'recettes': return renderRecettes();
                case 'ingredients': return renderIngredients();
                case 'stock': return renderStockPage();
                case 'famille': return renderFamille();
                case 'preferences': return renderPreferences();
                default: return renderPlanning();
            }
        }

        // ============================================
        // Planning
        // ============================================
        function renderPlanning() {
            if (state.weeklyMeals.length > 0) {
                const sample = state.weeklyMeals[0];
            }
            const days = ['Lun','Mar','Mer','Jeu','Ven','Sam','Dim'];
            const meals = [{type:'Petit-déjeuner',cls:'pdej',icon:'🌅',short:'Petit-Déj'},{type:'Déjeuner',cls:'dej',icon:'🍽️',short:'Déjeuner'},{type:'Goûter',cls:'gout',icon:'🧁',short:'Goûter'},{type:'Dîner',cls:'din',icon:'🌙',short:'Dîner'}];
            const wt = getWeeklyTotalCost();
            
            if (state._generating) {
                const steps = [
                    { icon: '🔍', title: 'Analyse de vos recettes...', sub: 'Sélection des meilleures options pour votre famille.' },
                    { icon: '📦', title: 'Vérification du stock...', sub: 'Priorité aux ingrédients que vous avez déjà.' },
                    { icon: '🌿', title: 'Produits de saison...', sub: 'On privilégie les fruits et légumes du moment.' },
                    { icon: '💰', title: 'Optimisation du budget...', sub: 'On équilibre qualité et prix pour chaque repas.' },
                    { icon: '🧩', title: 'Assemblage du menu...', sub: 'Création d\'un planning varié et équilibré.' },
                    { icon: '✨', title: 'Dernières touches...', sub: 'Votre menu personnalisé arrive dans quelques secondes !' },
                    { icon: '⏳', title: 'Presque terminé...', sub: 'Enregistrement des repas en cours, merci de patienter.' }
                ];
                const step = steps[Math.min(state._genStep || 0, steps.length - 1)];
                return `<div class="card fade-in">
                    <div style="padding: 3rem 1.5rem; text-align: center;">
                        <div style="font-size: 2.5rem; margin-bottom: 1rem; animation: pulse 1.2s ease-in-out infinite;">${step.icon}</div>
                        <div style="font-weight: 700; font-size: 1.05rem; color: var(--teal); margin-bottom: 0.5rem;">${step.title}</div>
                        <p style="font-size: 0.78rem; color: #6B7280; line-height: 1.5;">${step.sub}</p>
                        <div style="margin-top: 1.2rem; background: #E8ECEA; border-radius: 20px; height: 6px; overflow: hidden; max-width: 200px; margin-left: auto; margin-right: auto;">
                            <div style="background: linear-gradient(90deg, var(--teal), #3D8B7A); height: 100%; border-radius: 20px; width: ${Math.min(((state._genStep || 0) + 1) / steps.length * 100, 95)}%; transition: width 0.8s ease;"></div>
                        </div>
                        <div style="font-size: 0.65rem; color: #9CA3AF; margin-top: 0.6rem;">Étape ${Math.min((state._genStep || 0) + 1, steps.length)} / ${steps.length}</div>
                    </div>
                </div>`;
            }
            
            return `<div class="card fade-in">
                ${state.familyMembers.length === 0 ? `
                    <div style="background: linear-gradient(135deg, #FFF6E6, #FEEBC8); border-radius: var(--radius-lg); padding: 1.5rem; text-align: center; margin-bottom: 1rem;">
                        <div style="font-size: 2rem; margin-bottom: 0.5rem;">👥</div>
                        <p style="font-weight: 600; font-size: 0.95rem; color: var(--charcoal); margin-bottom: 0.4rem;">Ajoutez votre famille d'abord</p>
                        <p style="font-size: 0.78rem; color: #666; margin-bottom: 0.8rem;">Les portions et calories seront adaptées à chaque membre.</p>
                        <button class="btn btn-primary" onclick="setActiveTab('famille')">👥 Aller dans Famille →</button>
                    </div>
                ` : `
                <div class="card-header">
                    <div><h2 style="font-size: 1.1rem; font-weight: 700; margin: 0;">📅 Planning Hebdomadaire</h2>
                    <p style="font-size: 0.72rem; color: #6B7280; margin: 0.15rem 0 0;">${state.weeklyMeals.length} repas • Budget: <span style="color: var(--teal); font-weight: 600;">${wt.toFixed(2)}€</span></p></div>
                    <div style="display: flex; gap: 0.3rem; flex-wrap: wrap;" class="planning-actions">
                        ${state._planningValidated ? `
                            <button class="btn btn-primary btn-sm" onclick="downloadAllInOnePDF()">📥 PDF</button>
                            <button class="btn btn-delete btn-sm" onclick="confirmClearPlanning()">🗑️ Vider</button>
                        ` : `
                            <button class="btn btn-generate" onclick="generateAutoMenu()">✨ Générer</button>
                            ${state.weeklyMeals.length > 0 ? `
                                <button class="btn btn-primary btn-sm" onclick="validatePlanning()">✅ Valider</button>
                                <button class="btn btn-delete btn-sm" onclick="confirmClearPlanning()">🗑️ Vider</button>
                            ` : ''}
                        `}
                    </div>
                </div>
                <div class="card-body">
                    ${state._planningValidated ? `<div style="background:linear-gradient(135deg,#D4EDDA,#E6F2F0);padding:0.5rem 0.8rem;border-radius:var(--radius-sm);margin-bottom:0.5rem;display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:0.3rem;">
                        <span style="font-size:0.78rem;font-weight:600;color:#155724;">✅ Planning validé — stock déduit</span>
                        <span style="font-size:0.68rem;color:#666;">Videz pour créer un nouveau planning</span>
                    </div>` : ''}
                    <div class="planning-scroll-wrapper" style="overflow-x: auto; -webkit-overflow-scrolling: touch;">
                    <div class="planning-grid">
                        <div class="planning-header meal-col">Repas</div>
                        ${days.map(d => `<div class="planning-header">${d}</div>`).join('')}
                        ${meals.map(meal => `
                            <div class="meal-type-cell">${meal.icon} ${meal.short}</div>
                            ${days.map(day => {
                                const sm = getMealsForSlot(day, meal.type);
                                const sc = getSlotCost(day, meal.type);
                                const participants = getParticipantsForSlot(day, meal.type);
                                const nbP = participants.length || 0;
                                const kcalPP = Math.round(getSlotKcalPerPerson(day, meal.type));
                                const costPerPortion = nbP > 0 ? sc / getSlotTotalPortions(day, meal.type) : 0;
                                
                                // Build per-member badges with their kcal + cost
                                const memberBadges = participants.map(p => {
                                    const member = state.familyMembers.find(x => x.id === p.member_id);
                                    if (!member) return '';
                                    const initial = member.name?.charAt(0) || '?';
                                    const portion = estimatePortions(member);
                                    const memberKcal = Math.round(kcalPP * portion);
                                    const memberCost = costPerPortion * portion;
                                    return `<span class="p-badge-detail" title="${member.name}: ${memberKcal} kcal • ${memberCost.toFixed(2)}€ (${portion} portion)">
                                        <span class="p-initial">${initial}</span>
                                        ${memberKcal > 0 ? `<span class="p-kcal">${memberKcal} kcal</span>` : ''}
                                        ${memberCost > 0 ? `<span class="p-cost">${memberCost.toFixed(2)}€</span>` : ''}
                                    </span>`;
                                }).join('');
                                
                                return `<div class="meal-cell ${meal.cls}">
                                    <button class="edit-slot-btn" onclick="openMealModal('${day}','${meal.type}')">✏️</button>
                                    <div class="slot-content">
                                        ${sm.map(m => { const r = findRecipeById(m); return r ? `<div class="recipe-tag"><span>${r.name}</span><button onclick="event.stopPropagation();removeRecipeFromMeal(${m.id})">✕</button></div>` : ''; }).join('')}
                                    </div>
                                    ${memberBadges ? `<div class="participants-mini">${memberBadges}</div>` : ''}
                                    ${sm.length > 0 && sc > 0 ? `<div class="slot-footer">
                                        <span class="slot-cost-total">total: ${sc.toFixed(2)}€</span>
                                    </div>` : ''}
                                    ${sm.length === 0 ? `<button class="add-btn-mini" onclick="openMealModal('${day}','${meal.type}')">+</button>` : ''}
                                </div>`;
                            }).join('')}
                        `).join('')}
                    </div>
                    </div>

                    <!-- Mobile: vertical day cards -->
                    <div class="planning-cards">
                    ${days.map(day => {
                        const dayLabel = {Lun:'Lundi',Mar:'Mardi',Mer:'Mercredi',Jeu:'Jeudi',Ven:'Vendredi',Sam:'Samedi',Dim:'Dimanche'}[day];
                        const dayCost = meals.reduce((s, meal) => s + getSlotCost(day, meal.type), 0);
                        
                        return `<div class="planning-day-card">
                            <div class="pdc-header">
                                <span>${dayLabel}</span>
                                ${dayCost > 0 ? `<span class="pdc-cost">${dayCost.toFixed(2)}€</span>` : ''}
                            </div>
                            ${meals.map(meal => {
                                const sm = getMealsForSlot(day, meal.type);
                                const sc = getSlotCost(day, meal.type);
                                const participants = getParticipantsForSlot(day, meal.type);
                                const memberInfo = participants.map(p => {
                                    const member = state.familyMembers.find(x => x.id === p.member_id);
                                    if (!member) return '';
                                    const portion = estimatePortions(member);
                                    const kcalPP = Math.round(getSlotKcalPerPerson(day, meal.type) * portion);
                                    return `<span class="pmr-member">${member.name?.split(' ')[0]} ${kcalPP}kcal</span>`;
                                }).join('');
                                
                                return `<div class="planning-meal-row">
                                    <div class="pmr-icon">${meal.icon}</div>
                                    <div class="pmr-content">
                                        <div class="pmr-type">${meal.short}</div>
                                        ${sm.length > 0 ? sm.map(m => {
                                            const r = findRecipeById(m);
                                            return r ? `<div class="pmr-recipe">${r.name}</div>` : '';
                                        }).join('') : '<div class="pmr-empty">—</div>'}
                                        ${sm.length > 0 && sc > 0 ? `<div class="pmr-meta">💰 ${sc.toFixed(2)}€</div>` : ''}
                                        ${memberInfo ? `<div class="pmr-members">${memberInfo}</div>` : ''}
                                    </div>
                                    <div class="pmr-actions">
                                        <button class="btn btn-sm btn-secondary" style="padding:4px 8px;font-size:0.7rem;min-height:auto;" onclick="openMealModal('${day}','${meal.type}')">✏️</button>
                                    </div>
                                </div>`;
                            }).join('')}
                        </div>`;
                    }).join('')}
                    </div>

                </div>
                `}
                ${renderPdfHistory()}
            </div>`;
        }

        // ============================================
        // Meal Modal - fix participants
        // ============================================
        function renderMealModal() {
            if (!state.currentMealEdit) return '';
            const { day, mealType } = state.currentMealEdit;
            const slotMeals = getMealsForSlot(day, mealType);
            const participants = getParticipantsForSlot(day, mealType);
            const participantIds = participants.map(p => p.member_id);
            
            const recipesWithStock = state.recipes.map(r => {
                const ss = (r.ingredients||[]).reduce((s, ri) => s + (getStockForIngredient(ri.ingredient_id).length > 0 ? 1 : 0), 0);
                return { ...r, stockScore: ss, _val: 'user:' + r.id };
            }).sort((a, b) => b.stockScore - a.stockScore);

            const siteRecipesFiltered = state.siteRecipes.filter(r => !r.isExcluded).map(r => ({ ...r, _val: 'site:' + r.id }));
            
            return `<div class="modal-overlay" onclick="if(event.target===this)closeMealModal();">
                <div class="modal">
                    <div class="modal-header">
                        <h3 style="margin: 0; font-weight: 600; font-size: 1rem;">${mealType} - ${day}</h3>
                        <button onclick="closeMealModal();" style="background: none; border: none; font-size: 1.2rem; cursor: pointer; color: #999;">✕</button>
                    </div>
                    <div class="modal-body">
                        <div style="margin-bottom: 1.2rem;">
                            <label class="label">Ajouter un plat</label>
                            <select class="select" onchange="if(this.value){addRecipeToMeal(this.value);this.selectedIndex=0;}">
                                <option value="">-- Choisir une recette --</option>
                                ${recipesWithStock.length > 0 ? `<optgroup label="📖 Mes recettes">${recipesWithStock.map(r => `<option value="${r._val}">${r.name}${r.stockScore > 0 ? ' ★' : ''}</option>`).join('')}</optgroup>` : ''}
                                ${siteRecipesFiltered.length > 0 ? `<optgroup label="🌐 Recettes du site">${siteRecipesFiltered.map(r => `<option value="${r._val}">${r.name}</option>`).join('')}</optgroup>` : ''}
                            </select>
                            <p style="font-size: 0.62rem; color: #9CA3AF; margin-top: 0.25rem;">★ utilise des ingrédients en stock</p>
                        </div>
                        
                        ${slotMeals.length > 0 ? `<div style="margin-bottom: 1.2rem;">
                            <label class="label">Plats du repas (${slotMeals.length})</label>
                            ${slotMeals.map(m => { const r = findRecipeById(m); return r ? `<div class="list-item" style="padding: 0.5rem 0.7rem;"><span style="font-size: 0.8rem;">${r.name}</span><button class="btn btn-delete btn-sm" onclick="removeRecipeFromMeal(${m.id})">✕</button></div>` : ''; }).join('')}
                        </div>` : '<p style="color: #9CA3AF; font-size: 0.8rem; margin-bottom: 1rem;">Aucun plat</p>'}
                        
                        <div>
                            <label class="label">Participants</label>
                            <div style="display: flex; flex-wrap: wrap; gap: 0.4rem;">
                                ${state.familyMembers.map(m => {
                                    const isIn = participantIds.includes(m.id);
                                    return `<label class="checkbox-label" style="background: ${isIn ? 'rgba(45,106,99,0.1)' : '#F8FAF9'}; border: 1.5px solid ${isIn ? 'var(--teal)' : '#E8ECEA'};">
                                        <input type="checkbox" class="checkbox" ${isIn ? 'checked' : ''} onchange="toggleSlotParticipant('${day}','${mealType}',${m.id},this.checked)">
                                        ${m.name}
                                    </label>`;
                                }).join('')}
                            </div>
                            ${state.familyMembers.length === 0 ? `<p style="font-size: 0.72rem; color: #9CA3AF; margin-top: 0.4rem;">Ajoutez des membres dans l'onglet Famille</p>` : ''}
                        </div>
                    </div>
                    <div class="modal-footer"><button class="btn btn-primary" onclick="closeMealModal();">Terminé</button></div>
                </div>
            </div>`;
        }

        // ============================================
        // Recettes - unified view
        // ============================================
        function renderRecettes() {
            const r = state.editingRecipe || state.newRecipe;
            const isEdit = !!state.editingRecipe;
            const target = isEdit ? 'state.editingRecipe' : 'state.newRecipe';
            const searchTerm = (state.searchRecipe || '').toLowerCase();

            // Merge user + site recipes
            const allRecipes = [];
            state.recipes.forEach(rec => {
                const tk = (rec.ingredients||[]).reduce((s,i) => s + ((i.kcal||0)*toGrams(i.quantity,i.unit)/100), 0);
                allRecipes.push({ ...rec, _source: 'user', _kcalPer: Math.round(tk/(rec.servings||1)), _cost: getRecipeCostPerPortion(rec) });
            });
            state.siteRecipes.filter(sr => !sr.isExcluded).forEach(sr => {
                if (allRecipes.some(r => r.id === sr.id && r._source === 'user')) return;
                const ings = (sr.site_recipe_ingredients || []).map(ri => {
                    const ing = state.ingredients.find(i => i.id == ri.ingredient_id);
                    return { ...ri, ingredient_name: ing?.name || '', kcal: ing?.kcal || 0, proteins: ing?.proteins || 0, carbs: ing?.carbs || 0, fats: ing?.fats || 0, price: ing?.price || 0 };
                });
                const tk = ings.reduce((s,i) => s + ((i.kcal||0)*toGrams(i.quantity,i.unit)/100), 0);
                allRecipes.push({ ...sr, ingredients: ings, _source: 'site', _kcalPer: Math.round(tk/(sr.servings||4)), _cost: ings.reduce((s,i)=>s+((i.price||0)*toGrams(i.quantity,i.unit)/100),0)/(sr.servings||4) });
            });

            const filtered = allRecipes.filter(rec => 
                rec.name.toLowerCase().includes(searchTerm) || 
                rec.category?.toLowerCase().includes(searchTerm) ||
                (rec.tags||[]).some(t => t.toLowerCase().includes(searchTerm))
            );

            const excluded = state.siteRecipes.filter(r => r.isExcluded);

            const renderStars = (recipeId, current) => {
                return [1,2,3,4,5].map(n => `<span onclick="rateSiteRecipe(${recipeId},${n})" style="cursor:pointer;font-size:0.85rem;color:${n<=current?'var(--gold)':'#D5DAD8'};">★</span>`).join('');
            };

            return `<div class="card fade-in">
                <div class="card-header">
                    <div><h2 style="font-size: 1.1rem; font-weight: 700; margin: 0;">📖 Recettes</h2>
                    <p style="font-size: 0.72rem; color: #6B7280; margin: 0.15rem 0 0;">${state.recipes.length} perso + ${state.siteRecipes.filter(s=>!s.isExcluded).length} Repasio</p></div>
                </div>
                <div class="card-body">
                    <div style="margin-bottom: 0.8rem;">
                        <input type="text" id="searchRecipeAll" class="input" placeholder="🔍 Rechercher parmi toutes les recettes..." style="width: 100%; padding: 0.45rem 0.7rem; font-size: 0.8rem;" value="${state.searchRecipe || ''}" oninput="state.searchRecipe=this.value;filterRecipeList();">
                    </div>

                    <div class="form-section">
                        <h3 style="font-weight: 600; margin: 0 0 0.9rem; font-size: 0.92rem;">${isEdit ? '✏️ Modifier' : '➕ Nouvelle recette'}</h3>
                        <div class="form-grid" style="margin-bottom: 0.8rem;">
                            <div><label class="label">Nom</label><input class="input" value="${r.name}" oninput="${target}.name=this.value"></div>
                            <div><label class="label">Catégorie</label><select class="select" onchange="${target}.category=this.value">${['Entrée','Plat principal','Dessert','Accompagnement','Petit-déjeuner','Goûter'].map(c => `<option ${r.category===c?'selected':''}>${c}</option>`).join('')}</select></div>
                            <div><label class="label">Difficulté</label><select class="select" onchange="${target}.difficulty=this.value">${['Facile','Moyen','Difficile'].map(d => `<option ${r.difficulty===d?'selected':''}>${d}</option>`).join('')}</select></div>
                        </div>
                        <div class="form-grid" style="margin-bottom: 0.8rem;">
                            <div><label class="label">Préparation (min)</label><input type="number" class="input" value="${r.preptime}" oninput="${target}.preptime=this.value"></div>
                            <div><label class="label">Cuisson (min)</label><input type="number" class="input" value="${r.cooktime}" oninput="${target}.cooktime=this.value"></div>
                            <div><label class="label">Portions</label><input type="number" class="input" value="${r.servings}" oninput="${target}.servings=this.value"></div>
                        </div>
                        <div style="margin-bottom: 0.8rem;">
                            <label class="label">Ingrédients</label>
                            ${r.ingredients.map((ing, idx) => `
                                <div style="display: flex; gap: 0.35rem; margin-bottom: 0.35rem; flex-wrap: wrap; align-items: center;">
                                    <select class="select" style="flex: 2; min-width: 110px;" onchange="${target}.ingredients[${idx}].ingredient_id=parseInt(this.value);${target}.ingredients[${idx}].ingredient_name=this.options[this.selectedIndex].text;render();">
                                        <option value="">Choisir...</option>
                                        ${state.ingredients.map(i => `<option value="${i.id}" ${ing.ingredient_id===i.id?'selected':''}>${i.name}</option>`).join('')}
                                    </select>
                                    <input type="number" class="input" style="width: 60px;" placeholder="Qté" value="${ing.quantity||''}" onchange="${target}.ingredients[${idx}].quantity=this.value">
                                    <select class="select" style="width: 60px;" onchange="${target}.ingredients[${idx}].unit=this.value">${['g','ml','pièce','càs','càc'].map(u => `<option ${ing.unit===u?'selected':''}>${u}</option>`).join('')}</select>
                                    <button class="btn btn-delete btn-sm" onclick="${target}.ingredients.splice(${idx},1);render();">✕</button>
                                </div>
                            `).join('')}
                            <button class="btn btn-secondary btn-sm" onclick="${target}.ingredients.push({ingredient_id:null,ingredient_name:'',quantity:0,unit:'g'});render();">+ Ingrédient</button>
                        </div>
                        <div style="margin-bottom: 0.9rem;"><label class="label">Instructions</label><textarea class="input" placeholder="Étape 1: ..." oninput="${target}.instructions=this.value">${r.instructions||''}</textarea></div>
                        <div style="margin-bottom: 0.9rem;">
                            <label class="label">Appareil de cuisson</label>
                            <div style="display:flex;flex-wrap:wrap;gap:0.3rem;">
                                ${(state.applianceOptions.length > 0 ? state.applianceOptions.map(a => a.label||a.name||'').filter(Boolean) : ['Four','Plaques','Micro-ondes','Robot cuiseur','Airfryer','Cocotte-minute','Plancha','Pas de cuisson']).map(app => {
                                    const active = (r.appliance || '') === app;
                                    return `<button type="button" style="padding:3px 8px;border-radius:4px;font-size:0.68rem;font-weight:600;border:1px solid ${active?'var(--teal)':'#D5DAD8'};background:${active?'#E6F2F0':'white'};color:${active?'var(--teal)':'#666'};cursor:pointer;" onclick="${target}.appliance='${active ? '' : app}';render();">${active?'✓ ':''}${app}</button>`;
                                }).join('')}
                            </div>
                        </div>
                        <div style="margin-bottom: 0.9rem;">
                            <label class="label">Contient (pour filtrage des restrictions)</label>
                            <div style="display:flex;flex-wrap:wrap;gap:0.3rem;">
                                ${(['Porc','Gluten','Lactose','Fruits à coque','Arachides','Soja','Poisson','Crustacés','Oeufs','Viande','Alcool']).map(tag => {
                                    const active = (r.dietary_info || []).includes(tag);
                                    return `<button type="button" style="padding:3px 8px;border-radius:4px;font-size:0.68rem;font-weight:600;border:1px solid ${active?'#E74C3C':'#D5DAD8'};background:${active?'#FDEDEC':'white'};color:${active?'#C0392B':'#666'};cursor:pointer;" onclick="if(!${target}.dietary_info)${target}.dietary_info=[];const i=${target}.dietary_info.indexOf('${tag}');if(i>=0)${target}.dietary_info.splice(i,1);else ${target}.dietary_info.push('${tag}');render();">${active?'⚠️ ':''}${tag}</button>`;
                                }).join('')}
                            </div>
                        </div>
                        <div style="display: flex; gap: 0.5rem;">
                            <button class="btn btn-primary" onclick="saveRecipe()">${isEdit ? 'Enregistrer' : 'Créer'}</button>
                            ${isEdit ? `<button class="btn btn-secondary" onclick="cancelEditRecipe()">Annuler</button>` : ''}
                        </div>
                    </div>

                    <div id="recipe-list-container" class="recipe-grid">
                    ${filtered.map(rec => {
                        const isSite = rec._source === 'site';
                        const badge = isSite 
                            ? '<span class="rc-badge" style="background:linear-gradient(135deg,var(--teal),#3D8B7A);color:white;">REPASIO</span>'
                            : '<span class="rc-badge" style="background:#FFF6E6;color:var(--gold-dark);">PERSO</span>';
                        const stars = isSite ? `<div style="margin-top:0.2rem;">${renderStars(rec.id, rec.userRating||0)}</div>` : '';
                        const dietary = rec.dietary_info?.length ? rec.dietary_info.map(d => `<span style="background:#FDEDEC;color:#C0392B;padding:1px 4px;border-radius:3px;font-size:0.5rem;font-weight:600;">⚠️${d}</span>`).join(' ') : '';

                        return `<div class="recipe-card" ${isSite ? `onclick="state.expandedSiteRecipe=state.expandedSiteRecipe===${rec.id}?null:${rec.id};render();"` : ''}>
                            <div class="rc-cat">${rec.category || 'Plat'}</div>
                            <div class="rc-name">${rec.name}</div>
                            <div style="display:flex;gap:0.3rem;margin-bottom:0.2rem;">${badge}</div>
                            <div class="rc-meta">⏱ ${(rec.preptime||0)+(rec.cooktime||0)}min • 👤 ${rec.servings||4} pers.</div>
                            <div class="rc-meta">🔥 ${rec._kcalPer} kcal${rec._cost > 0 ? ' • 💰 ' + rec._cost.toFixed(2) + '€/pers' : ''}</div>
                            ${dietary ? `<div class="rc-tags">${dietary}</div>` : ''}
                            ${stars}
                            <div class="rc-actions">
                                ${!isSite ? `
                                    <button class="btn btn-sm" onclick="event.stopPropagation();submitUserRecipe(${rec.id})" style="font-size:0.6rem;background:linear-gradient(135deg,var(--gold),var(--gold-dark));color:#fff;border:none;padding:3px 7px;">📤</button>
                                    <button class="btn btn-secondary btn-sm" onclick="event.stopPropagation();printSingleRecipe(${rec.id})" style="padding:3px 6px;">🖨️</button>
                                    <button class="btn btn-edit btn-sm" onclick='event.stopPropagation();editRecipe(${JSON.stringify(rec).replace(/'/g, "\\'")})' style="padding:3px 6px;">✏️</button>
                                    <button class="btn btn-delete btn-sm" onclick="event.stopPropagation();deleteRecipe(${rec.id})" style="padding:3px 6px;">🗑️</button>
                                ` : `
                                    <button class="btn btn-secondary btn-sm" onclick="event.stopPropagation();toggleExcludeRecipe(${rec.id})" style="padding:3px 6px;">🚫</button>
                                `}
                            </div>
                            ${isSite && state.expandedSiteRecipe === rec.id ? `
                                <div style="background:white;border-radius:var(--radius-sm);padding:0.6rem;margin-top:0.5rem;font-size:0.72rem;line-height:1.6;border:1px solid #E8ECEA;">
                                    ${(rec.ingredients||[]).length ? `<div style="margin-bottom:0.4rem;"><strong style="color:var(--teal);font-size:0.68rem;">Ingrédients:</strong> ${rec.ingredients.map(i => `${i.ingredient_name} (${i.quantity}${i.unit})`).join(', ')}</div>` : ''}
                                    ${rec.instructions ? `<div style="white-space:pre-wrap;color:#444;">${rec.instructions}</div>` : '<p style="color:#999;">Pas d\'instructions.</p>'}
                                </div>
                            ` : ''}
                        </div>`;
                    }).join('')}
                    </div>

                    ${filtered.length === 0 && searchTerm ? `<p style="text-align:center;color:#9CA3AF;padding:1rem;">Aucun résultat pour "${state.searchRecipe}"</p>` : ''}

                    ${excluded.length > 0 ? `
                        <div style="margin-top:1.2rem;padding-top:0.8rem;border-top:1px solid #E8ECEA;">
                            <h4 style="font-size:0.78rem;color:#999;font-weight:600;margin-bottom:0.5rem;">🚫 Recettes exclues (${excluded.length})</h4>
                            ${excluded.map(rec => `
                                <div style="display:flex;justify-content:space-between;align-items:center;padding:0.35rem 0;font-size:0.78rem;color:#999;">
                                    <span style="text-decoration:line-through;">${rec.name}</span>
                                    <button class="btn btn-secondary btn-sm" onclick="toggleExcludeRecipe(${rec.id})" style="font-size:0.65rem;">↩️</button>
                                </div>
                            `).join('')}
                        </div>
                    ` : ''}

                    <div style="margin-top:1.2rem;padding-top:0.8rem;border-top:1px solid #E8ECEA;">
                        ${state._mySubmissions?.length ? `
                            <h4 style="font-size:0.78rem;color:#666;font-weight:600;margin-bottom:0.4rem;">📤 Mes propositions</h4>
                            ${state._mySubmissions.map(s => `
                                <div style="display:flex;justify-content:space-between;align-items:center;padding:0.3rem 0;font-size:0.75rem;border-bottom:1px solid #F0F3F2;">
                                    <span>${s.name}</span>
                                    <span style="padding:2px 6px;border-radius:3px;font-size:0.6rem;font-weight:600;${s.status==='approved'?'background:#D4EDDA;color:#155724;':s.status==='rejected'?'background:#F8D7DA;color:#721C24;':'background:#FFF3CD;color:#856404;'}">${s.status==='approved'?'✅ Approuvée':s.status==='rejected'?'❌ Refusée':'⏳ En attente'}</span>
                                </div>
                            `).join('')}
                        ` : ''}
                    </div>
                </div>
            </div>`;
        }

        async function submitUserRecipe(recipeId) {
            const rec = state.recipes.find(r => r.id === recipeId);
            if (!rec) return;
            // Check if already submitted
            if (state._mySubmissions?.some(s => s.name === rec.name)) {
                showToast('Cette recette a déjà été proposée'); return;
            }
            if (!confirm('Proposer "' + rec.name + '" à la communauté Repasio ?')) return;
            try {
                const { error } = await db.from('recipe_submissions').insert([{
                    user_id: state.user.id,
                    name: rec.name,
                    category: rec.category || 'Plat principal',
                    difficulty: rec.difficulty || 'Facile',
                    preptime: rec.preptime || 0,
                    cooktime: rec.cooktime || 0,
                    servings: rec.servings || 4,
                    instructions: rec.instructions || '',
                    ingredients: (rec.ingredients||[]).filter(i=>i.ingredient_id).map(i=>({ingredient_id:i.ingredient_id, quantity:i.quantity, unit:i.unit}))
                }]);
                if (error) throw error;
                await loadMySubmissions();
                showToast('🎉 "' + rec.name + '" proposée ! En attente de validation.');
                render();
            } catch(e) { showToast('Erreur: ' + e.message); }
        }

        async function loadMySubmissions() {
            try {
                const { data } = await db.from('recipe_submissions').select('id, name, status, submitted_at').eq('user_id', state.user.id).order('submitted_at', { ascending: false });
                state._mySubmissions = data || [];
            } catch(e) { state._mySubmissions = []; }
        }

        // DOM-based filtering - no render needed
        function filterRecipeList() {
            const term = (state.searchRecipe || '').toLowerCase();
            document.querySelectorAll('.recipe-item').forEach(el => {
                const name = el.dataset.name || '';
                const cat = el.dataset.cat || '';
                const tags = el.dataset.tags || '';
                const match = !term || name.includes(term) || cat.includes(term) || tags.includes(term);
                el.style.display = match ? '' : 'none';
                // Also hide expanded detail if present
                if (!match && el.nextElementSibling && !el.nextElementSibling.classList.contains('recipe-item')) {
                    el.nextElementSibling.style.display = 'none';
                }
            });
        }

        // ============================================
        // Aliments + Stock
        // ============================================
        function renderIngredients() {
            return `<div class="card fade-in">
                <div class="card-header">
                    <div><h2 style="font-size: 1.1rem; font-weight: 700; margin: 0;">🥕 Aliments</h2><p style="font-size: 0.72rem; color: #6B7280; margin: 0.15rem 0 0;">${state.ingredients.filter(i=>!i.user_id).length} base + ${state.ingredients.filter(i=>i.user_id).length} perso</p></div>
                </div>
                <div class="card-body">${renderIngredientsTab()}</div>
            </div>`;
        }

        function renderIngredientsTab() {
            const i = state.editingIngredient || state.newIngredient;
            const isEdit = !!state.editingIngredient;
            const target = isEdit ? 'state.editingIngredient' : 'state.newIngredient';
            const searchTerm = (state.searchIngredient || '').toLowerCase();
            const filtered = state.ingredients.filter(ing => ing.name.toLowerCase().includes(searchTerm));
            return `
                <div style="margin-bottom: 0.9rem;"><input type="text" id="searchIngredient" class="input" placeholder="🔍 Rechercher..." style="max-width: 220px; padding: 0.35rem 0.6rem; font-size: 0.76rem;" value="${state.searchIngredient || ''}" oninput="handleSearchInput('searchIngredient', this.value, 'searchIngredient')"></div>
                <div class="form-section">
                    <h3 style="font-weight: 600; margin: 0 0 0.9rem; font-size: 0.92rem;">${isEdit ? '✏️ Modifier' : '➕ Nouvel ingrédient'}</h3>
                    <div class="form-grid">
                        <div style="grid-column: span 2;"><label class="label">Nom</label><input class="input" value="${i.name}" oninput="${target}.name=this.value"></div>
                        <div><label class="label">Kcal /100g</label><input type="number" class="input" value="${i.kcal}" oninput="${target}.kcal=this.value"></div>
                        <div><label class="label">Protéines /100g</label><input type="number" step="0.1" class="input" value="${i.proteins}" oninput="${target}.proteins=this.value"></div>
                        <div><label class="label">Glucides /100g</label><input type="number" step="0.1" class="input" value="${i.carbs}" oninput="${target}.carbs=this.value"></div>
                        <div><label class="label">Lipides /100g</label><input type="number" step="0.1" class="input" value="${i.fats}" oninput="${target}.fats=this.value"></div>
                        <div><label class="label">Prix €/kg</label><input type="number" step="0.01" class="input" value="${i.priceKg||''}" oninput="${target}.priceKg=this.value"></div>
                    </div>
                    <div style="display: flex; gap: 0.5rem; margin-top: 0.9rem;">
                        <button class="btn btn-primary" onclick="saveIngredient()">${isEdit ? 'Enregistrer' : 'Ajouter'}</button>
                        ${isEdit ? `<button class="btn btn-secondary" onclick="cancelEditIngredient()">Annuler</button>` : ''}
                    </div>
                </div>
                <div class="ingredient-grid">
                ${filtered.map(ing => {
                    const isSite = !ing.user_id;
                    return `<div class="ingredient-card">
                        <div class="ic-name">${ing.name} ${isSite ? '<span style="background:#E6F2F0;color:var(--teal);padding:1px 5px;border-radius:3px;font-size:0.52rem;font-weight:600;">Base</span>' : ''}</div>
                        <div class="ic-meta">${ing.kcal} kcal • P:${ing.proteins}g • G:${ing.carbs}g • L:${ing.fats}g</div>
                        <div class="ic-meta">💰 ${((ing.price||0)*10).toFixed(2)}€/kg</div>
                        ${!isSite ? `<div class="ic-actions">
                            <button class="btn btn-edit btn-sm" style="padding:2px 5px;" onclick='editIngredient(${JSON.stringify(ing).replace(/'/g, "\\'")})'>✏️</button>
                            <button class="btn btn-delete btn-sm" style="padding:2px 5px;" onclick="deleteIngredient(${ing.id})">🗑️</button>
                        </div>` : ''}
                    </div>`}).join('')}
                </div>
                ${filtered.length === 0 && searchTerm ? `<p style="text-align: center; color: #9CA3AF; padding: 0.9rem;">Aucun résultat</p>` : ''}`;
        }

        function renderStockTab() {
            return renderStockContent();
        }

        function renderStockPage() {
            return `<div class="card fade-in">
                <div class="card-header"><div><h2 style="font-size: 1.1rem; font-weight: 700; margin: 0;">📦 Mes Placards</h2><p style="font-size: 0.72rem; color: #6B7280; margin: 0.15rem 0 0;">${state.stockItems.length} aliments en stock</p></div></div>
                <div class="card-body">${renderStockContent()}</div>
            </div>`;
        }

        function renderStockContent() {
            const s = state.editingStockItem || state.newStockItem;
            const isEdit = !!state.editingStockItem;
            const target = isEdit ? 'state.editingStockItem' : 'state.newStockItem';
            return `
                <div class="info-box" style="margin-bottom: 0.9rem;">
                    <span>📦</span><span>Enregistrez vos aliments en stock avec leur date de péremption. Ils seront priorisés dans la génération du menu et marqués dans la liste de courses.</span>
                </div>
                <div class="form-section">
                    <h3 style="font-weight: 600; margin: 0 0 0.9rem; font-size: 0.92rem;">${isEdit ? '✏️ Modifier' : '➕ Ajouter au stock'}</h3>
                    <div class="form-grid">
                        <div style="grid-column: span 2;"><label class="label">Aliment</label>
                            <select class="select" onchange="${target}.ingredient_id=parseInt(this.value)||null">
                                <option value="">-- Choisir --</option>
                                ${state.ingredients.map(i => `<option value="${i.id}" ${s.ingredient_id==i.id?'selected':''}>${i.name}</option>`).join('')}
                            </select></div>
                        <div><label class="label">Quantité</label><input type="number" class="input" value="${s.quantity}" oninput="${target}.quantity=this.value"></div>
                        <div><label class="label">Unité</label><select class="select" onchange="${target}.unit=this.value">${['g','kg','ml','L','pièce'].map(u => `<option ${s.unit===u?'selected':''}>${u}</option>`).join('')}</select></div>
                        <div><label class="label">Péremption</label><input type="date" class="input" id="stock-expiry-date" value="${s.expiry_date||''}" oninput="${target}.expiry_date=this.value" onchange="${target}.expiry_date=this.value"><div style="display:flex;align-items:center;gap:0.4rem;margin-top:0.3rem;"><span style="font-size:0.62rem;color:#9CA3AF;">ou mois seul :</span><input type="month" class="input" style="flex:1;padding:0.35rem 0.5rem;font-size:0.75rem;" value="" onchange="if(this.value){const d=new Date(this.value+'-01');d.setMonth(d.getMonth()+1);d.setDate(0);const v=d.toISOString().split('T')[0];${target}.expiry_date=v;document.getElementById('stock-expiry-date').value=v;this.value='';}"></div></div>
                    </div>
                    <div style="display: flex; gap: 0.5rem; margin-top: 0.9rem;">
                        <button class="btn btn-primary" onclick="saveStockItem()">${isEdit ? 'Enregistrer' : 'Ajouter'}</button>
                        ${isEdit ? `<button class="btn btn-secondary" onclick="cancelEditStockItem()">Annuler</button>` : ''}
                    </div>
                </div>
                ${state.stockItems.length === 0 ? `<div style="text-align: center; padding: 1.5rem; color: #9CA3AF;"><div style="font-size: 1.8rem; margin-bottom: 0.4rem;">📦</div><p>Aucun aliment en stock</p></div>` : ''}
                <div class="stock-grid">
                ${state.stockItems.map(si => {
                    const ing = state.ingredients.find(i => i.id === si.ingredient_id);
                    const status = getStockStatus(si.expiry_date);
                    return `<div class="stock-card">
                        <div style="font-weight:600;font-size:0.82rem;color:var(--charcoal);margin-bottom:0.15rem;">${ing?.name || 'Inconnu'}</div>
                        <div style="font-size:0.68rem;color:#6B7280;margin-bottom:0.2rem;">${si.quantity} ${si.unit}</div>
                        <div style="margin-bottom:0.3rem;">
                            ${si.expiry_date ? `<span class="stock-badge ${status.cls}" style="font-size:0.6rem;">${status.label} (${new Date(si.expiry_date).toLocaleDateString('fr-FR')})</span>` : '<span class="stock-badge ok" style="font-size:0.6rem;">Pas de date</span>'}
                        </div>
                        <div style="display:flex;gap:0.2rem;">
                            <button class="btn btn-edit btn-sm" style="padding:2px 5px;" onclick='editStockItem(${JSON.stringify(si).replace(/'/g, "\\'")})'>✏️</button>
                            <button class="btn btn-delete btn-sm" style="padding:2px 5px;" onclick="deleteStockItem(${si.id})">🗑️</button>
                        </div>
                    </div>`;
                }).join('')}
                </div>`;
        }

        // ============================================
        // Famille
        // ============================================
        // ============================================
        // Kcal calculation
        // ============================================
        function calculateKcal(member) {
            if (!member.age || !member.weight || !member.height || !member.gender) return null;
            const w = parseFloat(member.weight), h = parseInt(member.height), a = parseInt(member.age);
            // Mifflin-St Jeor : BMR
            let bmr = member.gender === 'Homme' 
                ? (10 * w) + (6.25 * h) - (5 * a) + 5 
                : (10 * w) + (6.25 * h) - (5 * a) - 161;
            // Enfant : Harris-Benedict simplifié
            if (member.gender === 'Enfant') bmr = (10 * w) + (6.25 * h) - (5 * a) + 5;
            const factors = {'Sédentaire': 1.2, 'Légère': 1.375, 'Modérée': 1.55, 'Active': 1.725, 'Sportive': 1.9};
            let tdee = Math.round(bmr * (factors[member.activity] || 1.55));
            // Ajustement selon objectif
            const goal = member.goal || 'Maintien';
            if (goal === 'Perte') tdee = Math.round(tdee * 0.8); // -20%
            else if (goal === 'Prise') tdee = Math.round(tdee * 1.15); // +15%
            return tdee;
        }

        function estimatePortions(member) {
            const kcal = calculateKcal(member);
            if (!kcal) return 1;
            if (kcal < 1500) return 0.75;
            if (kcal < 2000) return 1;
            if (kcal < 2500) return 1.25;
            return 1.5;
        }

        // ============================================
        // Preferences: load options from DB
        // ============================================
        async function loadDietaryOptions() {
            try {
                const { data } = await db.from('dietary_options').select('*').eq('is_active', true).order('sort_order');
                state.dietaryOptions = data || [];
            } catch(e) { state.dietaryOptions = []; }
        }

        async function loadApplianceOptions() {
            try {
                const { data } = await db.from('kitchen_appliance_options').select('*').eq('is_active', true).order('sort_order');
                state.applianceOptions = data || [];
            } catch(e) { state.applianceOptions = []; }
        }

        async function loadPreferencesFromProfile() {
            if (!state.profile) return;
            state.profileDietary = state.profile.dietary_restrictions || [];
            state.profileAllergies = state.profile.allergies || [];
            state.profileAppliances = state.profile.kitchen_appliances || [];
            state.defaultParticipants = state.profile.default_participants || [];
            state.mealSchedule = state.profile.meal_schedule || {};
            // Migration: if old defaultParticipants exists but no mealSchedule, build it
            if (state.defaultParticipants.length > 0 && Object.keys(state.mealSchedule).length === 0) {
                const days = ['Lun','Mar','Mer','Jeu','Ven','Sam','Dim'];
                const meals = ['Petit-déjeuner','Déjeuner','Goûter','Dîner'];
                state.defaultParticipants.forEach(mid => {
                    state.mealSchedule[mid] = {};
                    days.forEach(d => { state.mealSchedule[mid][d] = [...meals]; });
                });
            }
        }

        async function togglePreference(type, code) {
            const arr = type === 'dietary' ? state.profileDietary : type === 'allergies' ? state.profileAllergies : state.profileAppliances;
            const idx = arr.indexOf(code);
            if (idx >= 0) arr.splice(idx, 1); else arr.push(code);
            render();
        }

        function toggleDefaultParticipant(memberId) {
            const idx = state.defaultParticipants.indexOf(memberId);
            if (idx >= 0) state.defaultParticipants.splice(idx, 1);
            else state.defaultParticipants.push(memberId);
            render();
        }

        function toggleMealSchedule(memberId, day, mealType) {
            if (!state.mealSchedule[memberId]) state.mealSchedule[memberId] = {};
            if (!state.mealSchedule[memberId][day]) state.mealSchedule[memberId][day] = [];
            const arr = state.mealSchedule[memberId][day];
            const idx = arr.indexOf(mealType);
            if (idx >= 0) arr.splice(idx, 1); else arr.push(mealType);
            render();
            autoSaveMealSchedule();
        }

        function selectAllMealsForMember(memberId) {
            const days = ['Lun','Mar','Mer','Jeu','Ven','Sam','Dim'];
            const meals = ['Petit-déjeuner','Déjeuner','Goûter','Dîner'];
            state.mealSchedule[memberId] = {};
            days.forEach(d => { state.mealSchedule[memberId][d] = [...meals]; });
            render();
            autoSaveMealSchedule();
        }

        function clearAllMealsForMember(memberId) {
            state.mealSchedule[memberId] = {};
            render();
            autoSaveMealSchedule();
        }

        // Debounced auto-save for mealSchedule
        let _saveMealScheduleTimer = null;
        function autoSaveMealSchedule() {
            clearTimeout(_saveMealScheduleTimer);
            _saveMealScheduleTimer = setTimeout(async () => {
                try {
                    const { error } = await db.from('profiles').update({ meal_schedule: state.mealSchedule }).eq('id', state.user.id);
                    if (error) console.error('[autoSave] error:', error.message);
                    else console.log('[autoSave] meal_schedule saved OK');
                } catch(e) { console.error('[autoSave] exception:', e); }
            }, 800);
        }

        // Get members who should participate in a specific day+meal from schedule
        function getScheduledMembers(day, mealType) {
            const members = [];
            for (const [mid, schedule] of Object.entries(state.mealSchedule)) {
                const dayMeals = schedule[day] || [];
                if (dayMeals.includes(mealType)) members.push(parseInt(mid));
            }
            return members;
        }

        // Auto-add scheduled participants to a slot if none exist
        async function applyDefaultParticipants(day, mealType) {
            const scheduled = getScheduledMembers(day, mealType);
            if (scheduled.length === 0) return;
            const existing = getParticipantsForSlot(day, mealType);
            if (existing.length > 0) return;
            const inserts = scheduled.map(memberId => ({ user_id: state.user?.id, day, meal_type: mealType, member_id: memberId }));
            await db.from('slot_participants').insert(inserts);
        }

        async function savePreferences() {
            try {
                const { error } = await db.from('profiles').update({
                    dietary_restrictions: state.profileDietary,
                    allergies: state.profileAllergies,
                    kitchen_appliances: state.profileAppliances,
                    meal_schedule: state.mealSchedule
                }).eq('id', state.user.id);
                if (error) throw error;
                await loadProfile();
                showToast('Préférences enregistrées');
            } catch(e) { showToast('Erreur: ' + e.message); }
        }

        // ============================================
        // Render Preferences tab
        // ============================================
        function renderPreferences() {
            const dietary = state.dietaryOptions.filter(d => d.category === 'restriction' || d.category === 'regime');
            const allergies = state.dietaryOptions.filter(d => d.category === 'allergie');
            const appliances = state.applianceOptions;

            return `<div class="card fade-in">
                <div class="card-header"><div><h2 style="font-size: 1.1rem; font-weight: 700; margin: 0;">⚙️ Préférences</h2><p style="font-size: 0.72rem; color: #6B7280; margin: 0.15rem 0 0;">Restrictions alimentaires & appareils de cuisine</p></div>
                    <button class="btn btn-primary" onclick="savePreferences()">💾 Enregistrer</button>
                </div>
                <div class="card-body">
                    <div class="form-section">
                        <h3 style="font-weight: 600; margin: 0 0 0.7rem; font-size: 0.92rem;">🍽️ Régime & restrictions</h3>
                        <div style="display: flex; flex-wrap: wrap; gap: 0.4rem;">
                            ${dietary.map(d => `<button onclick="togglePreference('dietary','${d.code}')" style="padding: 0.45rem 0.8rem; border-radius: var(--radius-sm); border: 1.5px solid ${state.profileDietary.includes(d.code) ? 'var(--teal)' : '#D5DAD8'}; background: ${state.profileDietary.includes(d.code) ? '#E6F2F0' : 'white'}; cursor: pointer; font-size: 0.78rem; font-family: inherit; transition: all 0.15s; display: flex; align-items: center; gap: 0.3rem;">
                                <span>${d.icon}</span> ${d.label}
                            </button>`).join('')}
                        </div>
                    </div>
                    <div class="form-section" style="margin-top: 1.2rem;">
                        <h3 style="font-weight: 600; margin: 0 0 0.7rem; font-size: 0.92rem;">⚠️ Allergies</h3>
                        <div style="display: flex; flex-wrap: wrap; gap: 0.4rem;">
                            ${allergies.map(d => `<button onclick="togglePreference('allergies','${d.code}')" style="padding: 0.45rem 0.8rem; border-radius: var(--radius-sm); border: 1.5px solid ${state.profileAllergies.includes(d.code) ? '#E74C3C' : '#D5DAD8'}; background: ${state.profileAllergies.includes(d.code) ? '#FDE8E8' : 'white'}; cursor: pointer; font-size: 0.78rem; font-family: inherit; transition: all 0.15s; display: flex; align-items: center; gap: 0.3rem;">
                                <span>${d.icon}</span> ${d.label}
                            </button>`).join('')}
                        </div>
                    </div>
                    <div class="form-section" style="margin-top: 1.2rem;">
                        <h3 style="font-weight: 600; margin: 0 0 0.7rem; font-size: 0.92rem;">🍳 Mes appareils de cuisine</h3>
                        <p style="font-size: 0.72rem; color: #6B7280; margin-bottom: 0.7rem;">Sélectionnez les appareils que vous possédez pour des recettes adaptées</p>
                        <div style="display: flex; flex-wrap: wrap; gap: 0.4rem;">
                            ${appliances.map(a => `<button onclick="togglePreference('appliances','${a.code}')" style="padding: 0.45rem 0.8rem; border-radius: var(--radius-sm); border: 1.5px solid ${state.profileAppliances.includes(a.code) ? 'var(--gold)' : '#D5DAD8'}; background: ${state.profileAppliances.includes(a.code) ? 'var(--gold-light)' : 'white'}; cursor: pointer; font-size: 0.78rem; font-family: inherit; transition: all 0.15s; display: flex; align-items: center; gap: 0.3rem;">
                                <span>${a.icon}</span> ${a.label}
                            </button>`).join('')}
                        </div>
                    </div>
                    <div class="form-section" style="margin-top: 1.2rem;">
                        <h3 style="font-weight: 600; margin: 0 0 0.3rem; font-size: 0.92rem;">👥 Qui mange quand ?</h3>
                        <p style="font-size: 0.72rem; color: #6B7280; margin-bottom: 0.7rem;">Cochez les repas de chaque membre par jour. Ces préférences seront appliquées à la génération du menu.</p>
                        ${state.familyMembers.length === 0 ? `<p style="font-size: 0.8rem; color: #9CA3AF;">Aucun membre. <button class="auth-link" onclick="setActiveTab('famille')">Ajouter →</button></p>` : `
                        <div style="overflow-x:auto;">
                        ${state.familyMembers.map(m => {
                            const mid = m.id;
                            if (!state.mealSchedule[mid]) state.mealSchedule[mid] = {};
                            const kcal = calculateKcal(m);
                            return `<div style="margin-bottom:1rem;border:1px solid #E8ECEA;border-radius:var(--radius-sm);overflow:hidden;">
                                <div style="background:#F8FAF9;padding:0.5rem 0.7rem;font-weight:600;font-size:0.82rem;display:flex;justify-content:space-between;align-items:center;">
                                    <span>${m.name}${kcal ? ' <span style="font-size:0.62rem;color:var(--teal);font-weight:600;">' + kcal + ' kcal/j</span>' : ''}</span>
                                    <div style="display:flex;gap:0.3rem;">
                                        <button class="btn btn-secondary btn-sm" style="font-size:0.6rem;padding:0.2rem 0.4rem;" onclick="selectAllMealsForMember(${mid})">Tout</button>
                                        <button class="btn btn-secondary btn-sm" style="font-size:0.6rem;padding:0.2rem 0.4rem;" onclick="clearAllMealsForMember(${mid})">Aucun</button>
                                    </div>
                                </div>
                                <table style="width:100%;font-size:0.68rem;border-collapse:collapse;">
                                    <tr style="background:#F0F3F2;">
                                        <th style="padding:0.25rem 0.4rem;text-align:left;font-weight:600;"></th>
                                        ${['Lun','Mar','Mer','Jeu','Ven','Sam','Dim'].map(d => `<th style="padding:0.25rem 0.2rem;text-align:center;font-weight:600;">${d}</th>`).join('')}
                                    </tr>
                                    ${['Petit-déjeuner','Déjeuner','Goûter','Dîner'].map(mt => {
                                        const short = mt === 'Petit-déjeuner' ? '🌅' : mt === 'Déjeuner' ? '🍽️' : mt === 'Goûter' ? '🧁' : '🌙';
                                        return `<tr>
                                            <td style="padding:0.2rem 0.4rem;font-weight:500;">${short}</td>
                                            ${['Lun','Mar','Mer','Jeu','Ven','Sam','Dim'].map(d => {
                                                const dayMeals = state.mealSchedule[mid]?.[d] || [];
                                                const isOn = dayMeals.includes(mt);
                                                return `<td style="text-align:center;padding:0.15rem;">
                                                    <button onclick="toggleMealSchedule(${mid},'${d}','${mt}')" style="width:22px;height:22px;border-radius:4px;border:1.5px solid ${isOn ? 'var(--teal)' : '#D5DAD8'};background:${isOn ? '#E6F2F0' : 'white'};cursor:pointer;font-size:0.6rem;line-height:1;padding:0;">${isOn ? '✓' : ''}</button>
                                                </td>`;
                                            }).join('')}
                                        </tr>`;
                                    }).join('')}
                                </table>
                            </div>`;
                        }).join('')}
                        </div>
                        `}
                    </div>
                </div>
            </div>`;
        }

        // ============================================
        // Onboarding wizard (shown after first login)
        // ============================================
        function shouldShowOnboarding() {
            if (!state.user || state.familyMembers.length > 0) return false;
            try { return !localStorage.getItem('repasio_onboarding_done_' + state.user.id); } catch(e) { return true; }
        }

        function completeOnboarding() {
            try { localStorage.setItem('repasio_onboarding_done_' + state.user.id, '1'); } catch(e) {}
            state.showOnboarding = false;
            state._ob = null;
            render();
        }

        function initOnboarding() {
            state._ob = {
                step: 0,
                members: [],
                currentMember: { name: '', age: '', gender: '', weight: '', height: '', activity: 'Modérée', goal: 'Maintien' },
                addingMore: false,
                dietary: [],
                allergies: [],
                appliances: [],
                stock: [],
                meals: { 'Petit-déjeuner': true, 'Déjeuner': true, 'Goûter': false, 'Dîner': true },
                days: { Lun:true, Mar:true, Mer:true, Jeu:true, Ven:true, Sam:true, Dim:true }
            };
        }

        function renderOnboarding() {
            if (!state.showOnboarding) return '';
            if (!state._ob) initOnboarding();
            const ob = state._ob;
            const step = ob.step;

            const wrap = (content) => `<div class="modal-overlay" style="z-index:4000;">
                <div style="max-width:440px;width:92%;margin:auto;margin-top:8vh;background:white;border-radius:20px;overflow:hidden;box-shadow:0 20px 60px rgba(0,0,0,0.15);">
                    <div style="background:linear-gradient(135deg,var(--teal),var(--teal-light));padding:1rem 1.2rem;display:flex;align-items:center;justify-content:space-between;">
                        <div style="display:flex;align-items:center;gap:0.5rem;">
                            <div style="width:36px;height:36px;border-radius:50%;background:rgba(255,255,255,0.2);display:flex;align-items:center;justify-content:center;font-size:1.1rem;">🍽️</div>
                            <div><div style="color:white;font-weight:700;font-size:0.95rem;">Repasio</div><div style="color:rgba(255,255,255,0.7);font-size:0.65rem;">Configuration rapide</div></div>
                        </div>
                        <button onclick="completeOnboarding();" style="background:rgba(255,255,255,0.15);border:none;color:white;font-size:0.65rem;padding:0.3rem 0.6rem;border-radius:12px;cursor:pointer;">Passer ›</button>
                    </div>
                    <div style="padding:1.2rem;">${content}</div>
                </div>
            </div>`;

            const bubble = (text) => `<div style="background:#F0F7F6;border-radius:0 16px 16px 16px;padding:0.8rem 1rem;margin-bottom:0.8rem;font-size:0.85rem;line-height:1.5;color:#333;">${text}</div>`;
            const progress = `<div style="display:flex;gap:3px;margin-bottom:1rem;">${[0,1,2,3,4,5,6,7].map(i => `<div style="flex:1;height:3px;border-radius:2px;background:${i<=step?'var(--teal)':'#E8ECEA'};transition:all 0.3s;"></div>`).join('')}</div>`;

            // STEP 0 — Bienvenue
            if (step === 0) {
                const name = state.user?.user_metadata?.name || '';
                return wrap(`${progress}
                    <div style="text-align:center;margin-bottom:1rem;">
                        <div style="font-size:2.5rem;margin-bottom:0.3rem;">👋</div>
                    </div>
                    ${bubble(`Salut${name ? ' <strong>'+esc(name)+'</strong>' : ''} ! Je vais t'aider à configurer Repasio en quelques questions. Ça prend 2 minutes !`)}
                    <button class="btn btn-primary" style="width:100%;justify-content:center;padding:0.7rem;border-radius:12px;font-size:0.9rem;" onclick="state._ob.step=1;render();">C'est parti ! →</button>
                `);
            }

            // STEP 1 — Qui es-tu ? (premier membre)
            if (step === 1) {
                const m = ob.currentMember;
                return wrap(`${progress}
                    ${bubble(ob.members.length === 0 ? "Commençons par <strong>toi</strong> ! Comment tu t'appelles ?<br><span style='font-size:0.72rem;color:#888;'>Modifiable ensuite dans l'onglet 👥 Famille</span>" : "Super ! Un autre membre de la famille ?")}
                    <div style="display:flex;flex-direction:column;gap:0.6rem;">
                        <input type="text" class="input" placeholder="Prénom" value="${esc(m.name)}" oninput="state._ob.currentMember.name=this.value" style="border-radius:10px;">
                        <div style="display:flex;gap:0.4rem;">
                            <input type="number" class="input" placeholder="Âge" value="${m.age}" oninput="state._ob.currentMember.age=this.value" style="border-radius:10px;flex:1;">
                            <input type="number" class="input" placeholder="Poids (kg)" value="${m.weight}" oninput="state._ob.currentMember.weight=this.value" style="border-radius:10px;flex:1;">
                            <input type="number" class="input" placeholder="Taille (cm)" value="${m.height}" oninput="state._ob.currentMember.height=this.value" style="border-radius:10px;flex:1;">
                        </div>
                        <div style="display:flex;gap:0.3rem;">
                            ${['Homme','Femme','Enfant'].map(g => `<button onclick="state._ob.currentMember.gender='${g}';render();" style="flex:1;padding:0.5rem;border-radius:10px;border:2px solid ${m.gender===g?'var(--teal)':'#E8ECEA'};background:${m.gender===g?'#E6F2F0':'white'};cursor:pointer;font-size:0.8rem;font-weight:${m.gender===g?'700':'400'};color:${m.gender===g?'var(--teal)':'#666'};font-family:inherit;">${g==='Homme'?'👨':g==='Femme'?'👩':'👶'} ${g}</button>`).join('')}
                        </div>
                        <div style="font-size:0.72rem;color:#888;margin:-0.2rem 0;">Niveau d'activité :</div>
                        <div style="display:flex;gap:0.3rem;">
                            ${['Sédentaire','Légère','Modérée','Active','Sportive'].map(a => `<button onclick="state._ob.currentMember.activity='${a}';render();" style="flex:1;padding:0.35rem 0.15rem;border-radius:8px;border:1.5px solid ${m.activity===a?'var(--teal)':'#E8ECEA'};background:${m.activity===a?'#E6F2F0':'white'};cursor:pointer;font-size:0.58rem;font-weight:${m.activity===a?'600':'400'};color:${m.activity===a?'var(--teal)':'#888'};font-family:inherit;">${a}</button>`).join('')}
                        </div>
                        <div style="font-size:0.72rem;color:#888;margin:-0.2rem 0;">Objectif :</div>
                        <div style="display:flex;gap:0.3rem;">
                            ${[{k:'Perte',icon:'📉',l:'Perte de poids'},{k:'Maintien',icon:'⚖️',l:'Maintien'},{k:'Prise',icon:'💪',l:'Prise de masse'}].map(g => `<button onclick="state._ob.currentMember.goal='${g.k}';render();" style="flex:1;padding:0.45rem 0.2rem;border-radius:8px;border:1.5px solid ${m.goal===g.k?'var(--teal)':'#E8ECEA'};background:${m.goal===g.k?'#E6F2F0':'white'};cursor:pointer;font-size:0.65rem;font-weight:${m.goal===g.k?'600':'400'};color:${m.goal===g.k?'var(--teal)':'#888'};font-family:inherit;text-align:center;">${g.icon}<br>${g.l}</button>`).join('')}
                        </div>
                        <button class="btn btn-primary" style="width:100%;justify-content:center;padding:0.65rem;border-radius:12px;" onclick="obAddMember();">
                            ${ob.members.length === 0 ? 'Valider et continuer →' : 'Ajouter ce membre →'}
                        </button>
                        ${ob.members.length > 0 ? `
                            <div style="display:flex;flex-direction:column;gap:0.3rem;margin-top:0.2rem;">
                                ${ob.members.map((m,i) => `<div style="display:flex;align-items:center;gap:0.4rem;background:#E6F2F0;padding:0.3rem 0.6rem;border-radius:8px;">
                                    <span style="flex:1;font-size:0.78rem;color:var(--teal);font-weight:600;">✓ ${esc(m.name)} <span style="font-weight:400;font-size:0.68rem;color:#666;">${m.age}ans • ${m.gender} • ${m.goal}</span></span>
                                    <button onclick="state._ob.currentMember={...state._ob.members[${i}]};state._ob.members.splice(${i},1);render();" style="background:none;border:none;cursor:pointer;font-size:0.7rem;color:var(--teal);">✏️</button>
                                    <button onclick="state._ob.members.splice(${i},1);render();" style="background:none;border:none;cursor:pointer;font-size:0.7rem;color:#E74C3C;">✕</button>
                                </div>`).join('')}
                            </div>
                            <button class="btn btn-secondary" style="width:100%;justify-content:center;border-radius:12px;font-size:0.82rem;" onclick="state._ob.step=2;render();">C'est tout le monde ! Continuer →</button>
                        ` : ''}
                    </div>
                `);
            }

            // STEP 2 — Restrictions alimentaires
            if (step === 2) {
                const diets = state.dietaryOptions.length > 0
                    ? state.dietaryOptions.filter(d => d.category === 'restriction' || d.category === 'regime')
                    : [{code:'sans_porc',label:'Sans porc',icon:'🐷'},{code:'vegetarien',label:'Végétarien',icon:'🥬'},{code:'vegan',label:'Végan',icon:'🌱'},{code:'sans_gluten',label:'Sans gluten',icon:'🌾'},{code:'sans_lactose',label:'Sans lactose',icon:'🥛'},{code:'halal',label:'Halal',icon:'☪️'}];
                return wrap(`${progress}
                    ${bubble("Des <strong>restrictions alimentaires</strong> à prendre en compte ?<br><span style='font-size:0.72rem;color:#888;'>Modifiable ensuite dans l'onglet ⚙️ Préférences</span>")}
                    <div style="display:flex;flex-wrap:wrap;gap:0.4rem;margin-bottom:1rem;">
                        ${diets.map(d => {
                            const code = d.code || d.label || '';
                            const label = d.label || d.name || '';
                            const icon = d.icon || '';
                            const active = ob.dietary.includes(code);
                            return `<button onclick="const c='${code}';const i=state._ob.dietary.indexOf(c);if(i>=0)state._ob.dietary.splice(i,1);else state._ob.dietary.push(c);render();" style="padding:0.5rem 0.8rem;border-radius:10px;border:2px solid ${active?'var(--teal)':'#E8ECEA'};background:${active?'#E6F2F0':'white'};cursor:pointer;font-size:0.8rem;font-weight:${active?'600':'400'};color:${active?'var(--teal)':'#555'};font-family:inherit;">${icon} ${label}</button>`;
                        }).join('')}
                    </div>
                    <div style="display:flex;gap:0.4rem;">
                        <button class="btn btn-secondary" style="flex:1;justify-content:center;border-radius:12px;" onclick="state._ob.step=3;render();">Aucune</button>
                        <button class="btn btn-primary" style="flex:1;justify-content:center;border-radius:12px;" onclick="state._ob.step=3;render();">Continuer →</button>
                    </div>
                `);
            }

            // STEP 3 — Allergies
            if (step === 3) {
                const allergies = state.dietaryOptions.length > 0
                    ? state.dietaryOptions.filter(d => d.category === 'allergie')
                    : [{code:'fruits_coque',label:'Fruits à coque',icon:'🥜'},{code:'arachides',label:'Arachides',icon:'🥜'},{code:'soja',label:'Soja',icon:'🫘'},{code:'poisson',label:'Poisson',icon:'🐟'},{code:'crustaces',label:'Crustacés',icon:'🦐'},{code:'oeufs',label:'Oeufs',icon:'🥚'}];
                return wrap(`${progress}
                    ${bubble("Des <strong>allergies</strong> dans la famille ?<br><span style='font-size:0.72rem;color:#888;'>Modifiable ensuite dans l'onglet ⚙️ Préférences</span>")}
                    <div style="display:flex;flex-wrap:wrap;gap:0.4rem;margin-bottom:1rem;">
                        ${allergies.map(d => {
                            const code = d.code || d.label || '';
                            const label = d.label || d.name || '';
                            const icon = d.icon || '';
                            const active = ob.allergies.includes(code);
                            return `<button onclick="const c='${code}';const i=state._ob.allergies.indexOf(c);if(i>=0)state._ob.allergies.splice(i,1);else state._ob.allergies.push(c);render();" style="padding:0.5rem 0.8rem;border-radius:10px;border:2px solid ${active?'#E74C3C':'#E8ECEA'};background:${active?'#FDEDEC':'white'};cursor:pointer;font-size:0.8rem;font-weight:${active?'600':'400'};color:${active?'#C0392B':'#555'};font-family:inherit;">${icon} ${label}</button>`;
                        }).join('')}
                    </div>
                    <div style="display:flex;gap:0.4rem;">
                        <button class="btn btn-secondary" style="flex:1;justify-content:center;border-radius:12px;" onclick="state._ob.step=4;render();">Aucune</button>
                        <button class="btn btn-primary" style="flex:1;justify-content:center;border-radius:12px;" onclick="state._ob.step=4;render();">Continuer →</button>
                    </div>
                `);
            }

            // STEP 4 — Appareils de cuisine
            if (step === 4) {
                const appliances = state.applianceOptions.length > 0
                    ? state.applianceOptions.map(a => ({ code: a.code||a.label||'', label: a.label||a.name||'', icon: a.icon||'🍳' }))
                    : [{code:'four',label:'Four',icon:'🔥'},{code:'plaques',label:'Plaques',icon:'🍳'},{code:'micro_ondes',label:'Micro-ondes',icon:'📡'},{code:'robot_cuiseur',label:'Robot cuiseur',icon:'🤖'},{code:'airfryer',label:'Airfryer',icon:'🌀'},{code:'cocotte_minute',label:'Cocotte-minute',icon:'♨️'},{code:'plancha',label:'Plancha',icon:'🥩'},{code:'pas_cuisson',label:'Pas de cuisson',icon:'🥗'}];
                return wrap(`${progress}
                    ${bubble("De quels <strong>appareils de cuisine</strong> disposez-vous ?<br><span style='font-size:0.72rem;color:#888;'>Modifiable ensuite dans l'onglet ⚙️ Préférences</span>")}
                    <div style="display:flex;flex-wrap:wrap;gap:0.4rem;margin-bottom:1rem;">
                        ${appliances.map(a => {
                            const active = ob.appliances.includes(a.code);
                            return `<button onclick="const c='${a.code}';const i=state._ob.appliances.indexOf(c);if(i>=0)state._ob.appliances.splice(i,1);else state._ob.appliances.push(c);render();" style="padding:0.5rem 0.8rem;border-radius:10px;border:2px solid ${active?'var(--gold)':'#E8ECEA'};background:${active?'#FFF6E6':'white'};cursor:pointer;font-size:0.8rem;font-weight:${active?'600':'400'};color:${active?'var(--gold-dark)':'#555'};font-family:inherit;">${a.icon} ${a.label}</button>`;
                        }).join('')}
                    </div>
                    <button class="btn btn-primary" style="width:100%;justify-content:center;border-radius:12px;" onclick="state._ob.step=5;render();">Continuer →</button>
                `);
            }

            // STEP 5 — Stock de base (placards)
            if (step === 5) {
                const basics = [
                    {cat:'Féculents', items:['Pâtes','Riz','Semoule','Pommes de terre','Pain','Farine']},
                    {cat:'Huiles & condiments', items:['Huile d\'olive','Beurre','Sel','Poivre','Moutarde','Vinaigre']},
                    {cat:'Conserves & secs', items:['Lentilles','Pois chiches','Tomates pelées','Thon','Maïs','Haricots rouges']},
                    {cat:'Frais basiques', items:['Oeufs','Lait','Crème fraîche','Oignons','Ail','Citron']}
                ];
                return wrap(`${progress}
                    ${bubble("Qu'avez-vous dans vos <strong>placards</strong> ? Cochez les basiques que vous avez en stock.<br><span style='font-size:0.72rem;color:#888;'>Gérez vos stocks ensuite dans l'onglet 📦 Placards</span>")}
                    <div style="max-height:45vh;overflow-y:auto;margin-bottom:0.8rem;">
                        ${basics.map(cat => `
                            <div style="margin-bottom:0.6rem;">
                                <div style="font-size:0.72rem;font-weight:600;color:#888;margin-bottom:0.3rem;">${cat.cat}</div>
                                <div style="display:flex;flex-wrap:wrap;gap:0.3rem;">
                                    ${cat.items.map(item => {
                                        const active = ob.stock.includes(item);
                                        return `<button onclick="const i=state._ob.stock.indexOf('${item.replace(/'/g,"\\'")}');if(i>=0)state._ob.stock.splice(i,1);else state._ob.stock.push('${item.replace(/'/g,"\\'")}');render();" style="padding:0.4rem 0.7rem;border-radius:8px;border:1.5px solid ${active?'var(--teal)':'#E8ECEA'};background:${active?'#E6F2F0':'white'};cursor:pointer;font-size:0.75rem;font-weight:${active?'600':'400'};color:${active?'var(--teal)':'#555'};font-family:inherit;">${active?'✓ ':''}${item}</button>`;
                                    }).join('')}
                                </div>
                            </div>
                        `).join('')}
                    </div>
                    <div style="display:flex;gap:0.4rem;">
                        <button class="btn btn-secondary" style="flex:1;justify-content:center;border-radius:12px;font-size:0.82rem;" onclick="state._ob.step=6;render();">Passer</button>
                        <button class="btn btn-primary" style="flex:1;justify-content:center;border-radius:12px;" onclick="state._ob.step=6;render();">${ob.stock.length > 0 ? ob.stock.length + ' articles • ' : ''}Continuer →</button>
                    </div>
                `);
            }

            // STEP 6 — Quels repas ?
            if (step === 6) {
                const mealOpts = [
                    { key: 'Petit-déjeuner', icon: '☀️', label: 'Petit-déjeuner' },
                    { key: 'Déjeuner', icon: '🍽️', label: 'Déjeuner' },
                    { key: 'Goûter', icon: '🍪', label: 'Goûter' },
                    { key: 'Dîner', icon: '🌙', label: 'Dîner' }
                ];
                return wrap(`${progress}
                    ${bubble("Quels <strong>repas</strong> voulez-vous planifier ?<br><span style='font-size:0.72rem;color:#888;'>Modifiable ensuite dans l'onglet ⚙️ Préférences</span>")}
                    <div style="display:flex;flex-direction:column;gap:0.4rem;margin-bottom:1rem;">
                        ${mealOpts.map(m => {
                            const active = ob.meals[m.key];
                            return `<button onclick="state._ob.meals['${m.key}']=!state._ob.meals['${m.key}'];render();" style="display:flex;align-items:center;gap:0.6rem;padding:0.7rem 1rem;border-radius:12px;border:2px solid ${active?'var(--teal)':'#E8ECEA'};background:${active?'#E6F2F0':'white'};cursor:pointer;font-size:0.88rem;font-weight:${active?'600':'400'};color:${active?'var(--teal)':'#555'};font-family:inherit;width:100%;text-align:left;">
                                <span style="font-size:1.3rem;">${m.icon}</span>
                                <span>${m.label}</span>
                                <span style="margin-left:auto;font-size:1.1rem;">${active?'✓':''}</span>
                            </button>`;
                        }).join('')}
                    </div>
                    <button class="btn btn-primary" style="width:100%;justify-content:center;padding:0.7rem;border-radius:12px;font-size:0.9rem;" onclick="state._ob.step=7;render();">Continuer →</button>
                `);
            }

            // STEP 7 — Quels jours ?
            if (step === 7) {
                const dayOpts = ['Lun','Mar','Mer','Jeu','Ven','Sam','Dim'];
                const dayLabels = {Lun:'Lundi',Mar:'Mardi',Mer:'Mercredi',Jeu:'Jeudi',Ven:'Vendredi',Sam:'Samedi',Dim:'Dimanche'};
                return wrap(`${progress}
                    ${bubble("Et quels <strong>jours</strong> de la semaine ?<br><span style='font-size:0.72rem;color:#888;'>Modifiable ensuite dans l'onglet ⚙️ Préférences</span>")}
                    <div style="display:flex;flex-wrap:wrap;gap:0.4rem;margin-bottom:1rem;">
                        ${dayOpts.map(d => {
                            const active = ob.days[d];
                            return `<button onclick="state._ob.days['${d}']=!state._ob.days['${d}'];render();" style="flex:1;min-width:70px;padding:0.6rem 0.3rem;border-radius:10px;border:2px solid ${active?'var(--teal)':'#E8ECEA'};background:${active?'#E6F2F0':'white'};cursor:pointer;font-size:0.78rem;font-weight:${active?'700':'400'};color:${active?'var(--teal)':'#666'};font-family:inherit;text-align:center;">${dayLabels[d]}</button>`;
                        }).join('')}
                    </div>
                    <button class="btn btn-primary" style="width:100%;justify-content:center;padding:0.7rem;border-radius:12px;font-size:0.9rem;" onclick="obFinalize();">Terminer la configuration ✨</button>
                `);
            }

            return '';
        }

        function obAddMember() {
            const m = state._ob.currentMember;
            if (!m.name.trim()) { showToast('Entre un prénom'); return; }
            if (!m.age) { showToast('Entre l\'âge'); return; }
            if (!m.gender) { showToast('Sélectionne le genre'); return; }
            state._ob.members.push({ ...m });
            state._ob.currentMember = { name: '', age: '', gender: '', weight: '', height: '', activity: 'Modérée', goal: 'Maintien' };
            render();
        }

        async function obFinalize() {
            const ob = state._ob;
            showToast('Configuration en cours...', 3000);

            try {
                // 1. Save family members
                for (const m of ob.members) {
                    const { error } = await db.from('family_members').insert([{
                        user_id: state.user.id, name: m.name, age: parseInt(m.age),
                        gender: m.gender, weight: parseFloat(m.weight) || null,
                        height: parseFloat(m.height) || null, activity: m.activity, goal: m.goal
                    }]).select();
                    if (error) console.error('member insert error:', error);
                }
                await loadFamilyMembers();

                // 2. Build mealSchedule
                const schedule = {};
                const activeMeals = Object.entries(ob.meals).filter(([,v]) => v).map(([k]) => k);
                const activeDays = Object.entries(ob.days).filter(([,v]) => v).map(([k]) => k);
                state.familyMembers.forEach(fm => {
                    schedule[fm.id] = {};
                    activeDays.forEach(d => { schedule[fm.id][d] = [...activeMeals]; });
                    ['Lun','Mar','Mer','Jeu','Ven','Sam','Dim'].filter(d => !activeDays.includes(d)).forEach(d => { schedule[fm.id][d] = []; });
                });
                state.mealSchedule = schedule;

                // 3. Save profile (correct column names)
                console.log('[ob] saving profile:', { dietary: ob.dietary, allergies: ob.allergies, appliances: ob.appliances });
                const profileData = {
                    dietary_restrictions: ob.dietary,
                    allergies: ob.allergies,
                    kitchen_appliances: ob.appliances,
                    meal_schedule: schedule
                };
                // Try update first, then insert if no row
                const { error: updErr } = await db.from('profiles').update(profileData).eq('id', state.user.id);
                if (updErr) {
                    console.warn('[ob] update failed, trying upsert:', updErr.message);
                    const { error: upsErr } = await db.from('profiles').upsert({ id: state.user.id, ...profileData }, { onConflict: 'id' });
                    if (upsErr) console.error('[ob] upsert also failed:', upsErr.message);
                }
                console.log('[ob] profile saved ok');

                // 4. Save stock items with smart default quantities
                const defaultQty = {
                    'Pâtes': {q:500,u:'g'}, 'Riz': {q:500,u:'g'}, 'Semoule': {q:500,u:'g'},
                    'Pommes de terre': {q:1,u:'kg'}, 'Pain': {q:1,u:'piece'}, 'Farine': {q:1,u:'kg'},
                    'Huile d\'olive': {q:750,u:'ml'}, 'Beurre': {q:250,u:'g'}, 'Sel': {q:500,u:'g'},
                    'Poivre': {q:50,u:'g'}, 'Moutarde': {q:200,u:'g'}, 'Vinaigre': {q:500,u:'ml'},
                    'Lentilles': {q:500,u:'g'}, 'Pois chiches': {q:400,u:'g'}, 'Tomates pelées': {q:400,u:'g'},
                    'Thon': {q:200,u:'g'}, 'Maïs': {q:300,u:'g'}, 'Haricots rouges': {q:400,u:'g'},
                    'Oeufs': {q:6,u:'piece'}, 'Lait': {q:1,u:'l'}, 'Crème fraîche': {q:200,u:'ml'},
                    'Oignons': {q:500,u:'g'}, 'Ail': {q:100,u:'g'}, 'Citron': {q:3,u:'piece'}
                };
                if (ob.stock.length > 0) {
                    for (const itemName of ob.stock) {
                        const ing = state.ingredients.find(i => i.name.toLowerCase() === itemName.toLowerCase());
                        if (ing) {
                            const dq = defaultQty[itemName] || {q:500,u:'g'};
                            const { error: stockErr } = await db.from('stock_items').insert([{
                                user_id: state.user.id,
                                ingredient_id: ing.id,
                                quantity: dq.q,
                                unit: dq.u
                            }]);
                            if (stockErr) console.warn('stock insert:', itemName, stockErr.message);
                        }
                    }
                    await loadStockItems();
                }

                await loadProfile();
                showToast('✅ Configuration terminée ! Vous pouvez générer votre premier menu.', 5000);
                state.activeTab = 'planning';
                completeOnboarding();
            } catch(e) {
                console.error('onboarding finalize error:', e);
                showToast('Erreur: ' + e.message);
            }
        }

        function renderFamille() {
            const m = state.editingMember || state.newMember;
            const isEdit = !!state.editingMember;
            const target = isEdit ? 'state.editingMember' : 'state.newMember';
            return `<div class="card fade-in">
                <div class="card-header"><div><h2 style="font-size: 1.1rem; font-weight: 700; margin: 0;">👥 Ma Famille</h2><p style="font-size: 0.72rem; color: #6B7280; margin: 0.15rem 0 0;">${state.familyMembers.length} membres</p></div></div>
                <div class="card-body">
                    <div class="form-section">
                        <h3 style="font-weight: 600; margin: 0 0 0.9rem; font-size: 0.92rem;">${isEdit ? '✏️ Modifier' : '➕ Nouveau membre'}</h3>
                        <div class="form-grid">
                            <div><label class="label">Prénom</label><input class="input" value="${m.name}" oninput="${target}.name=this.value"></div>
                            <div><label class="label">Âge</label><input type="number" class="input" value="${m.age}" oninput="${target}.age=this.value"></div>
                            <div><label class="label">Genre</label><select class="select" onchange="${target}.gender=this.value"><option value="">—</option><option ${m.gender==='Homme'?'selected':''}>Homme</option><option ${m.gender==='Femme'?'selected':''}>Femme</option></select></div>
                            <div><label class="label">Poids (kg)</label><input type="number" class="input" value="${m.weight}" oninput="${target}.weight=this.value"></div>
                            <div><label class="label">Taille (cm)</label><input type="number" class="input" value="${m.height}" oninput="${target}.height=this.value"></div>
                            <div><label class="label">Activité</label><select class="select" onchange="${target}.activity=this.value">${['Sédentaire','Légère','Modérée','Active','Très active'].map(a => `<option ${m.activity===a?'selected':''}>${a}</option>`).join('')}</select></div>
                        </div>
                        <div style="display: flex; gap: 0.5rem; margin-top: 0.9rem;">
                            <button class="btn btn-primary" onclick="saveFamilyMember()">${isEdit ? 'Enregistrer' : 'Ajouter'}</button>
                            ${isEdit ? `<button class="btn btn-secondary" onclick="cancelEditMember()">Annuler</button>` : ''}
                        </div>
                    </div>
                    ${state.familyMembers.map(mem => `<div class="list-item">
                        <div style="display: flex; align-items: center; gap: 0.7rem;">
                            <div style="width: 34px; height: 34px; border-radius: 50%; background: var(--teal); display: flex; align-items: center; justify-content: center; color: white; font-weight: 600; font-size: 0.85rem;">${mem.name.charAt(0).toUpperCase()}</div>
                            <div><div style="font-weight: 600; font-size: 0.85rem;">${mem.name}</div>
                            <div style="font-size: 0.66rem; color: #6B7280;">${mem.age ? mem.age+' ans' : ''} ${mem.gender ? '• '+mem.gender : ''} ${mem.weight ? '• '+mem.weight+'kg' : ''} ${calculateKcal(mem) ? '• <span style="color: var(--teal); font-weight: 600;">' + calculateKcal(mem) + ' kcal/j</span> • ' + estimatePortions(mem) + ' portion' : ''}</div></div>
                        </div>
                        <div style="display: flex; gap: 0.3rem;">
                            <button class="btn btn-edit btn-sm" onclick='editFamilyMember(${JSON.stringify(mem).replace(/'/g, "\\'")})'>✏️</button>
                            <button class="btn btn-delete btn-sm" onclick="deleteFamilyMember(${mem.id})">🗑️</button>
                        </div>
                    </div>`).join('')}
                </div>
            </div>`;
        }

        document.addEventListener('DOMContentLoaded', initApp);
        document.addEventListener('click', (e) => { if (!e.target.closest('.user-menu') && state.showUserMenu) { state.showUserMenu = false; render(); } });
        
    </script>
</body>
</html>